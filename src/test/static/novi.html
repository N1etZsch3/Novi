<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Novi · AI 挚友</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Markdown Style -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.css">

    <style>
        /* =========================================
           1. CSS 变量定义
           ========================================= */
        :root {
            --primary-color: #4e6ef2;
            --primary-hover: #3b5bdb;

            /* 浅色模式 */
            --bg-body: #f4f6f9;
            --bg-sidebar: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-footer: #ffffff;
            --bg-input: #ffffff;

            --text-main: #212529;
            --text-sub: #6c757d;
            --border-color: #dee2e6;

            /* 气泡颜色 */
            --bubble-user-bg: #4e6ef2;
            --bubble-user-text: #ffffff;
            --bubble-ai-bg: #ffffff;
            --bubble-ai-text: #212529;

            --sidebar-width: 280px;
        }

        /* 深色模式 */
        [data-bs-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-header: #1e1e1e;
            --bg-footer: #1e1e1e;
            --bg-input: #2c2c2c;

            --text-main: #e0e0e0;
            --text-sub: #adb5bd;
            --border-color: #444444;

            --bubble-user-bg: #3b5bdb;
            --bubble-user-text: #ffffff;
            --bubble-ai-bg: #2c2c2c;
            --bubble-ai-text: #e0e0e0;
        }

        /* =========================================
           2. 全局布局
           ========================================= */
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .view-container {
            width: 100%;
            height: 100%;
            display: none;
        }

        .view-container.active {
            display: flex !important;
            flex-direction: column;
        }

        /* =========================================
           3. 认证页面
           ========================================= */
        #auth-view {
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background-color: var(--bg-sidebar);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        /* =========================================
           4. 聊天页面布局 & 移动端交互 (核心修改)
           ========================================= */
        #chat-view {
            flex-direction: row;
            position: relative;
            overflow: hidden;
        }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .sidebar-header, .sidebar-footer {
            padding: 1rem;
            background-color: var(--bg-sidebar);
        }
        .sidebar-footer {
            border-top: 1px solid var(--border-color);
        }

        /* 主聊天区域 */
        .chat-main {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-body);
            min-width: 0;
            position: relative; /* 为移动逻辑做准备 */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 50;
        }

        /* --- 移动端响应式逻辑 (Fix Mobile Sidebar) --- */
        @media (max-width: 768px) {
            /* 侧边栏：绝对定位，默认移出屏幕左侧 */
            .sidebar {
                position: absolute;
                left: 0; top: 0; bottom: 0;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                border-right: none;
            }

            /* 主区域：宽度占满 */
            .chat-main {
                width: 100%;
            }

            /* 当父容器有 sidebar-open 类时 */
            .sidebar-open .sidebar {
                transform: translateX(0); /* 侧边栏滑入 */
            }

            .sidebar-open .chat-main {
                transform: translateX(var(--sidebar-width)); /* 主内容右移出屏幕 */
                overflow: hidden; /* 禁止交互 */
            }

            /* 遮罩层：在主内容上覆盖一层半透明黑 */
            .sidebar-open .chat-main::after {
                content: '';
                position: absolute;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.4); /* 灰色滤镜效果 */
                z-index: 1000;
                pointer-events: auto; /* 允许点击关闭 */
            }
        }

        /* =========================================
           5. 聊天组件样式
           ========================================= */
        .chat-header {
            height: 60px;
            padding: 0 1rem;
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            color: var(--text-main);
        }

        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        /* 消息行：解决头像反了的问题 */
        .message-row {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: flex-start;
            width: 100%;
        }

        /* 用户消息：使用 justify-end 而不是 row-reverse */
        .message-row.user {
            /* flex-direction: row-reverse;  <-- 删除这行 */
            justify-content: flex-end; /* <-- 改用这行，靠右对齐 */
        }
        /* JS DOM顺序: Bubble + Avatar */
        /* 视觉效果: [Bubble] [Avatar] | (右边缘) */

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
            margin: 0 8px; /* 稍微减小间距 */
        }

        .avatar-ai { background-color: #fff; color: var(--primary-color); border: 1px solid var(--border-color); }
        .avatar-user { background-color: var(--primary-color); color: white; }

        /* 气泡样式 */
        .message-bubble {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }

        .message-bubble.assistant {
            background-color: var(--bubble-ai-bg);
            color: var(--bubble-ai-text);
            border: 1px solid var(--border-color);
            border-top-left-radius: 2px;
        }

        /* 用户气泡 - 强制白色文字 (Fix Color Contrast) */
        .message-bubble.user {
            background-color: var(--bubble-user-bg);
            color: #ffffff !important; /* 强制白色 */
            border-top-right-radius: 2px;
        }
        /* 强制继承颜色，解决 Markdown 默认样式覆盖问题 */
        .message-bubble.user * {
            color: inherit !important;
        }

        /* Markdown 样式 */
        .markdown-body {
            background: transparent !important;
            color: inherit !important;
            font-family: inherit !important;
        }
        [data-bs-theme="dark"] .markdown-body pre {
            background-color: #1a1a1a;
            border: 1px solid #444;
        }

        /* 底部输入框 */
        .chat-input-area {
            padding: 1rem;
            background-color: var(--bg-footer);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            align-items: flex-end;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(78, 110, 242, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-main);
            resize: none;
            max-height: 120px;
            padding: 8px 0;
            outline: none;
        }
        .chat-input::placeholder { color: var(--text-sub); }

        /* 会话列表 */
        .session-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .session-item:hover { background-color: rgba(0,0,0,0.05); }
        [data-bs-theme="dark"] .session-item:hover { background-color: rgba(255,255,255,0.05); }

        .session-item.active {
            background-color: var(--primary-color);
            color: white !important;
        }
        .session-item.active .text-muted { color: rgba(255,255,255,0.8) !important; }

        /* 光标 */
        .typing-cursor::after {
            content: '▋';
            display: inline-block;
            vertical-align: baseline;
            animation: blink 1s step-end infinite;
            color: var(--primary-color);
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

<!-- 1. 认证视图 -->
<div id="auth-view" class="view-container active">
    <div class="auth-card">
        <div class="text-center mb-4">
            <h3 class="fw-bold" style="color: var(--primary-color);"><i class="bi bi-robot me-2"></i>Novi</h3>
            <p class="text-muted">你的 AI 挚友</p>
        </div>

        <ul class="nav nav-pills nav-fill mb-4 bg-light rounded p-1" id="authTabs">
            <li class="nav-item">
                <button class="nav-link active" onclick="switchAuthTab('login')">登录</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchAuthTab('register')">注册</button>
            </li>
        </ul>

        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label text-muted small">用户名</label>
                <input type="text" class="form-control" id="loginUser" required>
            </div>
            <div class="mb-4">
                <label class="form-label text-muted small">密码</label>
                <input type="password" class="form-control" id="loginPass" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-2">登录</button>
        </form>

        <form id="registerForm" class="d-none">
            <div class="mb-2">
                <input type="text" class="form-control" id="regUser" placeholder="用户名 (4-20位)" required>
            </div>
            <div class="mb-2">
                <input type="text" class="form-control" id="regNick" placeholder="昵称" required>
            </div>
            <div class="mb-2">
                <input type="email" class="form-control" id="regEmail" placeholder="邮箱" required>
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" id="regPass" placeholder="密码 (8位+大小写数字特殊符)" required>
            </div>
            <button type="submit" class="btn btn-outline-primary w-100 py-2">注册账号</button>
        </form>
    </div>
</div>

<!-- 2. 聊天视图 -->
<div id="chat-view" class="view-container">
    <!-- 侧边栏 -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold" style="color: var(--text-main);">Novi 挚友</h5>
                <!-- 移动端关闭按钮 (虽然有遮罩，但也保留个X) -->
                <button class="btn btn-sm text-muted d-md-none" onclick="toggleSidebar()">
                    <i class="bi bi-x-lg fs-5"></i>
                </button>
            </div>
            <button class="btn btn-primary w-100 mt-3 rounded-pill" onclick="app.startNewChat()">
                <i class="bi bi-plus-lg me-2"></i>新对话
            </button>
        </div>

        <div class="flex-grow-1 overflow-auto px-2" id="sessionList">
            <!-- JS 填充 -->
        </div>

        <div class="sidebar-footer">
            <div class="dropdown dropup w-100">
                <button class="btn w-100 d-flex align-items-center p-2 rounded hover-bg text-start" data-bs-toggle="dropdown" style="color: var(--text-main);">
                    <div class="avatar avatar-user me-2" style="width: 32px; height: 32px; font-size: 1rem;">U</div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-bold text-truncate" id="userNick">User</div>
                    </div>
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu shadow">
                    <li><a class="dropdown-item text-danger" href="#" onclick="app.logout()">退出登录</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <!-- 主聊天区域 -->
    <!-- 添加 onclick 以处理点击遮罩关闭侧边栏 (仅在 sidebar-open 时有效) -->
    <main class="chat-main" onclick="handleMainClick(event)">
        <header class="chat-header">
            <div class="d-flex align-items-center">
                <!-- 移动端菜单 -->
                <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);" onclick="toggleSidebar(event)">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <div>
                    <h6 class="mb-0 fw-bold" id="currentTitle">新会话</h6>
                    <small style="color: var(--text-sub); font-size: 0.75rem;">
                        <i class="bi bi-circle-fill text-success me-1" style="font-size: 6px;"></i>在线
                    </small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="themeSwitch">
                    <label class="form-check-label small" for="themeSwitch" style="color: var(--text-main);">
                        <i class="bi bi-moon-stars"></i>
                    </label>
                </div>
                <div class="btn-group btn-group-sm">
                    <input type="radio" class="btn-check" name="apiMode" id="modeStream" value="stream" checked>
                    <label class="btn btn-outline-secondary" for="modeStream">流式</label>
                    <input type="radio" class="btn-check" name="apiMode" id="modeCall" value="call">
                    <label class="btn btn-outline-secondary" for="modeCall">普通</label>
                </div>
            </div>
        </header>

        <div class="chat-window" id="chatWindow">
            <div class="text-center mt-5 pt-5 fade-in">
                <div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem;">
                    <i class="bi bi-robot"></i>
                </div>
                <h4 class="fw-bold" style="color: var(--text-main);">你好，我是 Novi</h4>
                <p style="color: var(--text-sub);">我可以陪你聊天，并记住你的喜好。</p>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea class="chat-input" id="messageInput" rows="1" placeholder="给 Novi 发送消息... (Enter 发送)"></textarea>
                <button class="btn btn-link text-primary p-0 ms-2 mb-1" id="sendBtn" onclick="app.sendMessage()">
                    <i class="bi bi-send-fill fs-5"></i>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- 依赖库 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- 核心逻辑 -->
<script>
    // UI 辅助函数
    function switchAuthTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const regForm = document.getElementById('registerForm');
        const btns = document.querySelectorAll('#authTabs .nav-link');

        if(tab === 'login') {
            loginForm.classList.remove('d-none');
            regForm.classList.add('d-none');
            btns[0].classList.add('active');
            btns[1].classList.remove('active');
        } else {
            loginForm.classList.add('d-none');
            regForm.classList.remove('d-none');
            btns[0].classList.remove('active');
            btns[1].classList.add('active');
        }
    }

    function toggleSidebar(e) {
        if(e) e.stopPropagation();
        // 切换整个容器的类，而不是 sidebar 的类
        const chatView = document.getElementById('chat-view');
        chatView.classList.toggle('sidebar-open');
    }

    // 点击主区域时，如果是打开状态，则关闭
    function handleMainClick(e) {
        const chatView = document.getElementById('chat-view');
        if (chatView.classList.contains('sidebar-open')) {
            chatView.classList.remove('sidebar-open');
        }
    }

    // ================= Application Logic =================
    const App = {
        config: {
            apiBase: 'http://localhost:8080/api/v1',
            typingSpeed: 20
        },
        state: {
            token: localStorage.getItem('novi_token'),
            user: JSON.parse(localStorage.getItem('novi_user') || '{}'),
            sessionId: null,
            isTyping: false,
            renderQueue: []
        },

        init() {
            this.setupAxios();
            this.bindEvents();
            this.renderLoop();

            const isDark = localStorage.getItem('novi_theme') === 'dark';
            document.getElementById('themeSwitch').checked = isDark;
            if(isDark) document.documentElement.setAttribute('data-bs-theme', 'dark');

            if (this.state.token) {
                this.showChatView();
            }
        },

        showChatView() {
            document.getElementById('auth-view').classList.remove('active');
            document.getElementById('chat-view').classList.add('active');
            document.getElementById('userNick').textContent = this.state.user.nickname || this.state.user.username;
            this.loadSessions();
        },

        renderLoop() {
            const process = () => {
                if (this.state.renderQueue.length > 0) {
                    const { char, bubbleId, fullTextRef } = this.state.renderQueue.shift();
                    const bubble = document.getElementById(bubbleId);
                    if (bubble) {
                        fullTextRef.value += char;
                        bubble.innerHTML = marked.parse(fullTextRef.value);
                        this.scrollToBottom();
                    }
                    const delay = this.state.renderQueue.length > 50 ? 5 : this.config.typingSpeed;
                    setTimeout(() => requestAnimationFrame(process), delay);
                } else {
                    requestAnimationFrame(process);
                }
            };
            process();
        },

        async sendMessage() {
            if (this.state.isTyping) return;
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg) return;

            this.addMessageBubble('user', msg);
            input.value = '';
            input.style.height = 'auto';

            const aiBubbleId = 'ai-' + Date.now();
            this.addMessageBubble('assistant', '', aiBubbleId);
            const bubbleEl = document.getElementById(aiBubbleId);
            bubbleEl.classList.add('typing-cursor');

            this.setLoading(true);
            const fullTextRef = { value: '' };

            try {
                const mode = document.querySelector('input[name="apiMode"]:checked').value;
                const payload = { message: msg, sessionId: this.state.sessionId };

                if (mode === 'stream') {
                    await this.handleStream(payload, aiBubbleId, fullTextRef);
                } else {
                    const res = await axios.post('/chat/send/call', payload);
                    if (res.data.code === 1) {
                        const { response, sessionId, title } = res.data.data;
                        this.updateSession(sessionId, title);
                        for (let char of response) {
                            this.state.renderQueue.push({ char, bubbleId: aiBubbleId, fullTextRef });
                        }
                    } else throw new Error(res.data.msg);
                }
            } catch (err) {
                bubbleEl.innerHTML = marked.parse(fullTextRef.value + `\n\n**[发送失败: ${err.message}]**`);
            } finally {
                this.setLoading(false);
                bubbleEl.classList.remove('typing-cursor');
                this.loadSessions();
            }
        },

        async handleStream(payload, bubbleId, fullTextRef) {
            const response = await fetch(`${this.config.apiBase}/chat/send/stream`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.state.token}`
                },
                body: JSON.stringify(payload)
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.trim()) continue;
                    const jsonStr = line.startsWith('data:') ? line.slice(5) : line;
                    try {
                        const event = JSON.parse(jsonStr);
                        if (event.eventType === 'METADATA') this.updateSession(event.sessionId, event.title);
                        else if (event.eventType === 'CONTENT') {
                            for (let char of event.content) {
                                this.state.renderQueue.push({ char, bubbleId, fullTextRef });
                            }
                        }
                    } catch (e) {}
                }
            }
        },

        addMessageBubble(role, content, id = null) {
            const win = document.getElementById('chatWindow');
            if (win.querySelector('.text-center.mt-5')) win.innerHTML = '';

            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `message-row ${isUser ? 'user' : 'assistant'}`;

            // DOM 结构保持：Bubble 在前，Avatar 在后
            // CSS 也不再反转，而是用 justify-content: flex-end
            // 最终视觉效果： [Bubble] [Avatar] --> 靠右
            const avatarHtml = `<div class="avatar ${isUser ? 'avatar-user' : 'avatar-ai'}">
                    <i class="bi bi-${isUser ? 'person' : 'robot'}"></i>
                </div>`;

            const bubbleHtml = `<div class="message-bubble ${role} markdown-body" ${id ? `id="${id}"` : ''}>
                    ${content ? marked.parse(content) : ''}
                </div>`;

            // User: Bubble + Avatar (靠右)
            // AI: Avatar + Bubble (靠左)
            div.innerHTML = isUser ? (bubbleHtml + avatarHtml) : (avatarHtml + bubbleHtml);
            win.appendChild(div);
            this.scrollToBottom();
        },

        async loadSessions() {
            try {
                const res = await axios.get('/sessions');
                const list = document.getElementById('sessionList');
                list.innerHTML = '';
                if (res.data.code === 1) {
                    res.data.data.forEach(s => {
                        const div = document.createElement('div');
                        div.className = `session-item ${s.id === this.state.sessionId ? 'active' : ''}`;
                        div.onclick = () => this.loadSession(s.id);
                        div.innerHTML = `
                                <div class="text-truncate"><i class="bi bi-chat-text me-2 text-muted"></i>${s.title || '新会话'}</div>
                                <i class="bi bi-x text-muted p-1" onclick="app.deleteSession('${s.id}', event)"></i>
                            `;
                        list.appendChild(div);
                    });
                }
            } catch (e) {}
        },

        async loadSession(sid) {
            this.state.sessionId = sid;
            this.loadSessions();
            document.getElementById('chatWindow').innerHTML = '';
            // 自动关闭侧边栏 (移动端)
            document.getElementById('chat-view').classList.remove('sidebar-open');

            const res = await axios.get(`/sessions/${sid}/messages`);
            if (res.data.code === 1) {
                res.data.data.forEach(m => this.addMessageBubble(m.role.toLowerCase(), m.content));
                const activeItem = document.querySelector('.session-item.active');
                if(activeItem) document.getElementById('currentTitle').innerText = activeItem.innerText.trim();
            }
        },

        startNewChat() {
            this.state.sessionId = null;
            document.getElementById('currentTitle').innerText = '新会话';
            document.getElementById('chatWindow').innerHTML = `
                    <div class="text-center mt-5 pt-5 fade-in">
                        <div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem;">
                            <i class="bi bi-robot"></i>
                        </div>
                        <h4 class="fw-bold" style="color: var(--text-main);">你好，我是 Novi</h4>
                        <p style="color: var(--text-sub);">新的开始，我们聊点什么？</p>
                    </div>
                `;
            document.getElementById('chat-view').classList.remove('sidebar-open');
            this.loadSessions();
        },

        async deleteSession(sid, e) {
            e.stopPropagation();
            if(!confirm('确定删除？')) return;
            await axios.delete(`/sessions/${sid}`);
            if(this.state.sessionId === sid) this.startNewChat();
            else this.loadSessions();
        },

        setupAxios() {
            axios.defaults.baseURL = this.config.apiBase;
            axios.interceptors.request.use(config => {
                if (this.state.token) config.headers.Authorization = `Bearer ${this.state.token}`;
                return config;
            });
            axios.interceptors.response.use(res => res, err => {
                if (err.response && err.response.status === 401) this.logout();
                return Promise.reject(err);
            });
        },

        bindEvents() {
            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();
                const user = document.getElementById('loginUser').value;
                const pass = document.getElementById('loginPass').value;
                try {
                    const res = await axios.post('/users/login', { username: user, password: pass });
                    if (res.data.code === 1) {
                        this.state.token = res.data.data.token;
                        localStorage.setItem('novi_token', this.state.token);

                        const me = await axios.get('/users/me', { headers: { Authorization: `Bearer ${this.state.token}` } });
                        this.state.user = me.data.data;
                        localStorage.setItem('novi_user', JSON.stringify(this.state.user));

                        this.showChatView();
                    } else alert(res.data.msg);
                } catch (e) { alert('登录失败'); }
            });

            document.getElementById('registerForm').addEventListener('submit', async e => {
                e.preventDefault();
                const data = {
                    username: document.getElementById('regUser').value,
                    nickname: document.getElementById('regNick').value,
                    email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPass').value
                };
                try {
                    const res = await axios.post('/users/register', data);
                    if(res.data.code === 1) {
                        alert('注册成功，请登录');
                        switchAuthTab('login');
                    } else alert(res.data.msg);
                } catch(err) { alert(err.response?.data?.msg || '注册失败'); }
            });

            const input = document.getElementById('messageInput');
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            document.getElementById('themeSwitch').addEventListener('change', e => {
                const theme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('novi_theme', theme);
            });
        },

        updateSession(sid, title) {
            if (this.state.sessionId !== sid) this.state.sessionId = sid;
            if (title) document.getElementById('currentTitle').innerText = title;
        },

        setLoading(loading) {
            this.state.isTyping = loading;
            const btn = document.getElementById('sendBtn');
            btn.innerHTML = loading ? '<span class="spinner-border spinner-border-sm"></span>' : '<i class="bi bi-send-fill fs-5"></i>';
        },

        scrollToBottom() {
            const win = document.getElementById('chatWindow');
            win.scrollTop = win.scrollHeight;
        },

        logout() {
            localStorage.removeItem('novi_token');
            location.reload();
        }
    };

    window.app = App;
    document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>