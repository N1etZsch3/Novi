<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Novi · AI 挚友 & 智能出题</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.css">

    <style>
        /* ================= 1. 核心变量 (保持原有) ================= */
        :root {
            --primary-color: #4e6ef2;
            --bg-body: #f2f4f7;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-input: #ffffff;
            --bg-input-focus: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #666666;
            --border-color: #e5e7eb;
            --border-input: #e5e7eb;

            --bubble-user-bg: #95ec69;
            --bubble-user-text: #000000;
            --bubble-ai-bg: #ffffff;
            --bubble-ai-text: #1f1f1f;

            --sidebar-width: 280px;
            --sidebar-width-collapsed: 76px;
            --toast-top-mobile: 80px;
        }

        [data-bs-theme="dark"] {
            --bg-body: #111111;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-header: #1e1e1e;
            --bg-input: #2c2c2c;
            --bg-input-focus: #333333;
            --text-main: #e3e3e3;
            --text-sub: #aaaaaa;
            --border-color: #333333;
            --border-input: #444444;

            --bubble-user-bg: #2b7c38;
            --bubble-user-text: #e3e3e3;
            --bubble-ai-bg: #2c2c2c;
            --bubble-ai-text: #e3e3e3;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-body);
            font-family: -apple-system, "Noto Sans SC", "Microsoft YaHei", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: background-color 0.3s;
            color: var(--text-main);
        }

        /* 组件基础样式 */
        .form-control,
        .form-select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            color: var(--text-main);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-input-focus);
            border-color: var(--primary-color);
            color: var(--text-main);
            box-shadow: 0 0 0 3px rgba(78, 110, 242, 0.25);
        }

        .view-container {
            width: 100%;
            height: 100%;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: flex !important;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================= 3. 认证视图 (保持原有) ================= */
        #auth-view {
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            background-color: var(--bg-sidebar);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .auth-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .auth-form-wrapper {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .auth-form-wrapper.fading {
            opacity: 0;
        }

        .auth-tabs-container {
            position: relative;
            background-color: var(--bg-body);
            border-radius: 50px;
            padding: 4px;
            display: flex;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .auth-tab-bg {
            position: absolute;
            top: 4px;
            left: 4px;
            bottom: 4px;
            width: calc(50% - 4px);
            background-color: var(--bg-card);
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .auth-tabs-container.register-mode .auth-tab-bg {
            transform: translateX(100%);
        }

        .auth-tab-btn {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            z-index: 2;
            transition: color 0.2s;
            background: none;
            border: none;
        }

        .auth-tab-btn.active {
            color: var(--primary-color);
        }

        .password-group .input-group-text {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            border-left: none;
            color: var(--text-sub);
            cursor: pointer;
        }

        .password-group .form-control {
            border-right: none;
        }

        /* ================= 4. 聊天视图布局 (保持原有 + 适配侧边栏新增) ================= */
        #chat-view,
        #exam-view {
            flex-direction: row;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.3s ease, transform 0.3s ease;
            flex-shrink: 0;
            height: 100%;
            /* 确保高度占满 */
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-body);
            position: relative;
            transition: transform 0.3s ease;
            z-index: 50;
            height: 100%;
            overflow: hidden;
        }

        /* ================= 侧边栏折叠核心逻辑 ================= */
        @media (min-width: 769px) {

            #chat-view.sidebar-collapsed .sidebar,
            #exam-view.sidebar-collapsed .sidebar {
                width: var(--sidebar-width-collapsed);
            }

            .sidebar-collapsed .sidebar>.border-top {
                margin-top: auto;
            }

            .sidebar-collapsed .sidebar .text-label,
            .sidebar-collapsed .sidebar #sessionList,
            .sidebar-collapsed .sidebar #examHistoryList {
                display: none !important;
            }

            .sidebar-collapsed .sidebar .btn-new-chat {
                padding-left: 0;
                padding-right: 0;
                justify-content: center;
            }

            .sidebar-collapsed .sidebar .btn-new-chat i {
                margin-right: 0 !important;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn {
                justify-content: center;
                padding: 0.5rem 0;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn .avatar {
                margin: 0 !important;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn i.bi-three-dots-vertical {
                display: none;
            }

            .sidebar-collapsed .sidebar .dropdown-menu {
                position: fixed;
                left: calc(var(--sidebar-width-collapsed) + 10px);
                bottom: 70px;
                top: auto;
                transform: none !important;
                width: 200px;
                z-index: 1050;
            }
        }

        .sidebar-toggle-btn {
            background-color: transparent !important;
            color: var(--text-sub);
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            color: var(--text-main);
        }

        [data-bs-theme="dark"] .sidebar-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                border-right: none;
                box-shadow: none;
                width: var(--sidebar-width) !important;
            }

            .sidebar-open .sidebar {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
            }

            .sidebar-open .chat-main::after {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .sidebar .text-label,
            .sidebar #sessionList,
            .sidebar #examHistoryList {
                display: block !important;
            }
        }

        /* 聊天窗口 */
        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem;
            scroll-behavior: auto;
        }

        .chat-container {
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
        }

        .message-row {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .message-row.assistant .avatar {
            margin-right: 12px;
        }

        .message-row.user .avatar {
            margin-left: 12px;
            order: 2;
        }

        .avatar-ai {
            background: #fff;
            color: var(--primary-color);
        }

        .avatar-user {
            background: var(--primary-color);
            color: #fff;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .message-bubble.assistant {
            background: var(--bubble-ai-bg);
            color: var(--bubble-ai-text);
        }

        .message-bubble.user {
            background: var(--bubble-user-bg);
            color: var(--bubble-user-text) !important;
            order: 1;
        }

        .message-bubble.user * {
            color: inherit !important;
            margin-bottom: 0;
        }

        /* 输入区域 */
        .chat-input-area {
            background-color: var(--bg-body);
            padding: 0 1rem 1.5rem 1rem;
            position: relative;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .input-wrapper {
            width: 100%;
            max-width: 850px;
            background-color: var(--bg-input);
            border-radius: 24px;
            position: relative;
            border: 1px solid transparent;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper:focus-within {
            background-color: var(--bg-input-focus);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #messageInput {
            background: transparent;
            border: none;
            resize: none;
            overflow-y: hidden;
            min-height: 56px;
            max-height: 200px;
            padding: 16px 50px 16px 20px;
            width: 100%;
            border-radius: 24px;
            font-size: 1rem;
            line-height: 1.5;
        }

        #messageInput:focus {
            box-shadow: none;
            outline: none;
        }

        #fullScreenBtn {
            position: absolute;
            top: 12px;
            right: 16px;
            z-index: 5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-sub);
            background: transparent;
            border: none;
            transition: opacity 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        #fullScreenBtn.show {
            opacity: 1;
            pointer-events: auto;
        }

        #fullScreenBtn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #sendBtn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            transition: all 0.2s;
            z-index: 6;
        }

        #sendBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(78, 110, 242, 0.4);
        }

        /* Session List */
        .session-item {
            padding: 10px 16px;
            margin: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
            transition: background 0.2s;
            height: 44px;
            font-size: 0.9rem;
        }

        .session-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .session-item.active {
            background-color: rgba(78, 110, 242, 0.1);
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        .session-item.active .text-muted {
            color: var(--primary-color) !important;
        }

        /* Markdown & Misc */
        .markdown-body {
            background-color: transparent !important;
            font-family: inherit !important;
            color: inherit !important;
        }

        .markdown-body pre {
            background-color: rgba(0, 0, 0, 0.05) !important;
            border-radius: 8px;
        }

        [data-bs-theme="dark"] .markdown-body pre {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        .markdown-body p {
            margin-bottom: 0.5rem;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }

        .custom-toast {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-radius: 12px;
            animation: slideInRight 0.3s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .custom-toast.hiding {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Settings View */
        #settings-view {
            background-color: var(--bg-body);
            overflow-y: auto;
        }

        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: none;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            margin-bottom: 2rem;
        }

        .nav-pills-settings .nav-link {
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .nav-pills-settings .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .nav-pills-settings .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: bold;
        }

        .persona-card {
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--bg-input);
            height: 100%;
            text-align: center;
            position: relative;
        }

        .persona-card:hover {
            transform: translateY(-2px);
            background-color: var(--bg-input-focus);
            border-color: var(--primary-color);
        }

        .persona-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(78, 110, 242, 0.05);
        }

        .persona-card.selected::after {
            content: '\F26E';
            font-family: 'bootstrap-icons';
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--primary-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.4);
        }

        /* ================= 5. NEW: Exam Mode Styles ================= */
        .mode-nav {
            padding: 0 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .mode-nav-btn {
            border: none;
            background: transparent;
            padding: 10px;
            border-radius: 12px;
            text-align: left;
            color: var(--text-sub);
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .mode-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
        }

        .mode-nav-btn.active {
            background-color: rgba(78, 110, 242, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        .mode-nav-btn i {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        /* Exam View Layout */
        .exam-container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .exam-config-panel {
            width: 320px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .exam-preview-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-body);
            position: relative;
        }

        /* 优化后的试卷卡片样式 (A4 风格) */
        .paper-card {
            background-color: var(--bg-card);
            max-width: 800px;
            margin: 0 auto;
            min-height: 1100px;
            /* A4-like height */
            padding: 60px 50px;
            /* 宽裕的页边距 */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 2px;
            color: var(--text-main);
            font-family: "Times New Roman", "SimSun", serif;
            /* 衬线字体增强文档感 */
        }

        .paper-title {
            text-align: center;
            font-weight: bold;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-family: "SimHei", sans-serif;
        }

        .paper-subtitle {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: var(--text-sub);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1.5rem;
        }

        .question-section h5 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .question-content {
            font-size: 1.15rem;
            line-height: 2;
            text-align: justify;
            margin-bottom: 1rem;
        }

        /* 优化后的填空样式 */
        .blank-space {
            display: inline-block;
            border-bottom: none;
            min-width: 60px;
            text-align: center;
            padding: 0 2px;
            font-weight: normal;
            color: var(--text-main);
            letter-spacing: 2px;
            /* 拉开下划线间距 */
        }

        .exam-meta-tag {
            font-size: 0.9rem;
            padding: 4px 10px;
            background: rgba(78, 110, 242, 0.08);
            color: var(--primary-color);
            border-radius: 4px;
            display: inline-block;
            margin: 0 5px;
            font-family: sans-serif;
        }

        /* Loading Overlay for Generation */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        [data-bs-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        @media (max-width: 992px) {
            .exam-container {
                flex-direction: column;
                overflow-y: auto;
            }

            .exam-config-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                height: auto;
            }

            .exam-preview-panel {
                height: auto;
                overflow: visible;
            }

            .paper-card {
                padding: 30px;
            }
        }
    </style>
</head>

<body>

    <!-- Fullscreen Editor Modal (Original) -->
    <div class="modal fade" id="fullScreenInputModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: var(--bg-body);">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold">沉浸式编辑</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="container h-100 py-4">
                        <textarea id="fullScreenTextarea" class="form-control border-0 h-100 shadow-none"
                            style="font-size: 1.1rem; background: transparent; resize: none;"
                            placeholder="在这里尽情输入..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4"
                        onclick="ui.submitFullScreenInput()">完成</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content p-3 rounded-4" style="background: var(--bg-card); color: var(--text-main);">
                <div class="modal-body text-center">
                    <h5 class="fw-bold mb-3">确认</h5>
                    <p class="text-muted small mb-4" id="confirmMessage"></p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4" id="confirmBtnAction">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end rounded-start-4" tabindex="-1" id="settingsOffcanvas"
        style="background: var(--bg-card); color: var(--text-main);">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold">设置</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="nav flex-column nav-pills nav-pills-settings gap-2" id="mobileSettingsTabs"></div>
        </div>
    </div>

    <!-- 1. 认证视图 (保持原有) -->
    <div id="auth-view" class="view-container active">
        <div class="auth-card" id="authCard">
            <div class="auth-header">
                <h2 class="fw-bold mb-2" style="color: var(--primary-color);">Novi</h2>
                <p class="text-muted">AI 挚友 · 懂你所想</p>
            </div>

            <div class="auth-tabs-container" id="authTabs">
                <div class="auth-tab-bg"></div>
                <button class="auth-tab-btn active" onclick="ui.switchAuthTab('login')">登录</button>
                <button class="auth-tab-btn" onclick="ui.switchAuthTab('register')">注册</button>
            </div>

            <div id="loginFormWrapper" class="auth-form-wrapper">
                <form id="loginForm">
                    <div class="mb-3"><input type="text" class="form-control rounded-3 px-3 py-2" id="loginUser"
                            placeholder="用户名 (任意)" required></div>
                    <div class="mb-4">
                        <div class="input-group password-group">
                            <input type="password" class="form-control rounded-start-3 px-3 py-2" id="loginPass"
                                placeholder="密码 (任意)" required>
                            <span class="input-group-text rounded-end-3"
                                onclick="ui.togglePassword('loginPass', this)"><i class="bi bi-eye-slash"></i></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">进入</button>
                </form>
            </div>
            <div id="registerFormWrapper" class="auth-form-wrapper d-none">
                <form id="registerForm">
                    <div class="mb-2"><input type="text" class="form-control rounded-3" id="regUser" placeholder="用户名"
                            required></div>
                    <div class="mb-2"><input type="text" class="form-control rounded-3" id="regNick" placeholder="昵称"
                            required></div>
                    <div class="mb-2"><input type="email" class="form-control rounded-3" id="regEmail" placeholder="邮箱"
                            required></div>
                    <div class="mb-4">
                        <div class="input-group password-group">
                            <input type="password" class="form-control rounded-start-3" id="regPass" placeholder="密码"
                                required>
                            <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('regPass', this)"><i
                                    class="bi bi-eye-slash"></i></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 shadow-sm">注册</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 侧边栏模板 (优化：使用 Flex 布局修复底部溢出) -->
    <template id="sidebar-template">
        <aside class="sidebar" id="sidebar">
            <div class="p-3 d-flex justify-content-between align-items-center flex-shrink-0">
                <button class="btn rounded-pill text-muted border-0 sidebar-toggle-btn"
                    onclick="ui.handleSidebarToggle()">
                    <i class="bi bi-list fs-5"></i>
                </button>
                <span class="fw-bold ms-2 text-label" style="white-space: nowrap;">功能导航</span>
                <div class="ms-auto"></div>
            </div>

            <!-- NEW: 功能切换区 -->
            <div class="mode-nav mt-2 flex-shrink-0">
                <button class="mode-nav-btn active" id="nav-btn-chat" onclick="app.switchMode('chat')">
                    <i class="bi bi-chat-text"></i>
                    <span class="text-label">智能对话</span>
                </button>
                <button class="mode-nav-btn" id="nav-btn-exam" onclick="app.switchMode('exam')">
                    <i class="bi bi-file-earmark-text"></i>
                    <span class="text-label">AI 出题</span>
                </button>
            </div>

            <hr class="mx-3 my-2 flex-shrink-0" style="border-color: var(--border-color);">

            <!-- Chat Mode Only Elements (优化：使用 Flex Column 填满剩余空间) -->
            <div id="sidebar-chat-elements" class="d-flex flex-column flex-grow-1 overflow-hidden"
                style="min-height: 0;">
                <div class="px-3 mb-3 mt-2 flex-shrink-0">
                    <button
                        class="btn btn-primary w-100 rounded-pill py-2 shadow-sm btn-new-chat d-flex align-items-center justify-content-center"
                        onclick="app.startNewChat()">
                        <i class="bi bi-plus-lg me-2"></i>
                        <span class="text-label">新对话</span>
                    </button>
                </div>
                <div class="px-3 mb-2 small text-muted text-label fw-bold flex-shrink-0">历史记录</div>
                <div class="flex-grow-1 overflow-auto px-2" id="sessionList"></div>
            </div>

            <!-- Exam Mode Only Elements (Added History List) -->
            <div id="sidebar-exam-elements" class="d-none flex-column flex-grow-1 overflow-hidden"
                style="min-height: 0;">
                <div class="px-3 mb-2 mt-2 small text-muted text-label fw-bold flex-shrink-0">生成历史</div>
                <div class="flex-grow-1 overflow-auto px-2" id="examHistoryList">
                    <div class="text-center text-muted small mt-4 p-3">暂无生成记录</div>
                </div>
            </div>

            <div class="mt-auto p-3 border-top flex-shrink-0">
                <div class="dropdown dropup w-100" id="userDropdownContainer">
                    <button
                        class="btn w-100 d-flex align-items-center p-2 rounded hover-bg text-start border-0 user-dropdown-btn"
                        data-bs-toggle="dropdown" style="color: var(--text-main);">
                        <div class="avatar avatar-user me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">U
                        </div>
                        <div class="flex-grow-1 overflow-hidden text-label">
                            <div class="fw-bold text-truncate" id="userNickDisplay">User</div>
                        </div>
                        <i class="bi bi-three-dots-vertical text-muted"></i>
                    </button>
                    <ul class="dropdown-menu shadow-lg border-0 rounded-4 mb-2">
                        <li><a class="dropdown-item py-2" href="#" onclick="ui.navigateTo('settings-view')"><i
                                    class="bi bi-gear me-2"></i>设置</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger py-2" href="#" onclick="app.logout()"><i
                                    class="bi bi-box-arrow-right me-2"></i>退出</a></li>
                    </ul>
                </div>
            </div>
        </aside>
    </template>

    <!-- 2. 聊天视图 (保持原有，侧边栏通过JS动态插入) -->
    <div id="chat-view" class="view-container">
        <!-- Sidebar will be injected here -->
        <main class="chat-main" onclick="ui.handleMainClick(event)">
            <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3"
                style="background: var(--bg-header);">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);"
                        onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                    <h6 class="mb-0 fw-bold" id="currentTitle" style="color: var(--text-main);">Novi AI</h6>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0" title="深色模式">
                        <input class="form-check-input" type="checkbox" id="themeSwitch">
                        <label class="form-check-label" for="themeSwitch"><i class="bi bi-moon-stars"
                                style="color: var(--text-main);"></i></label>
                    </div>
                </div>
            </header>

            <div class="chat-window" id="chatWindow">
                <div class="chat-container" id="chatContainer">
                    <div class="text-center mt-5 pt-5">
                        <div class="avatar avatar-ai mx-auto mb-3"
                            style="width: 64px; height: 64px; font-size: 2rem; border: none; background: transparent;">
                            <i class="bi bi-stars text-primary"></i></div>
                        <h3 class="fw-bold" style="color: var(--text-main);">你好，我是 Novi</h3>
                        <p style="color: var(--text-sub);">我可以帮你写代码、做计划，或者仅仅聊聊天。</p>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <textarea id="messageInput" class="form-control" rows="1" placeholder="输入消息..."></textarea>
                    <button id="fullScreenBtn" onclick="ui.openFullScreenInput()" title="全屏编辑"><i
                            class="bi bi-arrows-angle-expand"></i></button>
                    <button id="sendBtn" onclick="app.sendMessage()" title="发送消息"><i
                            class="bi bi-send-fill"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- ================= 5. NEW: AI Exam View (AI出题视图) ================= -->
    <div id="exam-view" class="view-container">
        <!-- Sidebar will be injected here -->
        <main class="chat-main">
            <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3 border-bottom"
                style="background: var(--bg-header);">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);"
                        onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                    <h6 class="mb-0 fw-bold" style="color: var(--text-main);">AI 智能出题助手</h6>
                </div>
                <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="exam.reset()">
                    <i class="bi bi-arrow-clockwise me-1"></i> 重置
                </button>
            </header>

            <div class="exam-container">
                <!-- Left Config Panel -->
                <div class="exam-config-panel">
                    <h5 class="fw-bold mb-4">出题配置</h5>
                    <form id="examForm" onsubmit="exam.generate(event)">
                        <!-- 优化：使用 form-floating 提升样式，避免遮挡 -->
                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examSubject" aria-label="选择科目">
                                <option value="hb_english_2025" selected>湖北省专升本英语</option>
                                <option value="other" disabled>更多科目开发中...</option>
                            </select>
                            <label for="examSubject">选择科目</label>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examType" aria-label="题型">
                                <option value="grammar_fill">Part I 语法填空</option>
                                <option value="reading" disabled>Part II 阅读理解 (开发中)</option>
                            </select>
                            <label for="examType">题型</label>
                        </div>

                        <!-- NEW: 自定义主题输入框 (默认隐藏) -->
                        <div class="form-floating mb-4 d-none" id="customTopicDiv">
                            <input type="text" class="form-control rounded-3" id="examTopic" placeholder="例如：科技、文化">
                            <label for="examTopic">自定义主题 (可选)</label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold text-muted">难度系数</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="examDifficulty" id="diffEasy"
                                    autocomplete="off">
                                <label class="btn btn-outline-secondary" for="diffEasy">简单</label>

                                <input type="radio" class="btn-check" name="examDifficulty" id="diffMedium"
                                    autocomplete="off" checked>
                                <label class="btn btn-outline-secondary" for="diffMedium">标准</label>

                                <input type="radio" class="btn-check" name="examDifficulty" id="diffHard"
                                    autocomplete="off">
                                <label class="btn btn-outline-secondary" for="diffHard">困难</label>
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label small fw-bold text-muted">题目数量</label>
                            <input type="number" class="form-control rounded-3" value="10" min="5" max="20" disabled
                                title="本题型固定为10题">
                        </div>

                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm mb-3">
                            <i class="bi bi-magic me-2"></i>生成试题
                        </button>
                    </form>
                </div>

                <!-- Right Preview Panel -->
                <div class="exam-preview-panel">
                    <div id="paperLoading" class="loading-overlay d-none">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h5 class="fw-bold">AI 正在根据 2025 考纲出题中...</h5>
                            <p class="text-muted small">分析考点 · 组织文本 · 生成解析</p>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="paperEmpty"
                        class="h-100 d-flex flex-direction-column align-items-center justify-content-center text-center text-muted">
                        <div>
                            <i class="bi bi-file-earmark-text display-1 opacity-25"></i>
                            <p class="mt-3">在左侧配置参数后点击生成</p>
                        </div>
                    </div>

                    <!-- Paper Content -->
                    <div id="paperContent" class="d-none">
                        <div class="d-flex justify-content-end mb-3 gap-2">
                            <div class="form-check form-switch pt-2">
                                <input class="form-check-input" type="checkbox" id="showAnswersSwitch"
                                    onchange="exam.toggleAnswers()">
                                <label class="form-check-label" for="showAnswersSwitch">显示解析</label>
                            </div>
                            <button class="btn btn-success rounded-pill px-4" onclick="exam.exportWord()">
                                <i class="bi bi-file-word me-1"></i> 导出 Word
                            </button>
                        </div>

                        <div class="paper-card" id="paperExportArea">
                            <div class="paper-title">湖北省普通专升本选拔考试 - 英语模拟卷</div>
                            <div id="paperSubtitleContainer" class="paper-subtitle d-none"></div>
                            <div class="text-center mb-4">
                                <span class="exam-meta-tag">科目：英语</span>
                                <span class="exam-meta-tag">题型：语法填空</span>
                                <span class="exam-meta-tag">满分：20分</span>
                            </div>

                            <div id="paperBody">
                                <!-- JS Rendered Content -->
                            </div>

                            <div id="paperAnswers" class="mt-5 pt-4 border-top d-none">
                                <h5 class="fw-bold mb-3">参考答案与解析</h5>
                                <div id="answersBody"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 3. 设置视图 (保持原有) -->
    <div id="settings-view" class="view-container">
        <div class="settings-container">
            <div class="mb-4 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <button class="btn btn-icon rounded-circle me-3 hover-bg" onclick="ui.navigateTo('chat-view')"
                        style="width:40px;height:40px;background:var(--bg-input);color:var(--text-main);"><i
                            class="bi bi-arrow-left"></i></button>
                    <h4 class="fw-bold mb-0">设置</h4>
                </div>
                <button class="btn btn-outline-secondary border-0 d-lg-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#settingsOffcanvas">
                    <i class="bi bi-list fs-4"></i>
                </button>
            </div>
            <div class="row g-4">
                <div class="col-lg-3 d-none d-lg-block">
                    <nav class="nav flex-column nav-pills nav-pills-settings" id="settingsDesktopNav">
                        <button class="nav-link active text-start mb-2" data-bs-toggle="pill"
                            data-bs-target="#tab-profile" onclick="ui.syncMobileNav('tab-profile')"><i
                                class="bi bi-person me-2"></i>个人资料</button>
                        <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#tab-persona"
                            onclick="ui.syncMobileNav('tab-persona')"><i class="bi bi-magic me-2"></i>AI 设定</button>
                        <button class="nav-link text-start text-danger mt-4" onclick="app.logout()"><i
                                class="bi bi-box-arrow-left me-2"></i>退出登录</button>
                    </nav>
                </div>
                <div class="col-lg-9">
                    <div class="tab-content" id="settingsTabContent">
                        <div class="tab-pane fade show active" id="tab-profile">
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">个人信息</h5>
                                <form id="profileForm">
                                    <div class="row g-3">
                                        <div class="col-md-6"><label
                                                class="form-label small fw-bold text-muted">用户名</label><input
                                                type="text" class="form-control rounded-3" id="pfUsername" disabled>
                                        </div>
                                        <div class="col-md-6"><label
                                                class="form-label small fw-bold text-muted">昵称</label><input type="text"
                                                class="form-control rounded-3" id="pfNickname"></div>
                                        <div class="col-12"><label
                                                class="form-label small fw-bold text-muted">邮箱</label><input
                                                type="email" class="form-control rounded-3" id="pfEmail"></div>
                                    </div>
                                    <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4"
                                            type="button" onclick="app.saveProfile()">保存更改</button></div>
                                </form>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-persona">
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">核心性格</h5>
                                <div class="row row-cols-2 row-cols-lg-3 g-3 mb-4" id="personalityGrid"></div>
                                <div class="mt-3 d-none" id="customPersonaInputDiv">
                                    <label class="form-label small fw-bold text-muted">自定义 Prompt</label>
                                    <textarea class="form-control rounded-3" id="psCustomPersona" rows="3"
                                        placeholder="输入你想要的 Prompt..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        /* ================= 模拟数据：湖北省专升本英语 ================= */
        const MOCK_EXAM_DATA = {
            "article_content": "Part Ⅰ 语法填空（本大题共10小题，每小题2分，共20分）\n阅读下面短文，在题号（第1-10题）空白处填入括号内提示词的正确形式，若无提示词则填入一个适当的单词，并将答案写在答题卡相应题号后的横线上\n\nThe Spring Festival, also referred to as Chinese New Year, is 1 most significant traditional festival in China. It signifies the commencement of the lunar new year and is deeply rooted in Chinese culture. Celebrations typically involve family gatherings, lavish meals, and a variety of customs that have been passed down through generations.\n\nPrior to the festival, families engage in thorough cleaning of their homes, which is believed to drive away misfortune. Decorations such as red lanterns and spring couplets are put up to usher in good fortune. On New Year's Eve, relatives come together for a reunion dinner, 2 (enjoy) delicacies like dumplings and fish, which symbolize prosperity. Following the meal, many people watch the annual Spring Festival Gala on television, a popular program that features music, dance, and comedy.\n\nOn the first day of the new year, it is customary to visit friends and relatives, 3 (exchange) blessings and gifts. Children eagerly anticipate receiving red envelopes, known as 'hongbao,' 4 contain money and are thought to bring good luck for the coming year. With the advent of modern technology, a growing number of individuals now send electronic red envelopes 5 smartphones, blending tradition with innovation.\n\n6 the past, the Spring Festival was primarily a time for domestic activities and relaxation. However, in contemporary society, an increasing number of people opt to travel during the holiday period. Despite these 7 (change), the fundamental emphasis on family unity continues to be a cornerstone of the celebration.\n\nThe Spring Festival not only helps to preserve Chinese cultural heritage but also 8 (promote) social harmony. It embodies 9 (tradition) values such as filial piety and respect for elders. As China 10 (become) more integrated into the global community, the festival is increasingly celebrated worldwide.\n\nIn summary, the Spring Festival is a wonderful occasion that bridges historical traditions with modern practices.",
            "answers": {
                "1": { "answer": "the", "explanation": "定冠词，用于形容词最高级前，表示特指。" },
                "2": { "answer": "enjoying", "explanation": "现在分词作状语，表示伴随动作，与主句主语relatives构成主动关系。" },
                "3": { "answer": "exchanging", "explanation": "现在分词作状语，表示目的或方式，与主句主语it（形式主语）隐含的people构成主动关系。" },
                "4": { "answer": "which", "explanation": "关系代词，引导非限制性定语从句，指代前文red envelopes，并在从句中作主语。" },
                "5": { "answer": "via", "explanation": "介词，表示通过某种方式或工具，与smartphones搭配。" },
                "6": { "answer": "In", "explanation": "介词，表示在某个时期或时间段，与the past搭配。" },
                "7": { "answer": "changes", "explanation": "名词复数形式，与指示代词these搭配，指代前文提到的变化。" },
                "8": { "answer": "promotes", "explanation": "动词第三人称单数形式，主语为The Spring Festival，遵循主谓一致原则。" },
                "9": { "answer": "traditional", "explanation": "形容词，修饰名词values，表示传统价值观。" },
                "10": { "answer": "becomes", "explanation": "动词第三人称单数形式，主语为China，遵循主谓一致原则，表示当前状态。" }
            }
        };

        /* ================= 核心逻辑 ================= */
        const PERSONALITY_OPTIONS = [
            { id: 'default', icon: 'bi-emoji-smile', title: '标准', desc: '平衡、理智' },
            { id: 'witty', icon: 'bi-emoji-laughing', title: '幽默', desc: '风趣好玩' },
            { id: 'gentle', icon: 'bi-flower1', title: '温柔', desc: '知心、治愈' },
            { id: 'professional', icon: 'bi-briefcase', title: '专家', desc: '严谨、学术' },
            { id: 'tsundere', icon: 'bi-lightning', title: '傲娇', desc: '口是心非' },
            { id: 'custom', icon: 'bi-pencil-square', title: '自定义', desc: '完全由你决定' }
        ];

        marked.use({ breaks: true, gfm: true });

        // 打字机逻辑 (保持不变)
        const Typewriter = {
            queue: [], element: null, isTyping: false, timer: null, chatWindow: null, fullText: "",
            start(element) { this.element = element; this.queue = []; this.fullText = ""; this.isTyping = true; this.chatWindow = document.getElementById('chatWindow'); this.processQueue(); },
            push(text) { this.queue.push(...text.split('')); if (!this.isTyping) this.processQueue(); },
            stop() { this.isTyping = false; clearTimeout(this.timer); if (this.queue.length > 0) { this.fullText += this.queue.join(''); this.queue = []; } if (this.element) { this.render(this.fullText || (this.element.dataset.raw || '')); } },
            processQueue() {
                if (this.queue.length === 0) { if (!this.isTyping) return; this.timer = setTimeout(() => this.processQueue(), 50); return; }
                const speed = this.queue.length > 50 ? 5 : (this.queue.length > 20 ? 15 : 30);
                let chunk = ''; for (let i = 0; i < (this.queue.length > 100 ? 10 : 2) && this.queue.length > 0; i++) chunk += this.queue.shift();
                this.fullText += chunk; this.render(this.fullText); this.timer = setTimeout(() => this.processQueue(), speed);
            },
            render(rawText) {
                if (!this.element) return; this.element.dataset.raw = rawText; this.element.innerHTML = marked.parse(rawText);
                const win = this.chatWindow; if (!win) return;
                if (win.scrollHeight - win.scrollTop - win.clientHeight < 150) win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
            }
        };

        const ui = {
            confirmModal: null, offcanvas: null, confirmCallback: null, fullScreenModal: null, lastToastTime: 0,

            init() {
                this.confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                this.offcanvas = new bootstrap.Offcanvas(document.getElementById('settingsOffcanvas'));
                this.fullScreenModal = new bootstrap.Modal(document.getElementById('fullScreenInputModal'));

                document.getElementById('confirmBtnAction').addEventListener('click', () => { if (this.confirmCallback) this.confirmCallback(); this.confirmModal.hide(); });
                this.renderPersonalityGrid();
                this.initMobileSettingsNav();

                // 动态插入侧边栏内容
                this.renderSidebar();

                const msgInput = document.getElementById('messageInput');
                const fsBtn = document.getElementById('fullScreenBtn');
                if (msgInput) {
                    msgInput.addEventListener('input', function () {
                        this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; if (this.value === '') this.style.height = '56px';
                        if (this.scrollHeight > 90) fsBtn.classList.add('show'); else fsBtn.classList.remove('show');
                    });
                    msgInput.style.height = '56px';
                }
            },

            // NEW: 渲染侧边栏（因为现在有两个视图共用侧边栏）
            renderSidebar() {
                const tpl = document.getElementById('sidebar-template').content;

                // 插入 Chat View
                const chatSide = document.querySelector('#chat-view');
                if (chatSide && !chatSide.querySelector('.sidebar')) chatSide.prepend(tpl.cloneNode(true));

                // 插入 Exam View
                const examSide = document.querySelector('#exam-view');
                if (examSide && !examSide.querySelector('.sidebar')) {
                    const clone = tpl.cloneNode(true);
                    // 默认折叠侧边栏在 Exam 视图下，为了更多预览空间? 不，保持统一更好
                    examSide.prepend(clone);
                }
            },

            // NEW: 更新侧边栏状态（激活按钮）
            updateSidebarState(mode) {
                document.querySelectorAll('.mode-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll(`#nav-btn-${mode}`).forEach(btn => btn.classList.add('active'));

                // 切换侧边栏特定内容
                const showId = `sidebar-${mode}-elements`;
                document.querySelectorAll(`[id^="sidebar-"][id$="-elements"]`).forEach(el => el.classList.add('d-none'));
                document.querySelectorAll(`#${showId}`).forEach(el => el.classList.remove('d-none').add('d-flex')); // Flex fix for chat sidebar
            },

            togglePassword(inputId, btn) {
                const input = document.getElementById(inputId); const icon = btn.querySelector('i');
                if (input.type === 'password') { input.type = 'text'; icon.classList.replace('bi-eye-slash', 'bi-eye'); } else { input.type = 'password'; icon.classList.replace('bi-eye', 'bi-eye-slash'); }
            },
            openFullScreenInput() { document.getElementById('fullScreenTextarea').value = document.getElementById('messageInput').value; this.fullScreenModal.show(); },
            submitFullScreenInput() { const mainInput = document.getElementById('messageInput'); mainInput.value = document.getElementById('fullScreenTextarea').value; mainInput.dispatchEvent(new Event('input')); this.fullScreenModal.hide(); mainInput.focus(); },
            initMobileSettingsNav() {
                const desktopNav = document.getElementById('settingsDesktopNav'); const mobileNav = document.getElementById('mobileSettingsTabs');
                mobileNav.innerHTML = desktopNav.innerHTML;
                mobileNav.querySelectorAll('.nav-link').forEach(btn => {
                    if (btn.getAttribute('onclick').includes('logout')) return;
                    btn.addEventListener('click', (e) => { this.syncMobileNav(e.currentTarget.getAttribute('data-bs-target').replace('#', '')); this.offcanvas.hide(); });
                });
            },
            syncMobileNav(targetId) { const triggerEl = document.querySelector(`#settingsDesktopNav button[data-bs-target="#${targetId}"]`); bootstrap.Tab.getInstance(triggerEl).show(); },

            navigateTo(viewId) {
                document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if (viewId === 'settings-view') { app.loadProfile(); app.loadPreferences(); }
            },

            switchAuthTab(tab) {
                const loginWrapper = document.getElementById('loginFormWrapper'); const regWrapper = document.getElementById('registerFormWrapper');
                const tabsContainer = document.getElementById('authTabs'); const btns = tabsContainer.querySelectorAll('.auth-tab-btn'); const card = document.getElementById('authCard');
                if (tab === 'register') { tabsContainer.classList.add('register-mode'); btns[0].classList.remove('active'); btns[1].classList.add('active'); } else { tabsContainer.classList.remove('register-mode'); btns[0].classList.add('active'); btns[1].classList.remove('active'); }
                card.style.height = card.offsetHeight + 'px';
                const activeWrapper = tab === 'login' ? regWrapper : loginWrapper; const nextWrapper = tab === 'login' ? loginWrapper : regWrapper;
                activeWrapper.classList.add('fading');
                setTimeout(() => { activeWrapper.classList.add('d-none'); nextWrapper.classList.remove('d-none'); nextWrapper.classList.add('fading'); card.style.height = 'auto'; nextWrapper.classList.remove('fading'); }, 200);
            },

            // Sidebar 统一处理
            toggleSidebar(e) { if (e) e.stopPropagation(); document.querySelectorAll('.view-container.active').forEach(el => el.classList.toggle('sidebar-open')); },
            handleSidebarToggle() {
                if (window.innerWidth <= 768) this.toggleSidebar();
                else {
                    document.getElementById('chat-view').classList.toggle('sidebar-collapsed');
                    document.getElementById('exam-view').classList.toggle('sidebar-collapsed');
                }
            },
            handleMainClick() { document.querySelectorAll('.view-container').forEach(el => el.classList.remove('sidebar-open')); },

            toast(msg, type = 'info') {
                const now = Date.now(); if (now - this.lastToastTime < 500) return; this.lastToastTime = now;
                const container = document.getElementById('toastContainer'); const id = 'toast-' + now;
                const bgClass = type === 'success' ? 'border-success' : (type === 'error' ? 'border-danger' : '');
                const iconClass = type === 'success' ? 'bi-check-circle-fill text-success' : (type === 'error' ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary');
                const html = `<div id="${id}" class="toast align-items-center custom-toast ${bgClass} show" role="alert"><div class="d-flex p-3 align-items-center"><i class="bi ${iconClass} fs-5 me-3"></i><div class="toast-body p-0 fw-medium">${msg}</div><button type="button" class="btn-close me-2 m-auto" onclick="ui.closeToast('${id}')"></button></div></div>`;
                container.insertAdjacentHTML('beforeend', html); setTimeout(() => ui.closeToast(id), 3000);
            },
            closeToast(id) { const el = document.getElementById(id); if (!el) return; el.classList.add('hiding'); el.addEventListener('animationend', () => el.remove()); },
            confirm(msg, callback) { document.getElementById('confirmMessage').innerText = msg; this.confirmCallback = callback; this.confirmModal.show(); },
            renderPersonalityGrid() {
                const container = document.getElementById('personalityGrid');
                container.innerHTML = PERSONALITY_OPTIONS.map(p => `<div class="col"><div class="persona-card" onclick="ui.selectPersona('${p.id}')" id="card-${p.id}"><i class="bi ${p.icon} fs-2 mb-2 d-block text-primary"></i><div class="fw-bold">${p.title}</div><div class="small text-muted mt-1">${p.desc}</div></div></div>`).join('');
            },
            selectPersona(id) {
                document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected')); document.getElementById(`card-${id}`).classList.add('selected');
                const customInput = document.getElementById('customPersonaInputDiv');
                if (id === 'custom') { customInput.classList.remove('d-none'); app.currentPreferences.personalityMode = document.getElementById('psCustomPersona').value || 'custom'; } else { customInput.classList.add('d-none'); app.currentPreferences.personalityMode = id; }
            }
        };

        /* ================= NEW: Exam Logic (AI出题逻辑) ================= */
        const exam = {
            data: null,

            init() {
                // NEW: 监听题型选择变化，显示/隐藏自定义主题
                const typeSelect = document.getElementById('examType');
                const topicDiv = document.getElementById('customTopicDiv');
                if (typeSelect && topicDiv) {
                    typeSelect.addEventListener('change', (e) => {
                        if (e.target.value === 'grammar_fill') topicDiv.classList.remove('d-none');
                        else topicDiv.classList.add('d-none');
                    });
                    // 初始化状态检查
                    if (typeSelect.value === 'grammar_fill') topicDiv.classList.remove('d-none');
                }
            },

            // 生成试卷
            generate(e) {
                e.preventDefault();
                const subject = document.getElementById('examSubject').value;
                const type = document.getElementById('examType').value;
                const topic = document.getElementById('examTopic').value; // 获取自定义主题

                // UI Loading
                document.getElementById('paperLoading').classList.remove('d-none');
                document.getElementById('paperEmpty').classList.add('d-none');
                document.getElementById('paperContent').classList.add('d-none');

                // 模拟 API 请求延迟
                setTimeout(() => {
                    this.data = MOCK_EXAM_DATA;
                    // 将自定义主题传递给渲染函数
                    this.renderPaper(this.data, topic);

                    // NEW: 添加到历史记录
                    this.addToHistory(type, topic);

                    document.getElementById('paperLoading').classList.add('d-none');
                    document.getElementById('paperContent').classList.remove('d-none');
                    ui.toast('试卷生成成功！', 'success');
                }, 1500);
            },

            // NEW: 添加历史记录
            addToHistory(type, topic) {
                const list = document.getElementById('examHistoryList');
                // 清除"暂无记录"
                if (list.querySelector('.text-center')) list.innerHTML = '';

                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const title = topic ? `语法填空 - ${topic}` : '语法填空专项练习';

                const itemHTML = `
                <div class="session-item" onclick="exam.restoreHistory('${title}')">
                    <div class="d-flex flex-column w-100">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold text-truncate" style="max-width: 140px;">${title}</span>
                            <span class="small text-muted">${timeStr}</span>
                        </div>
                        <div class="small text-muted text-truncate">2025 湖北专升本英语</div>
                    </div>
                </div>`;

                // 插入到最前面
                list.insertAdjacentHTML('afterbegin', itemHTML);
            },

            // NEW: 恢复历史记录 (模拟)
            restoreHistory(title) {
                document.getElementById('paperEmpty').classList.add('d-none');
                document.getElementById('paperContent').classList.remove('d-none');
                this.renderPaper(MOCK_EXAM_DATA, title.includes('-') ? title.split('-')[1].trim() : '');
                // 在移动端点击历史后自动收起侧边栏
                if (window.innerWidth <= 768) ui.handleMainClick();
            },

            // 渲染试卷
            renderPaper(data, topic = '') {
                const paperBody = document.getElementById('paperBody');
                const answersBody = document.getElementById('answersBody');
                const subtitleContainer = document.getElementById('paperSubtitleContainer');

                // 显示自定义主题
                if (topic) {
                    subtitleContainer.innerText = `主题：${topic}`;
                    subtitleContainer.classList.remove('d-none');
                } else {
                    subtitleContainer.classList.add('d-none');
                }

                // 1. 处理文章内容，替换 \n 为段落，并加粗处理
                let contentHtml = data.article_content
                    .split('\n').filter(line => line.trim() !== '')
                    .map(line => {
                        // 识别大标题 (Part I...)
                        if (line.startsWith('Part')) return `<h5 class="fw-bold mb-3">${line}</h5>`;
                        // 识别说明文
                        if (line.startsWith('阅读下面短文') || line.startsWith('Directions')) return `<p class="fst-italic text-muted mb-4 small">${line}</p>`;
                        // 正文段落
                        return `<p class="question-content" style="text-indent: 2em;">${this.formatBlanks(line)}</p>`;
                    }).join('');

                paperBody.innerHTML = contentHtml;

                // 2. 渲染答案
                let answersHtml = '<table class="table table-bordered table-striped mt-3"><thead><tr><th style="width:60px">题号</th><th>答案</th><th>解析</th></tr></thead><tbody>';
                for (let i = 1; i <= 10; i++) {
                    const item = data.answers[i.toString()];
                    if (item) {
                        answersHtml += `<tr>
                        <td class="text-center fw-bold">${i}</td>
                        <td class="text-primary fw-bold">${item.answer}</td>
                        <td class="small text-muted">${item.explanation}</td>
                    </tr>`;
                    }
                }
                answersHtml += '</tbody></table>';
                answersBody.innerHTML = answersHtml;

                // 默认隐藏答案
                document.getElementById('showAnswersSwitch').checked = false;
                document.getElementById('paperAnswers').classList.add('d-none');
            },

            // 格式化填空题：将 " 1 " 替换为 " 1. _______ "
            formatBlanks(text) {
                // 简单正则匹配 1-10 的数字占位 (需注意避开年份2025中的数字)
                // 假设题目中的数字前后有空格，或者是 "1 " 格式
                // 这里针对提供的文本做特化处理
                return text.replace(/\b([1-9]|10)\b/g, (match) => {
                    // Modified: Use actual underscores instead of CSS border
                    return `<span class="fw-bold text-primary mx-1">[${match}]</span><span class="blank-space">__________</span>`;
                });
            },

            toggleAnswers() {
                const show = document.getElementById('showAnswersSwitch').checked;
                const el = document.getElementById('paperAnswers');
                if (show) el.classList.remove('d-none'); else el.classList.add('d-none');
            },

            reset() {
                document.getElementById('paperContent').classList.add('d-none');
                document.getElementById('paperEmpty').classList.remove('d-none');
                document.getElementById('examForm').reset();
                document.getElementById('customTopicDiv').classList.add('d-none'); // 隐藏主题输入
            },

            // 导出 Word 功能 (前端生成 - 优化样式)
            exportWord() {
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title></head><body>";
                const footer = "</body></html>";

                // 优化1：注入内联样式，确保Word排版与Web一致
                const styles = `
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    .paper-title { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 20px; }
                    .paper-subtitle { text-align: center; font-size: 14pt; margin-bottom: 20px; color: #555; }
                    .exam-meta-tag { display: none; } /* 导出时不显示标签 */
                    .question-content { text-indent: 2em; line-height: 1.5; text-align: justify; margin-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    thead { background-color: #f2f2f2; }
                    .text-center { text-align: center; }
                    .fw-bold { font-weight: bold; }
                    h5 { font-size: 14pt; margin-top: 15px; margin-bottom: 10px; font-weight: bold; }
                    /* 修复下划线消失问题 - removing border as we now use chars */
                    .blank-space { text-decoration: none; display: inline-block; }
                </style>
            `;

                // 克隆一份节点用于清洗样式，避免导出按钮等杂物
                const sourceHTML = document.getElementById("paperExportArea").innerHTML;

                const source = header + styles + sourceHTML + footer;

                const blob = new Blob(['\ufeff', source], { type: 'application/msword' });

                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = '湖北专升本英语模拟卷.doc'; // Word 2003 XML 格式，兼容性最好
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                ui.toast('文档导出中...', 'success');
            }
        };

        const app = {
            config: { apiBase: 'http://localhost:8080/api/v1' },
            state: { token: localStorage.getItem('novi_token'), user: {}, sessionId: null, isTyping: false },
            currentPreferences: {},

            init() {
                ui.init();
                exam.init(); // NEW: 初始化 Exam 模块
                this.setupAxios();
                this.bindEvents();
                const isDark = localStorage.getItem('novi_theme') === 'dark';
                document.getElementById('themeSwitch').checked = isDark;
                if (isDark) document.documentElement.setAttribute('data-bs-theme', 'dark');
                // Mock Login for demo ease, or check real token
                if (this.state.token) {
                    this.initLoggedInState();
                } else {
                    // 如果没有Token，停留在 auth-view
                }
                document.getElementById('psCustomPersona').addEventListener('input', (e) => {
                    if (document.getElementById('card-custom').classList.contains('selected')) this.currentPreferences.personalityMode = e.target.value;
                });
            },

            // NEW: 模式切换
            switchMode(mode) {
                if (mode === 'chat') ui.navigateTo('chat-view');
                else if (mode === 'exam') ui.navigateTo('exam-view');

                ui.updateSidebarState(mode);
                // 移动端切换后自动关闭侧边栏
                if (window.innerWidth <= 768) ui.handleMainClick();
            },

            setupAxios() {
                axios.defaults.baseURL = this.config.apiBase;
                axios.interceptors.request.use(c => { if (this.state.token) c.headers.Authorization = `Bearer ${this.state.token}`; return c; });
                axios.interceptors.response.use(r => r, e => { if (e.response?.status === 401) this.logout(); return Promise.reject(e); });
            },

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', e => {
                    e.preventDefault();
                    // Demo: Any login works
                    this.state.token = "mock_token_" + Date.now();
                    localStorage.setItem('novi_token', this.state.token);
                    ui.toast('登录成功 (模拟)', 'success');
                    this.initLoggedInState();
                });

                document.getElementById('themeSwitch').addEventListener('change', e => {
                    const theme = e.target.checked ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-bs-theme', theme);
                    localStorage.setItem('novi_theme', theme);
                });
            },

            async initLoggedInState(checkOnboarding = false) {
                // 默认进入聊天
                this.switchMode('chat');

                // 模拟用户信息
                this.state.user = { username: 'demo_user', nickname: '考生同学', email: 'student@hb.edu' };
                document.querySelectorAll('#userNickDisplay').forEach(el => el.textContent = this.state.user.nickname);

                this.loadSessions();
            },

            async loadSessions() {
                // Mock Sessions
                const list = document.getElementById('sessionList');
                if (list) {
                    list.innerHTML = `
                    <div class="session-item active"><div class="text-truncate">英语备考计划</div></div>
                    <div class="session-item"><div class="text-truncate">上次提到的语法点</div></div>
                `;
                }
            },

            startNewChat() {
                this.state.sessionId = null;
                document.getElementById('currentTitle').innerText = 'Novi AI';
                document.getElementById('chatContainer').innerHTML = `<div class="text-center mt-5 pt-5"><div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem; border:none; background:transparent;"><i class="bi bi-stars text-primary"></i></div><h3 class="fw-bold">你好，我是 Novi</h3><p class="text-muted">我可以帮你写代码、做计划，或者仅仅聊聊天。</p></div>`;
                ui.handleMainClick();
            },

            sendMessage() {
                const input = document.getElementById('messageInput');
                const msg = input.value.trim();
                if (!msg || this.state.isTyping) return;

                // Fake Send
                const container = document.getElementById('chatContainer');
                if (container.querySelector('.text-center')) container.innerHTML = '';

                this.addMessageBubble('user', msg);
                input.value = '';

                this.state.isTyping = true;
                const aiId = 'ai-' + Date.now();
                this.addMessageBubble('assistant', '', aiId);

                setTimeout(() => {
                    const bubble = document.getElementById(aiId);
                    Typewriter.start(bubble);
                    Typewriter.push("这是一个前端演示版本，聊天功能暂时使用模拟回复。请尝试点击左侧菜单的“AI 出题”功能体验新特性。");
                    setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; }, 500);
                }, 600);
            },

            addMessageBubble(role, content, id) {
                const container = document.getElementById('chatContainer');
                const div = document.createElement('div');
                div.className = `message-row ${role}`;
                const avatar = `<div class="avatar ${role === 'user' ? 'avatar-user' : 'avatar-ai'}"><i class="bi bi-${role === 'user' ? 'person-fill' : 'stars'}"></i></div>`;
                const bub = `<div class="message-bubble ${role} markdown-body" ${id ? `id="${id}" data-raw=""` : ''}>${content ? marked.parse(content) : ''}</div>`;
                div.innerHTML = avatar + bub;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            logout() { localStorage.removeItem('novi_token'); location.reload(); },
            saveProfile() { ui.toast('仅演示：资料保存成功', 'success'); },
            savePreferences() { ui.toast('仅演示：设置保存成功', 'success'); }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>