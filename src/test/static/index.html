<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novi · AI 挚友</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.css">

    <style>
        :root {
            --sidebar-width: 280px;
            --primary-color: #4e6ef2;
        }

        body {
            height: 100vh;
            overflow: hidden;
            background-color: #f8f9fa;
        }

        /* 登录/注册容器 */
        #auth-container {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* 聊天主界面 */
        #app-container {
            display: none; /* 默认隐藏，登录后显示 */
            height: 100vh;
            flex-direction: row;
        }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #ffffff;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .session-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            color: #333;
            text-decoration: none;
        }
        .session-item:hover {
            background-color: #f1f3f5;
        }
        .session-item.active {
            background-color: #e7f1ff;
            color: var(--primary-color);
            font-weight: 500;
        }
        .session-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        /* 聊天区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #fff;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.95);
        }

        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .message-row {
            display: flex;
            margin-bottom: 20px;
        }
        .message-row.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            flex-shrink: 0;
        }
        .avatar-novi { background-color: #e7f1ff; color: var(--primary-color); }
        .avatar-user { background-color: var(--primary-color); color: white; }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .message-bubble.user {
            background-color: var(--primary-color);
            color: #212529;
            border-top-right-radius: 2px;
        }
        .message-bubble.assistant {
            background-color: white;
            border: 1px solid #e9ecef;
            border-top-left-radius: 2px;
            color: #212529;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* 输入区域 */
        .input-area {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        .input-wrapper {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .chat-input {
            border: none;
            outline: none;
            width: 100%;
            resize: none;
            max-height: 150px;
            padding: 5px;
        }

        /* Markdown 样式修正 */
        .markdown-body {
            background: transparent !important;
            font-size: 0.95rem;
        }
        .message-bubble.user .markdown-body {
            color: white;
        }
        .message-bubble.user .markdown-body p {
            margin-bottom: 0;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>

<div id="auth-container">
    <div class="auth-card">
        <div class="text-center mb-4">
            <h3 class="fw-bold text-primary"><i class="bi bi-chat-heart me-2"></i>Novi</h3>
            <p class="text-muted">你独一无二的 AI 挚友</p>
        </div>

        <ul class="nav nav-pills nav-fill mb-4" id="authTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="pill" data-bs-target="#login-pane" type="button">登录</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="pill" data-bs-target="#register-pane" type="button">注册</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="login-pane">
                <form id="loginForm">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="loginUser" placeholder="用户名" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="loginPass" placeholder="密码" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2">立即登录</button>
                </form>
            </div>
            <div class="tab-pane fade" id="register-pane">
                <form id="registerForm">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="regUser" placeholder="用户名 (4-20位)" required minlength="4" maxlength="20">
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="regNick" placeholder="昵称" required>
                    </div>
                    <div class="mb-3">
                        <input type="email" class="form-control" id="regEmail" placeholder="邮箱" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="regPass" placeholder="密码 (大小写+数字+特殊字符)" required>
                        <div class="form-text" style="font-size: 12px;">密码需8位以上，包含大小写字母、数字及特殊字符。</div>
                    </div>
                    <button type="submit" class="btn btn-outline-primary w-100 py-2">注册账号</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="app-container">
    <div class="sidebar" id="sidebar">
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
            <h5 class="mb-0 fw-bold">历史会话</h5>
            <button class="btn btn-sm btn-primary" onclick="startNewChat()">
                <i class="bi bi-plus-lg"></i> 新对话
            </button>
        </div>
        <div class="session-list" id="sessionList">
        </div>
        <div class="p-3 border-top bg-light">
            <div class="d-flex align-items-center justify-content-between dropup">
                <div class="d-flex align-items-center" role="button" data-bs-toggle="dropdown">
                    <div class="avatar avatar-user me-2"><i class="bi bi-person"></i></div>
                    <span class="fw-bold" id="userNicknameDisplay">User</span>
                </div>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>退出登录</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <button class="btn btn-link text-dark d-md-none me-2" onclick="toggleSidebar()">
                    <i class="bi bi-list fs-5"></i>
                </button>
                <span class="fw-bold text-truncate" style="max-width: 200px;" id="currentChatTitle">新会话</span>
            </div>

            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="chatMode" id="modeStream" value="stream" checked>
                <label class="btn btn-outline-secondary btn-sm" for="modeStream"><i class="bi bi-lightning-fill"></i> 流式</label>

                <input type="radio" class="btn-check" name="chatMode" id="modeCall" value="call">
                <label class="btn btn-outline-secondary btn-sm" for="modeCall"><i class="bi bi-hourglass-split"></i> 阻断</label>
            </div>
        </div>

        <div class="chat-window" id="chatWindow">
            <div class="message-row assistant">
                <div class="avatar avatar-novi"><i class="bi bi-robot"></i></div>
                <div class="message-bubble assistant markdown-body">
                    你好！我是 Novi。我是你的挚友，我会记住我们的每一次对话。我们可以开始聊天了吗？
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="messageInput" class="chat-input" rows="1" placeholder="给 Novi 发送消息... (Shift + Enter 换行)"></textarea>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted" style="font-size: 12px;"><i class="bi bi-info-circle"></i>内容由 AI模型 生成</small>
                    <button class="btn btn-primary rounded-pill px-4" id="sendBtn" onclick="sendMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    // ================= 配置与状态 =================
    const API_BASE = 'http://localhost:8080/api/v1';
    let state = {
        token: localStorage.getItem('novi_token'),
        user: JSON.parse(localStorage.getItem('novi_user') || '{}'),
        currentSessionId: null,
        isLoading: false
    };

    // 配置 Axios 拦截器 (自动添加 Token)
    const api = axios.create({ baseURL: API_BASE });
    api.interceptors.request.use(config => {
        if (state.token) {
            config.headers.Authorization = `Bearer ${state.token}`;
        }
        return config;
    });
    api.interceptors.response.use(
        response => response,
        error => {
            if (error.response && error.response.status === 401) {
                logout(); // Token 失效自动登出
            }
            return Promise.reject(error);
        }
    );

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        if (state.token) {
            showApp();
        } else {
            showAuth();
        }

        // 输入框自适应高度
        const input = document.getElementById('messageInput');
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        // 监听回车
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    // ================= 认证逻辑 =================

    function showAuth() {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }

    function showApp() {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('userNicknameDisplay').textContent = state.user.nickname || state.user.username;
        loadSessions(); // 加载侧边栏
    }

    // 登录
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUser').value;
        const password = document.getElementById('loginPass').value;

        try {
            const res = await api.post('/users/login', { username, password });
            if (res.data.code === 1) {
                const { token, userId } = res.data.data;
                state.token = token;
                localStorage.setItem('novi_token', token);

                // 获取用户详情以显示昵称
                const userRes = await api.get('/users/me', { headers: { Authorization: `Bearer ${token}` }});
                state.user = userRes.data.data;
                localStorage.setItem('novi_user', JSON.stringify(state.user));

                showApp();
            } else {
                alert(res.data.msg);
            }
        } catch (err) {
            alert('登录失败: ' + (err.response?.data?.msg || err.message));
        }
    });

    // 注册
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            username: document.getElementById('regUser').value,
            nickname: document.getElementById('regNick').value,
            email: document.getElementById('regEmail').value,
            password: document.getElementById('regPass').value
        };

        try {
            const res = await api.post('/users/register', data);
            if (res.data.code === 1) {
                alert('注册成功！请登录');
                document.getElementById('login-tab').click();
            } else {
                alert(res.data.msg);
            }
        } catch (err) {
            alert('注册失败: ' + (err.response?.data?.msg || err.message));
        }
    });

    function logout() {
        state.token = null;
        state.user = {};
        localStorage.removeItem('novi_token');
        localStorage.removeItem('novi_user');
        showAuth();
    }

    // ================= 会话管理 (Sidebar) =================

    async function loadSessions() {
        try {
            const res = await api.get('/sessions');
            const list = document.getElementById('sessionList');
            list.innerHTML = '';

            if (res.data.code === 1) {
                const sessions = res.data.data;
                sessions.forEach(session => {
                    const activeClass = session.id === state.currentSessionId ? 'active' : '';
                    const html = `
                            <div class="session-item ${activeClass}" onclick="selectSession('${session.id}', this)">
                                <div class="d-flex align-items-center overflow-hidden">
                                    <i class="bi bi-chat-left-text me-2 text-muted"></i>
                                    <span class="session-title" id="title-${session.id}">${session.title || '无标题'}</span>
                                </div>
                                <button class="btn btn-link btn-sm text-muted p-0 ms-2" onclick="deleteSession('${session.id}', event)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        `;
                    list.innerHTML += html;
                });
            }
        } catch (err) {
            console.error('加载会话失败', err);
        }
    }

    async function selectSession(sessionId, element) {
        if (state.isLoading) return;
        state.currentSessionId = sessionId;

        // UI 选中状态更新
        document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');

        // 更新标题
        const titleEl = document.getElementById(`title-${sessionId}`);
        document.getElementById('currentChatTitle').textContent = titleEl ? titleEl.innerText : '历史会话';

        // 加载消息记录
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.innerHTML = '<div class="text-center mt-4"><div class="spinner-border text-primary"></div></div>';

        try {
            const res = await api.get(`/sessions/${sessionId}/messages`);
            chatWindow.innerHTML = ''; // 清空Loading
            if (res.data.code === 1) {
                const messages = res.data.data;
                messages.forEach(msg => {
                    renderMessage(msg.role.toLowerCase(), msg.content);
                });
                scrollToBottom();
            }
        } catch (err) {
            chatWindow.innerHTML = `<div class="text-danger text-center">加载失败: ${err.message}</div>`;
        }

        // 移动端自动收起侧边栏
        document.getElementById('sidebar').classList.remove('show');
    }

    function startNewChat() {
        if (state.isLoading) return;
        state.currentSessionId = null;
        document.getElementById('currentChatTitle').textContent = "新会话";
        document.getElementById('chatWindow').innerHTML = `
                <div class="message-row assistant">
                    <div class="avatar avatar-novi"><i class="bi bi-robot"></i></div>
                    <div class="message-bubble assistant markdown-body">
                        开启了一个新会话。有什么我可以帮你的吗？
                    </div>
                </div>
            `;
        document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
        document.getElementById('sidebar').classList.remove('show');
    }

    async function deleteSession(sessionId, event) {
        event.stopPropagation(); // 阻止触发 selectSession
        if (!confirm('确定删除此会话吗？')) return;

        try {
            await api.delete(`/sessions/${sessionId}`);
            if (state.currentSessionId === sessionId) startNewChat();
            loadSessions();
        } catch (err) {
            alert('删除失败');
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
    }

    // ================= 聊天逻辑 (核心) =================

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message || state.isLoading) return;

        // 1. 渲染用户消息
        renderMessage('user', message);
        input.value = '';
        input.style.height = 'auto';
        scrollToBottom();
        state.isLoading = true;
        updateSendButtonState(true);

        // 2. 准备请求数据
        const requestData = {
            message: message,
            sessionId: state.currentSessionId
        };

        // 3. 创建助手空消息泡（等待填充）
        const assistantContentId = 'msg-' + Date.now();
        renderMessage('assistant', '', assistantContentId);
        const assistantBubble = document.getElementById(assistantContentId);

        // 4. 判断模式
        const mode = document.querySelector('input[name="chatMode"]:checked').value;

        try {
            if (mode === 'stream') {
                await handleStreamChat(requestData, assistantBubble);
            } else {
                await handleCallChat(requestData, assistantBubble);
            }
        } catch (err) {
            assistantBubble.innerHTML = `<span class="text-danger">发送失败: ${err.message}</span>`;
        } finally {
            state.isLoading = false;
            updateSendButtonState(false);
        }
    }

    // 处理阻塞式请求
    async function handleCallChat(data, bubbleElement) {
        bubbleElement.innerHTML = '<div class="spinner-dots"><span class="spinner-grow spinner-grow-sm"></span></div>'; // Loading

        const res = await api.post('/chat/send/call', data);

        if (res.data.code === 1) {
            const { response, sessionId, title } = res.data.data;

            // 更新内容
            bubbleElement.innerHTML = marked.parse(response);

            // 更新会话状态
            handleSessionUpdate(sessionId, title);
        } else {
            throw new Error(res.data.msg);
        }
    }

    // 处理流式请求 (Native Fetch for SSE)
    async function handleStreamChat(data, bubbleElement) {
        const response = await fetch(`${API_BASE}/chat/send/stream`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + state.token
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error(response.statusText);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            let lines = buffer.split('\n');
            buffer = lines.pop() || ''; // 保留未完成的行

            for (const line of lines) {
                if (!line.trim()) continue;
                // 移除 SSE 的 "data:" 前缀（如果有）
                const jsonStr = line.startsWith('data:') ? line.slice(5) : line;

                try {
                    const event = JSON.parse(jsonStr);

                    // 根据后端 StreamEvent 类处理
                    if (event.eventType === 'METADATA') {
                        handleSessionUpdate(event.sessionId, event.title);
                    } else if (event.eventType === 'CONTENT') {
                        fullContent += event.content;
                        // 实时渲染 Markdown
                        bubbleElement.innerHTML = marked.parse(fullContent);
                        scrollToBottom();
                    } else if (event.eventType === 'ERROR') {
                        fullContent += `\n\n*[系统错误: ${event.errorMessage}]*`;
                        bubbleElement.innerHTML = marked.parse(fullContent);
                    }
                } catch (e) {
                    console.warn('JSON解析错误', e);
                }
            }
        }
    }

    // ================= UI 辅助方法 =================

    function renderMessage(role, content, elementId = null) {
        const chatWindow = document.getElementById('chatWindow');
        const isUser = role === 'user';

        const div = document.createElement('div');
        div.className = `message-row ${isUser ? 'user' : 'assistant'}`;

        let html = '';
        if (!isUser) html += `<div class="avatar avatar-novi"><i class="bi bi-robot"></i></div>`;

        html += `
                <div class="message-bubble ${isUser ? 'user' : 'assistant'} markdown-body" ${elementId ? `id="${elementId}"` : ''}>
                    ${content ? marked.parse(content) : ''}
                </div>
            `;

        if (isUser) html += `<div class="avatar avatar-user"><i class="bi bi-person"></i></div>`;

        div.innerHTML = html;
        chatWindow.appendChild(div);
    }

    function handleSessionUpdate(sessionId, title) {
        const isNewSession = state.currentSessionId === null;
        state.currentSessionId = sessionId;

        if (title) {
            document.getElementById('currentChatTitle').textContent = title;
        }

        // 如果是新会话或标题改变，重新加载侧边栏
        if (isNewSession || title) {
            loadSessions().then(() => {
                // 保持高亮
                setTimeout(() => {
                    document.querySelectorAll('.session-item').forEach(el => {
                        if(el.onclick.toString().includes(sessionId)) el.classList.add('active');
                    });
                }, 100);
            });
        }
    }

    function scrollToBottom() {
        const win = document.getElementById('chatWindow');
        win.scrollTop = win.scrollHeight;
    }

    function updateSendButtonState(loading) {
        const btn = document.getElementById('sendBtn');
        if (loading) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-send-fill"></i>';
        }
    }
</script>
</body>
</html>