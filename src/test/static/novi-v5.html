<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Novi · AI 挚友 & 智能出题</title>
    <!-- 引入外部库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.css">

    <style>
        /* ================= 1. 核心变量 ================= */
        :root {
            --primary-color: #4e6ef2;
            --bg-body: #f2f4f7;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-input: #ffffff;
            --bg-input-focus: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #666666;
            --border-color: #e5e7eb;
            --border-input: #e5e7eb;

            --bubble-user-bg: #95ec69;
            --bubble-user-text: #000000;
            --bubble-ai-bg: #ffffff;
            --bubble-ai-text: #1f1f1f;

            --sidebar-width: 280px;
            --sidebar-width-collapsed: 76px;
            --toast-top-mobile: 80px;
        }

        [data-bs-theme="dark"] {
            --bg-body: #111111;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-header: #1e1e1e;
            --bg-input: #2c2c2c;
            --bg-input-focus: #333333;
            --text-main: #e3e3e3;
            --text-sub: #aaaaaa;
            --border-color: #333333;
            --border-input: #444444;

            --bubble-user-bg: #2b7c38;
            --bubble-user-text: #e3e3e3;
            --bubble-ai-bg: #2c2c2c;
            --bubble-ai-text: #e3e3e3;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-body);
            font-family: -apple-system, "Noto Sans SC", "Microsoft YaHei", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: background-color 0.3s;
            color: var(--text-main);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            color: var(--text-main);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-input-focus);
            border-color: var(--primary-color);
            color: var(--text-main);
            box-shadow: 0 0 0 3px rgba(78, 110, 242, 0.25);
        }

        .view-container {
            width: 100%;
            height: 100%;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: flex !important;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================= 认证视图样式 ================= */
        #auth-view {
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            background-color: var(--bg-sidebar);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .auth-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .auth-form-wrapper {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .auth-form-wrapper.fading {
            opacity: 0;
        }

        .auth-tabs-container {
            position: relative;
            background-color: var(--bg-body);
            border-radius: 50px;
            padding: 4px;
            display: flex;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .auth-tab-bg {
            position: absolute;
            top: 4px;
            left: 4px;
            bottom: 4px;
            width: calc(50% - 4px);
            background-color: var(--bg-card);
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .auth-tabs-container.register-mode .auth-tab-bg {
            transform: translateX(100%);
        }

        .auth-tab-btn {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            z-index: 2;
            transition: color 0.2s;
            background: none;
            border: none;
        }

        .auth-tab-btn.active {
            color: var(--primary-color);
        }

        .password-group .input-group-text {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            border-left: none;
            color: var(--text-sub);
            cursor: pointer;
        }

        .password-group .form-control {
            border-right: none;
        }

        /* ================= 布局与侧边栏 ================= */
        #chat-view,
        #exam-view {
            flex-direction: row;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.3s ease, transform 0.3s ease;
            flex-shrink: 0;
            height: 100%;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-body);
            position: relative;
            transition: transform 0.3s ease;
            z-index: 50;
            height: 100%;
            overflow: hidden;
        }

        @media (min-width: 769px) {

            #chat-view.sidebar-collapsed .sidebar,
            #exam-view.sidebar-collapsed .sidebar {
                width: var(--sidebar-width-collapsed);
            }

            .sidebar-collapsed .sidebar .text-label,
            .sidebar-collapsed .sidebar #sessionList,
            .sidebar-collapsed .sidebar #examHistoryList {
                display: none !important;
            }

            .sidebar-collapsed .sidebar .btn-new-chat {
                padding: 0;
                justify-content: center;
            }

            .sidebar-collapsed .sidebar .btn-new-chat i {
                margin-right: 0 !important;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn {
                justify-content: center;
                padding: 0.5rem 0;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn .avatar {
                margin: 0 !important;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn i.bi-three-dots-vertical {
                display: none;
            }

            .sidebar-collapsed .sidebar .dropdown-menu {
                position: fixed;
                left: calc(var(--sidebar-width-collapsed) + 10px);
                bottom: 70px;
                top: auto;
                width: 200px;
                z-index: 1050;
            }
        }

        .sidebar-toggle-btn {
            background-color: transparent !important;
            color: var(--text-sub);
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            color: var(--text-main);
        }

        [data-bs-theme="dark"] .sidebar-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                border-right: none;
                box-shadow: none;
                width: var(--sidebar-width) !important;
            }

            .sidebar-open .sidebar {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
            }

            .sidebar-open .chat-main::after {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .sidebar .text-label,
            .sidebar #sessionList,
            .sidebar #examHistoryList {
                display: block !important;
            }
        }

        /* 模式切换导航 */
        .mode-nav {
            padding: 0 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .mode-nav-btn {
            border: none;
            background: transparent;
            padding: 10px;
            border-radius: 12px;
            text-align: left;
            color: var(--text-sub);
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .mode-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
        }

        .mode-nav-btn.active {
            background-color: rgba(78, 110, 242, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        .mode-nav-btn i {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        /* ================= 聊天窗口 ================= */
        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem;
            scroll-behavior: auto;
        }

        .chat-container {
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
        }

        .message-row {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .message-row.assistant .avatar {
            margin-right: 12px;
        }

        .message-row.user .avatar {
            margin-left: 12px;
            order: 2;
        }

        .avatar-ai {
            background: #fff;
            color: var(--primary-color);
        }

        .avatar-user {
            background: var(--primary-color);
            color: #fff;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .message-bubble.assistant {
            background: var(--bubble-ai-bg);
            color: var(--bubble-ai-text);
        }

        .message-bubble.user {
            background: var(--bubble-user-bg);
            color: var(--bubble-user-text) !important;
            order: 1;
        }

        .message-bubble.user * {
            color: inherit !important;
            margin-bottom: 0;
        }

        /* 输入区域 */
        .chat-input-area {
            background-color: var(--bg-body);
            padding: 0 1rem 1.5rem 1rem;
            position: relative;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .input-wrapper {
            width: 100%;
            max-width: 850px;
            background-color: var(--bg-input);
            border-radius: 24px;
            position: relative;
            border: 1px solid transparent;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper:focus-within {
            background-color: var(--bg-input-focus);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #messageInput {
            background: transparent;
            border: none;
            resize: none;
            overflow-y: hidden;
            min-height: 56px;
            max-height: 200px;
            padding: 16px 50px 16px 20px;
            width: 100%;
            border-radius: 24px;
            font-size: 1rem;
            line-height: 1.5;
        }

        #messageInput:focus {
            box-shadow: none;
            outline: none;
        }

        #fullScreenBtn {
            position: absolute;
            top: 12px;
            right: 16px;
            z-index: 5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-sub);
            background: transparent;
            border: none;
            transition: opacity 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        #fullScreenBtn.show {
            opacity: 1;
            pointer-events: auto;
        }

        #fullScreenBtn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #sendBtn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            transition: all 0.2s;
            z-index: 6;
        }

        #sendBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(78, 110, 242, 0.4);
        }

        /* 会话列表项 */
        .session-item {
            padding: 10px 16px;
            margin: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
            transition: background 0.2s;
            min-height: 44px;
            font-size: 0.9rem;
            position: relative;
        }

        .session-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* 优化深色模式 Hover 效果 */
        [data-bs-theme="dark"] .session-item:hover {
            background-color: rgba(255, 255, 255, 0.12) !important;
        }

        .session-item.active {
            background-color: rgba(78, 110, 242, 0.1);
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        .session-item.active .text-muted {
            color: var(--primary-color) !important;
        }

        /* Markdown */
        .markdown-body {
            background-color: transparent !important;
            font-family: inherit !important;
            color: inherit !important;
        }

        .markdown-body pre {
            background-color: rgba(0, 0, 0, 0.05) !important;
            border-radius: 8px;
        }

        [data-bs-theme="dark"] .markdown-body pre {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        .markdown-body p {
            margin-bottom: 0.5rem;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }

        .custom-toast {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-radius: 12px;
            animation: slideInRight 0.3s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .custom-toast.hiding {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* ================= 设置视图 ================= */
        #settings-view {
            background-color: var(--bg-body);
            overflow-y: auto;
        }

        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: none;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            margin-bottom: 2rem;
        }

        .nav-pills-settings .nav-link {
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .nav-pills-settings .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .nav-pills-settings .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: bold;
        }

        .persona-card {
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--bg-input);
            height: 100%;
            text-align: center;
            position: relative;
        }

        .persona-card:hover {
            transform: translateY(-2px);
            background-color: var(--bg-input-focus);
            border-color: var(--primary-color);
        }

        .persona-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(78, 110, 242, 0.05);
        }

        .persona-card.selected::after {
            content: '\F26E';
            font-family: 'bootstrap-icons';
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--primary-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.4);
        }

        /* ================= 出题模式样式 ================= */
        .exam-container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .exam-config-panel {
            width: 320px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .exam-preview-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-body);
            position: relative;
        }

        .paper-card {
            background-color: var(--bg-card);
            max-width: 800px;
            margin: 0 auto;
            min-height: 1100px;
            padding: 60px 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 2px;
            color: var(--text-main);
            font-family: "Times New Roman", "SimSun", serif;
        }

        .paper-title {
            text-align: center;
            font-weight: bold;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-family: "SimHei", sans-serif;
        }

        .paper-subtitle {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: var(--text-sub);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1.5rem;
            line-height: 1.6;
        }

        .question-content {
            font-size: 1.15rem;
            line-height: 2;
            text-align: justify;
            margin-bottom: 1rem;
        }

        /* 优化后的填空样式: 纯字符占位，无边框 */
        .blank-space {
            display: inline;
            font-family: "Courier New", monospace;
            color: var(--text-main);
            margin: 0 2px;
            font-weight: bold;
        }

        .exam-meta-tag {
            font-size: 0.9rem;
            padding: 4px 10px;
            background: rgba(78, 110, 242, 0.08);
            color: var(--primary-color);
            border-radius: 4px;
            display: inline-block;
            margin: 0 5px;
            font-family: sans-serif;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        [data-bs-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        /* 批量操作工具栏 */
        .exam-batch-bar {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border-color);
            padding: 10px 16px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .exam-batch-bar.show {
            display: flex;
        }

        @media (max-width: 992px) {
            .exam-container {
                flex-direction: column;
                overflow-y: auto;
            }

            .exam-config-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                height: auto;
            }

            .exam-preview-panel {
                height: auto;
                overflow: visible;
            }

            .paper-card {
                padding: 30px;
            }
        }
    </style>
</head>

<body>

    <!-- 全屏输入模态框 -->
    <div class="modal fade" id="fullScreenInputModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: var(--bg-body);">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold">沉浸式编辑</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="container h-100 py-4">
                        <textarea id="fullScreenTextarea" class="form-control border-0 h-100 shadow-none"
                            style="font-size: 1.1rem; background: transparent; resize: none;"
                            placeholder="在这里尽情输入..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4"
                        onclick="ui.submitFullScreenInput()">完成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局提示与确认框 -->
    <div class="toast-container" id="toastContainer"></div>
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content p-3 rounded-4" style="background: var(--bg-card); color: var(--text-main);">
                <div class="modal-body text-center">
                    <h5 class="fw-bold mb-3">确认</h5>
                    <p class="text-muted small mb-4" id="confirmMessage"></p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4" id="confirmBtnAction">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 侧边栏设置菜单 (移动端) -->
    <div class="offcanvas offcanvas-end rounded-start-4" tabindex="-1" id="settingsOffcanvas"
        style="background: var(--bg-card); color: var(--text-main);">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold">设置</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="nav flex-column nav-pills nav-pills-settings gap-2" id="mobileSettingsTabs"></div>
        </div>
    </div>

    <!-- 1. 认证视图 -->
    <div id="auth-view" class="view-container active">
        <div class="auth-card" id="authCard">
            <div class="auth-header">
                <h2 class="fw-bold mb-2" style="color: var(--primary-color);">Novi</h2>
                <p class="text-muted">AI 挚友 · 懂你所想</p>
            </div>
            <div class="auth-tabs-container" id="authTabs">
                <div class="auth-tab-bg"></div>
                <button class="auth-tab-btn active" onclick="ui.switchAuthTab('login')">登录</button>
                <button class="auth-tab-btn" onclick="ui.switchAuthTab('register')">注册</button>
            </div>
            <div id="loginFormWrapper" class="auth-form-wrapper">
                <form id="loginForm">
                    <div class="mb-3"><input type="text" class="form-control rounded-3 px-3 py-2" id="loginUser"
                            placeholder="用户名" required></div>
                    <div class="mb-4">
                        <div class="input-group password-group">
                            <input type="password" class="form-control rounded-start-3 px-3 py-2" id="loginPass"
                                placeholder="密码" required>
                            <span class="input-group-text rounded-end-3"
                                onclick="ui.togglePassword('loginPass', this)"><i class="bi bi-eye-slash"></i></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">进入</button>
                </form>
            </div>
            <div id="registerFormWrapper" class="auth-form-wrapper d-none">
                <form id="registerForm">
                    <div class="mb-2"><input type="text" class="form-control rounded-3" id="regUser" placeholder="用户名"
                            required></div>
                    <div class="mb-2"><input type="text" class="form-control rounded-3" id="regNick" placeholder="昵称"
                            required></div>
                    <div class="mb-2"><input type="email" class="form-control rounded-3" id="regEmail" placeholder="邮箱"
                            required></div>
                    <div class="mb-4">
                        <div class="input-group password-group">
                            <input type="password" class="form-control rounded-start-3" id="regPass" placeholder="密码"
                                required>
                            <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('regPass', this)"><i
                                    class="bi bi-eye-slash"></i></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 shadow-sm">注册</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 侧边栏模板 -->
    <template id="sidebar-template">
        <aside class="sidebar" id="sidebar">
            <div class="p-3 d-flex justify-content-between align-items-center flex-shrink-0">
                <button class="btn rounded-pill text-muted border-0 sidebar-toggle-btn"
                    onclick="ui.handleSidebarToggle()">
                    <i class="bi bi-list fs-5"></i>
                </button>
                <span class="fw-bold ms-2 text-label" style="white-space: nowrap;">功能导航</span>
                <div class="ms-auto"></div>
            </div>

            <!-- 功能切换区 -->
            <div class="mode-nav mt-2 flex-shrink-0">
                <button class="mode-nav-btn active" id="nav-btn-chat" onclick="app.switchMode('chat')">
                    <i class="bi bi-chat-text"></i>
                    <span class="text-label">智能对话</span>
                </button>
                <button class="mode-nav-btn" id="nav-btn-exam" onclick="app.switchMode('exam')">
                    <i class="bi bi-file-earmark-text"></i>
                    <span class="text-label">AI 出题</span>
                </button>
            </div>

            <hr class="mx-3 my-2 flex-shrink-0" style="border-color: var(--border-color);">

            <!-- 聊天模式侧边栏内容 -->
            <div id="sidebar-chat-elements" class="d-flex flex-column flex-grow-1 overflow-hidden"
                style="min-height: 0;">
                <div class="px-3 mb-3 mt-2 flex-shrink-0">
                    <button
                        class="btn btn-primary w-100 rounded-pill py-2 shadow-sm btn-new-chat d-flex align-items-center justify-content-center"
                        onclick="app.startNewChat()">
                        <i class="bi bi-plus-lg me-2"></i>
                        <span class="text-label">新对话</span>
                    </button>
                </div>
                <div class="px-3 mb-2 small text-muted text-label fw-bold flex-shrink-0">历史记录</div>
                <div class="flex-grow-1 overflow-auto px-2" id="sessionList"></div>
            </div>

            <!-- 出题模式侧边栏内容 -->
            <div id="sidebar-exam-elements" class="d-none flex-column flex-grow-1 overflow-hidden"
                style="min-height: 0; position: relative;">
                <div
                    class="px-3 mb-2 mt-2 small text-muted text-label fw-bold flex-shrink-0 d-flex justify-content-between align-items-center">
                    <span>生成历史</span>
                    <button class="btn btn-link btn-sm p-0 text-muted text-decoration-none"
                        onclick="exam.toggleEditMode()" style="font-size: 0.85rem;" id="btnEditHistory">
                        管理
                    </button>
                </div>
                <div class="flex-grow-1 overflow-auto px-2" id="examHistoryList">
                    <div class="text-center text-muted small mt-4 p-3">暂无生成记录</div>
                </div>
                <!-- 批量删除操作栏 -->
                <div class="exam-batch-bar" id="examBatchBar">
                    <div class="form-check ms-2">
                        <input class="form-check-input" type="checkbox" id="selectAllHistory"
                            onchange="exam.toggleSelectAll(this)">
                        <label class="form-check-label small text-muted" for="selectAllHistory">全选</label>
                    </div>
                    <button class="btn btn-danger btn-sm rounded-pill px-3" onclick="exam.deleteSelected()">
                        删除
                    </button>
                </div>
            </div>

            <div class="mt-auto p-3 border-top flex-shrink-0">
                <div class="dropdown dropup w-100" id="userDropdownContainer">
                    <button
                        class="btn w-100 d-flex align-items-center p-2 rounded hover-bg text-start border-0 user-dropdown-btn"
                        data-bs-toggle="dropdown" style="color: var(--text-main);">
                        <div class="avatar avatar-user me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">U
                        </div>
                        <div class="flex-grow-1 overflow-hidden text-label">
                            <div class="fw-bold text-truncate" id="userNickDisplay">User</div>
                        </div>
                        <i class="bi bi-three-dots-vertical text-muted"></i>
                    </button>
                    <ul class="dropdown-menu shadow-lg border-0 rounded-4 mb-2">
                        <li><a class="dropdown-item py-2" href="#" onclick="ui.navigateTo('settings-view')"><i
                                    class="bi bi-gear me-2"></i>设置</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger py-2" href="#" onclick="app.logout()"><i
                                    class="bi bi-box-arrow-right me-2"></i>退出</a></li>
                    </ul>
                </div>
            </div>
        </aside>
    </template>

    <!-- 2. 聊天视图 -->
    <div id="chat-view" class="view-container">
        <!-- Sidebar 会被动态插入到这里 -->
        <main class="chat-main" onclick="ui.handleMainClick(event)">
            <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3"
                style="background: var(--bg-header);">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);"
                        onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                    <h6 class="mb-0 fw-bold" id="currentTitle" style="color: var(--text-main);">Novi AI</h6>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0" title="深色模式">
                        <input class="form-check-input theme-switcher" type="checkbox" id="themeSwitchChat"
                            onchange="ui.toggleTheme(this)">
                        <label class="form-check-label" for="themeSwitchChat"><i class="bi bi-moon-stars"
                                style="color: var(--text-main);"></i></label>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <input type="radio" class="btn-check" name="apiMode" id="modeStream" value="stream" checked>
                        <label class="btn btn-outline-secondary" for="modeStream">流式</label>
                        <input type="radio" class="btn-check" name="apiMode" id="modeCall" value="call">
                        <label class="btn btn-outline-secondary" for="modeCall">普通</label>
                    </div>
                </div>
            </header>

            <div class="chat-window" id="chatWindow">
                <div class="chat-container" id="chatContainer">
                    <div class="text-center mt-5 pt-5">
                        <div class="avatar avatar-ai mx-auto mb-3"
                            style="width: 64px; height: 64px; font-size: 2rem; border: none; background: transparent;">
                            <i class="bi bi-stars text-primary"></i>
                        </div>
                        <h3 class="fw-bold" style="color: var(--text-main);">你好，我是 Novi</h3>
                        <p style="color: var(--text-sub);">我可以帮你写代码、做计划，或者仅仅聊聊天。</p>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <textarea id="messageInput" class="form-control" rows="1" placeholder="输入消息..."></textarea>
                    <button id="fullScreenBtn" onclick="ui.openFullScreenInput()" title="全屏编辑"><i
                            class="bi bi-arrows-angle-expand"></i></button>
                    <button id="sendBtn" onclick="app.sendMessage()" title="发送消息"><i
                            class="bi bi-send-fill"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- 3. AI 出题视图 -->
    <div id="exam-view" class="view-container">
        <!-- Sidebar 会被动态插入到这里 -->
        <main class="chat-main">
            <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3 border-bottom"
                style="background: var(--bg-header);">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);"
                        onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                    <h6 class="mb-0 fw-bold" style="color: var(--text-main);">AI 智能出题助手</h6>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <!-- 新增：出题页面的深色模式开关 -->
                    <div class="form-check form-switch mb-0" title="深色模式">
                        <input class="form-check-input theme-switcher" type="checkbox" id="themeSwitchExam"
                            onchange="ui.toggleTheme(this)">
                        <label class="form-check-label" for="themeSwitchExam"><i class="bi bi-moon-stars"
                                style="color: var(--text-main);"></i></label>
                    </div>
                    <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="exam.reset()">
                        <i class="bi bi-arrow-clockwise me-1"></i> 重置
                    </button>
                </div>
            </header>

            <div class="exam-container">
                <!-- 左侧：配置面板 -->
                <div class="exam-config-panel">
                    <h5 class="fw-bold mb-4">出题配置</h5>
                    <form id="examForm" onsubmit="exam.generate(event)">
                        <!-- 新增：模型选择 -->
                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examModel" aria-label="选择模型">
                                <option value="doubao-seed-1-6-flash-250828" selected>豆包 (Doubao)</option>
                                <option value="deepseek-r1-0528">DeepSeek-R1</option>
                            </select>
                            <label for="examModel">AI 模型</label>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examSubject" aria-label="选择科目">
                                <option value="湖北专升本英语" selected>湖北专升本英语</option>
                            </select>
                            <label for="examSubject">选择科目</label>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examType" aria-label="题型">
                                <!-- 显示为"完形填空"，但值传"语法填空"以匹配后端示例库 -->
                                <option value="语法填空">完形填空</option>
                            </select>
                            <label for="examType">题型</label>
                        </div>

                        <!-- 自定义主题始终显示 -->
                        <div class="form-floating mb-4" id="customTopicDiv">
                            <input type="text" class="form-control rounded-3" id="examTopic" placeholder="例如：科技、文化">
                            <label for="examTopic">自定义主题 (可选)</label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold text-muted">难度系数</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="examDifficulty" id="diffEasy" value="simple"
                                    autocomplete="off">
                                <label class="btn btn-outline-secondary" for="diffEasy">简单</label>

                                <input type="radio" class="btn-check" name="examDifficulty" id="diffMedium"
                                    value="medium" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary" for="diffMedium">标准</label>

                                <input type="radio" class="btn-check" name="examDifficulty" id="diffHard" value="hard"
                                    autocomplete="off">
                                <label class="btn btn-outline-secondary" for="diffHard">困难</label>
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label small fw-bold text-muted">题目数量</label>
                            <input type="number" class="form-control rounded-3" id="examQuantity" value="1" min="1"
                                max="5">
                        </div>

                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm mb-3">
                            <i class="bi bi-magic me-2"></i>生成试题
                        </button>
                    </form>
                </div>

                <!-- 右侧：预览面板 -->
                <div class="exam-preview-panel">
                    <div id="paperLoading" class="loading-overlay d-none">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h5 class="fw-bold">AI 正在根据考纲出题中...</h5>
                            <p class="text-muted small">分析考点 · 组织文本 · 生成解析</p>
                        </div>
                    </div>

                    <div id="paperEmpty"
                        class="h-100 d-flex flex-direction-column align-items-center justify-content-center text-center text-muted">
                        <div>
                            <i class="bi bi-file-earmark-text display-1 opacity-25"></i>
                            <p class="mt-3">在左侧配置参数后点击生成</p>
                        </div>
                    </div>

                    <div id="paperContent" class="d-none">
                        <div class="d-flex justify-content-end mb-3 gap-2">
                            <div class="form-check form-switch pt-2">
                                <input class="form-check-input" type="checkbox" id="showAnswersSwitch"
                                    onchange="exam.toggleAnswers()">
                                <label class="form-check-label" for="showAnswersSwitch">显示解析</label>
                            </div>
                            <button class="btn btn-success rounded-pill px-4" onclick="exam.exportWord()">
                                <i class="bi bi-file-word me-1"></i> 导出 Word
                            </button>
                        </div>

                        <div class="paper-card" id="paperExportArea">
                            <div class="paper-title" id="paperTitleText">AI 智能生成试卷</div>
                            <div id="paperSubtitleContainer" class="paper-subtitle d-none"></div>
                            <div class="text-center mb-4">
                                <span class="exam-meta-tag" id="tagSubject">科目：英语</span>
                                <span class="exam-meta-tag" id="tagType">题型：语法填空</span>
                                <span class="exam-meta-tag" id="tagDiff">难度：标准</span>
                            </div>

                            <div id="paperBody">
                                <!-- JS 渲染内容 -->
                            </div>

                            <div id="paperAnswers" class="mt-5 pt-4 border-top d-none">
                                <h5 class="fw-bold mb-3">参考答案与解析</h5>
                                <div id="answersBody"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 4. 设置视图 -->
    <div id="settings-view" class="view-container">
        <div class="settings-container">
            <div class="mb-4 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <button class="btn btn-icon rounded-circle me-3 hover-bg" onclick="ui.navigateTo('chat-view')"
                        style="width:40px;height:40px;background:var(--bg-input);color:var(--text-main);"><i
                            class="bi bi-arrow-left"></i></button>
                    <h4 class="fw-bold mb-0">设置</h4>
                </div>
                <button class="btn btn-outline-secondary border-0 d-lg-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#settingsOffcanvas">
                    <i class="bi bi-list fs-4"></i>
                </button>
            </div>
            <div class="row g-4">
                <div class="col-lg-3 d-none d-lg-block">
                    <nav class="nav flex-column nav-pills nav-pills-settings" id="settingsDesktopNav">
                        <button class="nav-link active text-start mb-2" data-bs-toggle="pill"
                            data-bs-target="#tab-profile" onclick="ui.syncMobileNav('tab-profile')"><i
                                class="bi bi-person me-2"></i>个人资料</button>
                        <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#tab-persona"
                            onclick="ui.syncMobileNav('tab-persona')"><i class="bi bi-magic me-2"></i>AI 设定</button>
                        <button class="nav-link text-start text-danger mt-4" onclick="app.logout()"><i
                                class="bi bi-box-arrow-left me-2"></i>退出登录</button>
                    </nav>
                </div>
                <div class="col-lg-9">
                    <div class="tab-content" id="settingsTabContent">
                        <div class="tab-pane fade show active" id="tab-profile">
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">个人信息</h5>
                                <form id="profileForm">
                                    <div class="row g-3">
                                        <div class="col-md-6"><label
                                                class="form-label small fw-bold text-muted">用户名</label><input
                                                type="text" class="form-control rounded-3" id="pfUsername" disabled>
                                        </div>
                                        <div class="col-md-6"><label
                                                class="form-label small fw-bold text-muted">昵称</label><input type="text"
                                                class="form-control rounded-3" id="pfNickname"></div>
                                        <div class="col-12"><label
                                                class="form-label small fw-bold text-muted">邮箱</label><input
                                                type="email" class="form-control rounded-3" id="pfEmail"></div>
                                    </div>
                                    <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4"
                                            type="button" onclick="app.saveProfile()">保存更改</button></div>
                                </form>
                            </div>
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4 text-danger">安全设置</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">新密码</label>
                                        <div class="input-group password-group">
                                            <input type="password" class="form-control rounded-start-3" id="pfNewPass"
                                                placeholder="如不修改请留空">
                                            <span class="input-group-text rounded-end-3"
                                                onclick="ui.togglePassword('pfNewPass', this)"><i
                                                    class="bi bi-eye-slash"></i></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">当前密码</label>
                                        <div class="input-group password-group">
                                            <input type="password" class="form-control rounded-start-3"
                                                id="pfCurrentPass" placeholder="修改密码需验证">
                                            <span class="input-group-text rounded-end-3"
                                                onclick="ui.togglePassword('pfCurrentPass', this)"><i
                                                    class="bi bi-eye-slash"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 text-end"><button class="btn btn-outline-danger rounded-pill px-4"
                                        type="button" onclick="app.saveProfile()">修改密码</button></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-persona">
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">核心性格</h5>
                                <div class="row row-cols-2 row-cols-lg-3 g-3 mb-4" id="personalityGrid"></div>
                                <div class="mt-3 d-none" id="customPersonaInputDiv">
                                    <label class="form-label small fw-bold text-muted">自定义 Prompt</label>
                                    <textarea class="form-control rounded-3" id="psCustomPersona" rows="3"
                                        placeholder="输入你想要的 Prompt..."></textarea>
                                </div>
                            </div>
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">交互偏好</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">回复风格</label>
                                        <select class="form-select rounded-3" id="psTone">
                                            <option value="normal">默认</option>
                                            <option value="emoji_heavy">✨ 活泼</option>
                                            <option value="concise">简洁</option>
                                            <option value="verbose">详细</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">语言</label>
                                        <select class="form-select rounded-3" id="psLanguage">
                                            <option value="">自动</option>
                                            <option value="zh_CN">中文</option>
                                            <option value="en_US">English</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-muted">如何称呼你</label>
                                        <input type="text" class="form-control rounded-3" id="psAddressName">
                                    </div>
                                </div>
                                <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4"
                                        onclick="app.savePreferences()">应用设置</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal fade" id="onboardingModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-5 border-0 shadow-lg rounded-5"
                style="background-color: var(--bg-card); color: var(--text-main);">
                <div class="mb-4">
                    <div class="avatar avatar-ai mx-auto"
                        style="width: 80px; height: 80px; font-size: 3rem; background: transparent;"><i
                            class="bi bi-stars text-primary"></i></div>
                </div>
                <h2 class="fw-bold mb-3">欢迎来到 Novi</h2>
                <p class="text-muted mb-5">初次见面，请选择你喜欢的 AI 性格</p>
                <div class="text-start mb-4">
                    <label class="form-label fw-bold small text-muted">性格偏好</label>
                    <select class="form-select form-select-lg rounded-3" id="obPersonality">
                        <option value="default">标准 (平衡理智)</option>
                        <option value="witty">幽默 (风趣好玩)</option>
                        <option value="gentle">温柔 (治愈系)</option>
                        <option value="professional">专业 (严谨学术)</option>
                        <option value="tsundere">傲娇 (哼，勉为其难)</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5"
                    onclick="app.submitOnboarding()">开启旅程</button>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        const PERSONALITY_OPTIONS = [
            { id: 'default', icon: 'bi-emoji-smile', title: '标准', desc: '平衡、理智' },
            { id: 'witty', icon: 'bi-emoji-laughing', title: '幽默', desc: '风趣好玩' },
            { id: 'gentle', icon: 'bi-flower1', title: '温柔', desc: '知心、治愈' },
            { id: 'professional', icon: 'bi-briefcase', title: '专家', desc: '严谨、学术' },
            { id: 'tsundere', icon: 'bi-lightning', title: '傲娇', desc: '口是心非' },
            { id: 'custom', icon: 'bi-pencil-square', title: '自定义', desc: '完全由你决定' }
        ];

        marked.use({ breaks: true, gfm: true });

        // 打字机效果
        const Typewriter = {
            queue: [], element: null, isTyping: false, timer: null, chatWindow: null, fullText: "",
            start(element) { this.element = element; this.queue = []; this.fullText = ""; this.isTyping = true; this.chatWindow = document.getElementById('chatWindow'); this.processQueue(); },
            push(text) { this.queue.push(...text.split('')); if (!this.isTyping) this.processQueue(); },
            stop() {
                this.isTyping = false; clearTimeout(this.timer);
                if (this.queue.length > 0) { this.fullText += this.queue.join(''); this.queue = []; }
                if (this.element) this.render(this.fullText || (this.element.dataset.raw || ''));
            },
            processQueue() {
                if (this.queue.length === 0) { if (!this.isTyping) return; this.timer = setTimeout(() => this.processQueue(), 50); return; }
                const speed = this.queue.length > 50 ? 5 : (this.queue.length > 20 ? 15 : 30);
                let chunk = ''; for (let i = 0; i < (this.queue.length > 100 ? 10 : 2) && this.queue.length > 0; i++) chunk += this.queue.shift();
                this.fullText += chunk; this.render(this.fullText); this.timer = setTimeout(() => this.processQueue(), speed);
            },
            render(rawText) {
                if (!this.element) return; this.element.dataset.raw = rawText; this.element.innerHTML = marked.parse(rawText);
                const win = this.chatWindow; if (!win) return;
                if (win.scrollHeight - win.scrollTop - win.clientHeight < 150) win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
            }
        };

        const ui = {
            confirmModal: null, offcanvas: null, confirmCallback: null, fullScreenModal: null, lastToastTime: 0,

            init() {
                this.confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                this.offcanvas = new bootstrap.Offcanvas(document.getElementById('settingsOffcanvas'));
                this.fullScreenModal = new bootstrap.Modal(document.getElementById('fullScreenInputModal'));

                document.getElementById('confirmBtnAction').addEventListener('click', () => { if (this.confirmCallback) this.confirmCallback(); this.confirmModal.hide(); });
                this.renderPersonalityGrid();
                this.initMobileSettingsNav();
                this.renderSidebar();

                const msgInput = document.getElementById('messageInput');
                const fsBtn = document.getElementById('fullScreenBtn');
                if (msgInput) {
                    msgInput.addEventListener('input', function () {
                        this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; if (this.value === '') this.style.height = '56px';
                        if (this.scrollHeight > 90) fsBtn.classList.add('show'); else fsBtn.classList.remove('show');
                    });
                    msgInput.style.height = '56px';
                }
            },

            // 渲染侧边栏（同时注入到 Chat 和 Exam 视图）
            renderSidebar() {
                const tpl = document.getElementById('sidebar-template').content;
                const chatSide = document.querySelector('#chat-view');
                if (chatSide && !chatSide.querySelector('.sidebar')) chatSide.prepend(tpl.cloneNode(true));
                const examSide = document.querySelector('#exam-view');
                if (examSide && !examSide.querySelector('.sidebar')) examSide.prepend(tpl.cloneNode(true));
            },

            // 更新侧边栏状态（根据当前模式显示不同内容）
            updateSidebarState(mode) {
                document.querySelectorAll('.mode-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll(`#nav-btn-${mode}`).forEach(btn => btn.classList.add('active'));
                // 切换侧边栏列表内容
                const showId = `sidebar-${mode}-elements`;
                document.querySelectorAll(`[id^="sidebar-"][id$="-elements"]`).forEach(el => el.classList.add('d-none'));
                document.querySelectorAll(`#${showId}`).forEach(el => {
                    el.classList.remove('d-none');
                    el.classList.add('d-flex');
                });
            },

            togglePassword(inputId, btn) {
                const input = document.getElementById(inputId); const icon = btn.querySelector('i');
                if (input.type === 'password') { input.type = 'text'; icon.classList.replace('bi-eye-slash', 'bi-eye'); } else { input.type = 'password'; icon.classList.replace('bi-eye', 'bi-eye-slash'); }
            },
            openFullScreenInput() { document.getElementById('fullScreenTextarea').value = document.getElementById('messageInput').value; this.fullScreenModal.show(); },
            submitFullScreenInput() { const mainInput = document.getElementById('messageInput'); mainInput.value = document.getElementById('fullScreenTextarea').value; mainInput.dispatchEvent(new Event('input')); this.fullScreenModal.hide(); mainInput.focus(); },
            initMobileSettingsNav() {
                const desktopNav = document.getElementById('settingsDesktopNav'); const mobileNav = document.getElementById('mobileSettingsTabs');
                mobileNav.innerHTML = desktopNav.innerHTML;
                mobileNav.querySelectorAll('.nav-link').forEach(btn => {
                    if (btn.getAttribute('onclick').includes('logout')) return;
                    btn.addEventListener('click', (e) => { this.syncMobileNav(e.currentTarget.getAttribute('data-bs-target').replace('#', '')); this.offcanvas.hide(); });
                });
            },
            syncMobileNav(targetId) { const triggerEl = document.querySelector(`#settingsDesktopNav button[data-bs-target="#${targetId}"]`); bootstrap.Tab.getInstance(triggerEl).show(); },

            navigateTo(viewId) {
                document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if (viewId === 'settings-view') { app.loadProfile(); app.loadPreferences(); }
            },

            switchAuthTab(tab) {
                const loginWrapper = document.getElementById('loginFormWrapper'); const regWrapper = document.getElementById('registerFormWrapper');
                const tabsContainer = document.getElementById('authTabs'); const btns = tabsContainer.querySelectorAll('.auth-tab-btn'); const card = document.getElementById('authCard');
                if (tab === 'register') { tabsContainer.classList.add('register-mode'); btns[0].classList.remove('active'); btns[1].classList.add('active'); } else { tabsContainer.classList.remove('register-mode'); btns[0].classList.add('active'); btns[1].classList.remove('active'); }
                card.style.height = card.offsetHeight + 'px';
                const activeWrapper = tab === 'login' ? regWrapper : loginWrapper; const nextWrapper = tab === 'login' ? loginWrapper : regWrapper;
                activeWrapper.classList.add('fading');
                setTimeout(() => { activeWrapper.classList.add('d-none'); nextWrapper.classList.remove('d-none'); nextWrapper.classList.add('fading'); card.style.height = 'auto'; nextWrapper.classList.remove('fading'); }, 200);
            },

            toggleSidebar(e) { if (e) e.stopPropagation(); document.querySelectorAll('.view-container.active').forEach(el => el.classList.toggle('sidebar-open')); },
            handleSidebarToggle() {
                if (window.innerWidth <= 768) this.toggleSidebar();
                else {
                    document.getElementById('chat-view').classList.toggle('sidebar-collapsed');
                    document.getElementById('exam-view').classList.toggle('sidebar-collapsed');
                }
            },
            handleMainClick() { document.querySelectorAll('.view-container').forEach(el => el.classList.remove('sidebar-open')); },

            toast(msg, type = 'info') {
                const now = Date.now(); if (now - this.lastToastTime < 500) return; this.lastToastTime = now;
                const container = document.getElementById('toastContainer'); const id = 'toast-' + now;
                const bgClass = type === 'success' ? 'border-success' : (type === 'error' ? 'border-danger' : '');
                const iconClass = type === 'success' ? 'bi-check-circle-fill text-success' : (type === 'error' ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary');
                const html = `<div id="${id}" class="toast align-items-center custom-toast ${bgClass} show" role="alert"><div class="d-flex p-3 align-items-center"><i class="bi ${iconClass} fs-5 me-3"></i><div class="toast-body p-0 fw-medium">${msg}</div><button type="button" class="btn-close me-2 m-auto" onclick="ui.closeToast('${id}')"></button></div></div>`;
                container.insertAdjacentHTML('beforeend', html); setTimeout(() => ui.closeToast(id), 3000);
            },
            closeToast(id) { const el = document.getElementById(id); if (!el) return; el.classList.add('hiding'); el.addEventListener('animationend', () => el.remove()); },
            confirm(msg, callback) { document.getElementById('confirmMessage').innerText = msg; this.confirmCallback = callback; this.confirmModal.show(); },
            renderPersonalityGrid() {
                const container = document.getElementById('personalityGrid');
                container.innerHTML = PERSONALITY_OPTIONS.map(p => `<div class="col"><div class="persona-card" onclick="ui.selectPersona('${p.id}')" id="card-${p.id}"><i class="bi ${p.icon} fs-2 mb-2 d-block text-primary"></i><div class="fw-bold">${p.title}</div><div class="small text-muted mt-1">${p.desc}</div></div></div>`).join('');
            },
            selectPersona(id) {
                document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected')); document.getElementById(`card-${id}`).classList.add('selected');
                const customInput = document.getElementById('customPersonaInputDiv');
                if (id === 'custom') { customInput.classList.remove('d-none'); app.currentPreferences.personalityMode = document.getElementById('psCustomPersona').value || 'custom'; } else { customInput.classList.add('d-none'); app.currentPreferences.personalityMode = id; }
            },
            toggleTheme(el) {
                const theme = el.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('novi_theme', theme);
                // 同步所有开关状态
                document.querySelectorAll('.theme-switcher').forEach(chk => chk.checked = el.checked);
            }
        };

        /* ================= AI 出题模块逻辑 ================= */
        const exam = {
            data: null,
            isEditMode: false,

            init() {
                // 监听题型选择，控制主题输入框显示
                const typeSelect = document.getElementById('examType');
                const topicDiv = document.getElementById('customTopicDiv');
                // 默认显示自定义主题（因为目前只有完形填空）
                if (topicDiv) {
                    topicDiv.classList.remove('d-none');
                }
                if (typeSelect && topicDiv) {
                    typeSelect.addEventListener('change', (e) => {
                        // 根据题型判断是否显示主题，这里示例为选择题或阅读需要主题
                        if (['阅读理解', '选择题', '语法填空'].includes(e.target.value)) topicDiv.classList.remove('d-none');
                        else topicDiv.classList.add('d-none');
                    });
                }

                // --- 修改：持久化 AI 模型选择 ---
                const savedModel = localStorage.getItem('novi_exam_model');
                if (savedModel) {
                    const select = document.getElementById('examModel');
                    if (select) select.value = savedModel;
                }
                const modelSelect = document.getElementById('examModel');
                if (modelSelect) {
                    modelSelect.addEventListener('change', (e) => {
                        localStorage.setItem('novi_exam_model', e.target.value);
                    });
                }
            },

            // 生成试卷 (调用后端 API)
            async generate(e) {
                e.preventDefault();
                const subject = document.getElementById('examSubject').value;
                const questionType = document.getElementById('examType').value;
                const theme = document.getElementById('examTopic').value;
                const difficulty = document.querySelector('input[name="examDifficulty"]:checked').value;
                const quantity = document.getElementById('examQuantity').value;
                const model = document.getElementById('examModel').value; // 新增：获取模型

                document.getElementById('paperLoading').classList.remove('d-none');
                document.getElementById('paperEmpty').classList.add('d-none');
                document.getElementById('paperContent').classList.add('d-none');

                try {
                    const res = await axios.post('/questions/generate', {
                        subject, questionType, theme, difficulty, quantity: parseInt(quantity), model
                    });

                    if (res.data.code === 200 || res.data.code === 1) {
                        const result = res.data.data;
                        let questions = [];

                        // 【修复】处理返回单个对象的情况（后端返回的是字符串，parse后可能是一个对象或数组）
                        try {
                            const parsed = JSON.parse(result.questions);
                            if (Array.isArray(parsed)) {
                                questions = parsed;
                            } else {
                                // 如果是单个对象，包装成数组
                                questions = [parsed];
                            }
                        } catch (err) {
                            console.error("JSON Parse Error", err);
                            throw new Error("题目数据解析失败");
                        }

                        this.data = { questions, recordId: result.recordId };

                        this.renderPaper(this.data);
                        this.loadHistory(); // 刷新历史
                        ui.toast('试卷生成成功！', 'success');
                    } else {
                        throw new Error(res.data.msg || '生成失败');
                    }
                } catch (err) {
                    ui.toast(err.message || '网络请求失败', 'error');
                    document.getElementById('paperEmpty').classList.remove('d-none');
                } finally {
                    document.getElementById('paperLoading').classList.add('d-none');
                    if (this.data) document.getElementById('paperContent').classList.remove('d-none');
                }
            },

            // 加载出题历史
            async loadHistory() {
                try {
                    const res = await axios.get('/questions/history');
                    const list = document.querySelectorAll('#examHistoryList'); // 两个侧边栏都需要更新
                    if (res.data.code === 200 || res.data.code === 1) {
                        const html = res.data.data.map(item => {
                            const timeStr = new Date(item.createdAt).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            const themeDisplay = item.theme ? ` | ${item.theme}` : '';
                            const typeDisplay = item.questionType === '语法填空' ? '完形填空' : item.questionType;

                            return `
                            <div class="session-item d-flex align-items-center" onclick="exam.loadRecord(${item.id})">
                                <!-- 复选框，默认隐藏 -->
                                <div class="form-check me-2 d-none history-checkbox-wrapper" onclick="event.stopPropagation()">
                                    <input class="form-check-input history-checkbox" type="checkbox" value="${item.id}">
                                </div>
                                <div class="d-flex flex-column w-100">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold text-truncate" style="max-width: 140px;">${typeDisplay}${themeDisplay}</span>
                                        <div class="d-flex align-items-center">
                                             <span class="small text-muted me-2">${timeStr}</span>
                                             <!-- 只有非编辑模式下才显示单独删除按钮 -->
                                             <i class="bi bi-x btn text-muted p-0 history-delete-btn" onclick="exam.deleteRecord(${item.id}, event)" style="font-size: 1.1rem;"></i>
                                        </div>
                                    </div>
                                    <div class="small text-muted text-truncate">${item.subject} · ${item.difficulty}</div>
                                </div>
                            </div>`;
                        }).join('');
                        list.forEach(el => el.innerHTML = html || '<div class="text-center text-muted small mt-4 p-3">暂无生成记录</div>');

                        // 恢复编辑状态（如果处于编辑模式）
                        if (this.isEditMode) {
                            this.applyEditModeStyles(true);
                        }
                    }
                } catch (e) { console.error('History Load Failed', e); }
            },

            // --- 新增：批量删除相关逻辑 ---
            toggleEditMode() {
                this.isEditMode = !this.isEditMode;
                this.applyEditModeStyles(this.isEditMode);
            },

            applyEditModeStyles(isEdit) {
                const btn = document.getElementById('btnEditHistory');
                if (btn) btn.innerText = isEdit ? '取消' : '管理';

                const batchBar = document.getElementById('examBatchBar');
                if (isEdit) batchBar.classList.add('show'); else batchBar.classList.remove('show');

                // 切换复选框显示状态
                document.querySelectorAll('.history-checkbox-wrapper').forEach(el => {
                    if (isEdit) el.classList.remove('d-none'); else el.classList.add('d-none');
                });

                // 切换单个删除按钮显示状态
                document.querySelectorAll('.history-delete-btn').forEach(el => {
                    if (isEdit) el.classList.add('d-none'); else el.classList.remove('d-none');
                });

                // 清空选中状态
                if (!isEdit) {
                    document.querySelectorAll('.history-checkbox').forEach(chk => chk.checked = false);
                    document.getElementById('selectAllHistory').checked = false;
                }
            },

            toggleSelectAll(source) {
                document.querySelectorAll('.history-checkbox').forEach(chk => chk.checked = source.checked);
            },

            async deleteSelected() {
                const checked = document.querySelectorAll('.history-checkbox:checked');
                if (checked.length === 0) return ui.toast('请先选择记录', 'info');
                // 如果当前显示的记录被删除了，重置视图
                if (this.data && ids.includes(String(this.data.recordId))) {
                    this.reset();
                }
                ui.toast(`成功删除 ${successCount} 条记录`, 'success');
            } catch(e) {
                ui.toast('批量删除过程中出现错误', 'error');
                this.loadHistory();
            }
        });
        },

        // 单个删除
        deleteRecord(id, e) {
            e.stopPropagation();
            ui.confirm('确认删除这条出题记录吗？', async () => {
                try {
                    await axios.delete(`/questions/history/${id}`);
                    this.loadHistory();
                    if (this.data && this.data.recordId === id) {
                        this.reset();
                    }
                    ui.toast('删除成功', 'success');
                } catch (e) {
                    ui.toast('删除失败', 'error');
                }
            });
        },

        // 加载单条记录详情
        async loadRecord(id) {
            if (this.isEditMode) return; // 编辑模式下禁止点击加载

            try {
                const res = await axios.get(`/questions/history/${id}`);
                if (res.data.code === 200 || res.data.code === 1) {
                    const result = res.data.data;
                    let questions = [];
                    try {
                        const parsed = JSON.parse(result.questions);
                        questions = Array.isArray(parsed) ? parsed : [parsed];
                    } catch (err) {
                        questions = [];
                    }

                    this.data = { questions, recordId: result.recordId };
                    document.getElementById('paperEmpty').classList.add('d-none');
                    document.getElementById('paperContent').classList.remove('d-none');
                    this.renderPaper(this.data);
                    if (window.innerWidth <= 768) ui.handleMainClick();
                }
            } catch (e) { ui.toast('加载失败', 'error'); }
        },

        // --- 新增：智能解析辅助函数 ---
        parseListToMap(text) {
            if (!text || typeof text !== 'string') return {};
            const map = {};
            // 核心正则：匹配 (\d+)[\.、] pattern
            // 优化：不强求分隔符，只要有数字加点号即可，靠后续逻辑拆分
            const regex = /(\d+)\s*[\.、]/g;

            let match;
            const indices = [];
            while ((match = regex.exec(text)) !== null) {
                // 只有当数字在合理范围（比如1-50）时才认为是题号，避免误判
                const num = parseInt(match[1]);
                if (num > 0 && num < 100) {
                    indices.push({
                        num: num,
                        start: regex.lastIndex, // 内容开始的位置
                        matchStart: match.index // 匹配项开始的位置（用于计算上一项的结束）
                    });
                }
            }

            if (indices.length === 0) return {};

            for (let i = 0; i < indices.length; i++) {
                const current = indices[i];
                const next = indices[i + 1];
                // 内容截取到下一项匹配开始之前，或者字符串末尾
                const end = next ? next.matchStart : text.length;

                let content = text.substring(current.start, end).trim();
                // 清理可能残留的标点
                content = content.replace(/^[;；\.,，]+/, '').replace(/[;；\.,，]+$/, '');

                // 特殊处理：如果内容末尾包含了下一个题号（因为粘连），需要切掉
                // 例如 "traditional1" 里的 "1" 其实已经被 regex 捕获为 next match，
                // 但是因为 regex 是全局匹配，match.index 是准确的，substring 应该已经处理好了。
                // 唯一的问题是如果上一个内容是 "traditional1."，regex 匹配的是 "1."，
                // 那么 "traditional" 会被归入 current 的内容。这是正确的。

                if (content) {
                    map[current.num] = content;
                }
            }
            return map;
        },

        // 渲染试卷
        renderPaper(data) {
            const questions = data.questions; // Array
            const paperBody = document.getElementById('paperBody');
            const answersBody = document.getElementById('answersBody');

            paperBody.innerHTML = '';
            answersBody.innerHTML = '';

            // 设置标题信息
            if (questions && questions.length > 0) {
                const meta = questions[0];
                document.getElementById('paperTitleText').innerText = meta.title || `${meta.type || 'AI'} 专项练习`;
                const subtitleEl = document.getElementById('paperSubtitleContainer');
                if (meta.instructions) {
                    subtitleEl.innerText = meta.instructions;
                    subtitleEl.classList.remove('d-none');
                } else {
                    subtitleEl.classList.add('d-none');
                }

                const displayType = (meta.type === '语法填空' || meta.type === '完形填空') ? '完形填空' : (meta.type || '综合');
                document.getElementById('tagType').innerText = `题型：${displayType}`;
                document.getElementById('tagDiff').innerText = `难度：${meta.difficulty || '标准'}`;
            }

            let contentHtml = '';
            let answersHtml = '<table class="table table-bordered table-striped mt-3"><thead><tr><th style="width:60px">序号</th><th>答案</th><th>解析</th></tr></thead><tbody>';

            questions.forEach((q, index) => {
                if (q.article_content) {
                    // 渲染文章内容
                    const paras = q.article_content.split('\n').filter(t => t.trim());
                    paras.forEach(p => {
                        let formattedP = p.replace(/(\d+)\s*(\([a-zA-Z\s]+\)|_+)/g, (match, num, hint) => {
                            const hintText = hint.replace(/[()_]/g, '').trim();
                            const displayHint = hintText ? `(${hintText})` : '';
                            return `<span class="fw-bold mx-1 text-primary">[${num}]</span><span class="blank-space">__________</span> <span class="text-muted small">${displayHint}</span>`;
                        });
                        contentHtml += `<p class="question-content" style="text-indent: 2em;">${formattedP}</p>`;
                    });

                    // --- 关键修改：调用新解析函数 ---
                    let ansMap = {};
                    if (Array.isArray(q.answer)) {
                        q.answer.forEach((a, i) => ansMap[i + 1] = a);
                    } else {
                        ansMap = this.parseListToMap(q.answer);
                    }

                    let anaMap = {};
                    if (Array.isArray(q.analysis)) {
                        q.analysis.forEach((a, i) => anaMap[i + 1] = a);
                    } else {
                        anaMap = this.parseListToMap(q.analysis);
                    }

                    // 渲染表格行
                    const maxKey = Math.max(...Object.keys(ansMap).map(Number), ...Object.keys(anaMap).map(Number), 10);
                    const count = maxKey > 20 ? 10 : maxKey;

                    for (let i = 1; i <= count; i++) {
                        const ans = ansMap[i] || '';
                        const ana = anaMap[i] || '';

                        if (ans || ana) {
                            answersHtml += `
                                <tr>
                                    <td class="text-center fw-bold">${i}</td>
                                    <td class="text-primary fw-bold">${ans}</td>
                                    <td class="small text-muted text-break">${ana}</td>
                                </tr>`;
                        }
                    }

                    if (Object.keys(ansMap).length === 0 && Object.keys(anaMap).length === 0) {
                        answersHtml += `<tr><td colspan="3" class="text-muted text-center p-3">无法自动解析格式，请查看原始数据：<br>答案：${q.answer}<br>解析：${q.analysis}</td></tr>`;
                    }

                } else {
                    // --- 单题型渲染 ---
                    const idx = index + 1;
                    let qText = (q.content || '').replace(/\n/g, '<br>');
                    qText = qText.replace(/_+/g, '<span class="blank-space">__________</span>');

                    contentHtml += `
                        <div class="mb-4">
                            <h5 class="fw-bold">第 ${idx} 题</h5>
                            <div class="question-content">${qText}</div>
                        </div>
                    `;

                    answersHtml += `
                        <tr>
                            <td class="text-center fw-bold">${idx}</td>
                            <td class="text-primary fw-bold">${q.answer || ''}</td>
                            <td class="small text-muted">${q.analysis || ''}</td>
                        </tr>
                    `;
                }
            });

            answersHtml += '</tbody></table>';
            paperBody.innerHTML = contentHtml;
            answersBody.innerHTML = answersHtml;

            document.getElementById('showAnswersSwitch').checked = false;
            document.getElementById('paperAnswers').classList.add('d-none');
        },

        toggleAnswers() {
            const show = document.getElementById('showAnswersSwitch').checked;
            const el = document.getElementById('paperAnswers');
            if (show) el.classList.remove('d-none'); else el.classList.add('d-none');
        },

        reset() {
            document.getElementById('paperContent').classList.add('d-none');
            document.getElementById('paperEmpty').classList.remove('d-none');
            document.getElementById('examForm').reset();
        },

        exportWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title></head><body>";
            const footer = "</body></html>";
            const styles = `
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    .paper-title { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 20px; }
                    .paper-subtitle { text-align: center; font-size: 14pt; margin-bottom: 20px; color: #555; }
                    .exam-meta-tag { display: none; }
                    .question-content { text-indent: 2em; line-height: 1.5; text-align: justify; margin-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    thead { background-color: #f2f2f2; }
                    .blank-space { text-decoration: none; display: inline-block; min-width: 80px; text-align: center; }
                </style>
                `;
            const sourceHTML = document.getElementById("paperExportArea").innerHTML;
            const source = header + styles + sourceHTML + footer;
            const blob = new Blob(['\ufeff', source], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'AI智能试卷.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            ui.toast('文档导出中...', 'success');
        }
    };

        /* ================= 核心 App 逻辑 ================= */
        const app = {
            config: { apiBase: 'http://localhost:8080/api/v1' },
            state: { token: localStorage.getItem('novi_token'), user: {}, sessionId: null, isTyping: false },
            currentPreferences: {},

            init() {
                ui.init();
                exam.init();
                this.setupAxios();
                this.bindEvents();
                const isDark = localStorage.getItem('novi_theme') === 'dark';
                document.querySelectorAll('.theme-switcher').forEach(el => el.checked = isDark);
                if (isDark) document.documentElement.setAttribute('data-bs-theme', 'dark');

                if (this.state.token) this.initLoggedInState();

                document.getElementById('psCustomPersona').addEventListener('input', (e) => {
                    if (document.getElementById('card-custom').classList.contains('selected')) this.currentPreferences.personalityMode = e.target.value;
                });
            },

            switchMode(mode) {
                if (mode === 'chat') {
                    ui.navigateTo('chat-view');
                    this.loadSessions(); // 切换回对话模式时刷新会话列表
                } else if (mode === 'exam') {
                    ui.navigateTo('exam-view');
                    exam.loadHistory(); // 切换到出题模式时刷新历史
                }
                ui.updateSidebarState(mode);
                if (window.innerWidth <= 768) ui.handleMainClick();
            },

            setupAxios() {
                axios.defaults.baseURL = this.config.apiBase;
                axios.interceptors.request.use(c => { if (this.state.token) c.headers.Authorization = `Bearer ${this.state.token}`; return c; });
                axios.interceptors.response.use(r => r, e => { if (e.response?.status === 401) this.logout(); return Promise.reject(e); });
            },

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', e => {
                    e.preventDefault();
                    this.doAuth('/users/login', {
                        username: document.getElementById('loginUser').value,
                        password: document.getElementById('loginPass').value
                    });
                });
                document.getElementById('registerForm').addEventListener('submit', e => {
                    e.preventDefault();
                    this.doAuth('/users/register', {
                        username: document.getElementById('regUser').value,
                        nickname: document.getElementById('regNick').value,
                        email: document.getElementById('regEmail').value,
                        password: document.getElementById('regPass').value
                    }, true);
                });
                // 绑定主题切换事件已移至 ui.toggleTheme 统一处理
                document.getElementById('messageInput').addEventListener('keydown', e => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); }
                });
            },

            async doAuth(url, data, isReg) {
                try {
                    const res = await axios.post(url, data);
                    if (res.data.code === 200 || res.data.code === 1) {
                        if (isReg) {
                            ui.toast('注册成功，请登录', 'success');
                            ui.switchAuthTab('login');
                        } else {
                            this.state.token = res.data.data.token;
                            localStorage.setItem('novi_token', this.state.token);
                            ui.toast('欢迎回来', 'success');
                            setTimeout(() => this.initLoggedInState(true), 500);
                        }
                    } else ui.toast(res.data.msg || res.data.message, 'error');
                } catch (e) { ui.toast('请求失败: ' + (e.response?.data?.msg || e.message), 'error'); }
            },

            async initLoggedInState(checkOnboarding = false) {
                this.switchMode('chat'); // 默认进聊天
                try {
                    const me = await axios.get('/users/me');
                    this.state.user = me.data.data;
                    document.querySelectorAll('#userNickDisplay').forEach(el => el.textContent = this.state.user.nickname || this.state.user.username);
                    this.loadSessions();
                    if (checkOnboarding) this.checkFirstTimeLogin();
                } catch (e) { }
            },

            async checkFirstTimeLogin() {
                try {
                    const res = await axios.get('/preferences');
                    const prefs = res.data.data;
                    if (!prefs || prefs.personalityMode === 'default') ui.onboardingModal.show();
                } catch (e) { }
            },

            async submitOnboarding() {
                const payload = {
                    personalityMode: document.getElementById('obPersonality').value,
                    userAddressName: this.state.user.nickname,
                    toneStyle: 'normal', language: null
                };
                try {
                    await axios.put('/preferences', payload);
                    ui.onboardingModal.hide();
                    this.addMessageBubble('assistant', `你好 ${payload.userAddressName}！设置已更新。`);
                } catch (e) { ui.toast('保存失败', 'error'); }
            },

            async loadProfile() {
                try {
                    const res = await axios.get('/users/me');
                    const u = res.data.data;
                    document.getElementById('pfUsername').value = u.username;
                    document.getElementById('pfEmail').value = u.email;
                    document.getElementById('pfNickname').value = u.nickname;
                    document.getElementById('pfNewPass').value = '';
                    document.getElementById('pfCurrentPass').value = '';
                } catch (e) { }
            },

            async saveProfile() {
                const data = {
                    nickname: document.getElementById('pfNickname').value,
                    email: document.getElementById('pfEmail').value,
                    newPassword: document.getElementById('pfNewPass').value || null,
                    currentPassword: document.getElementById('pfCurrentPass').value || null
                };
                if (data.newPassword && !data.currentPassword) return ui.toast('修改密码需提供旧密码', 'error');
                try {
                    await axios.put('/users/me', data);
                    ui.toast('资料已更新', 'success');
                } catch (e) { ui.toast(e.response?.data?.msg || '更新失败', 'error'); }
            },

            async loadPreferences() {
                try {
                    const res = await axios.get('/preferences');
                    const p = res.data.data || {};
                    this.currentPreferences = p;
                    const isPredefined = PERSONALITY_OPTIONS.some(opt => opt.id === p.personalityMode);
                    if (isPredefined) {
                        ui.selectPersona(p.personalityMode || 'default');
                        document.getElementById('psCustomPersona').value = '';
                    } else {
                        ui.selectPersona('custom');
                        document.getElementById('psCustomPersona').value = p.personalityMode || '';
                    }
                    document.getElementById('psTone').value = p.toneStyle || 'normal';
                    document.getElementById('psLanguage').value = p.language || '';
                    document.getElementById('psAddressName').value = p.userAddressName || '';
                } catch (e) { }
            },

            async savePreferences() {
                let pMode = 'default';
                if (document.getElementById('card-custom').classList.contains('selected')) {
                    pMode = document.getElementById('psCustomPersona').value || 'custom';
                } else {
                    const sel = document.querySelector('.persona-card.selected');
                    pMode = sel ? sel.id.replace('card-', '') : 'default';
                }
                const data = {
                    personalityMode: pMode,
                    toneStyle: document.getElementById('psTone').value,
                    language: document.getElementById('psLanguage').value || null,
                    userAddressName: document.getElementById('psAddressName').value
                };
                try {
                    await axios.put('/preferences', data);
                    ui.toast('设置已保存', 'success');
                } catch (e) { ui.toast('保存失败', 'error'); }
            },

            async loadSessions() {
                try {
                    const res = await axios.get('/sessions');
                    const list = document.querySelectorAll('#sessionList');
                    list.forEach(el => el.innerHTML = '');
                    if (res.data.code === 200 || res.data.code === 1) {
                        const html = res.data.data.map(s => `
                            <div class="session-item ${s.id === this.state.sessionId ? 'active' : ''}" onclick="app.loadSession('${s.id}')">
                                <div class="text-truncate" style="max-width: 180px;">${s.title || '新会话'}</div>
                                <i class="bi bi-x btn text-muted" onclick="app.deleteSession('${s.id}', event)" style="font-size: 1.1rem;"></i>
                            </div>`).join('');
                        list.forEach(el => el.innerHTML = html);
                    }
                } catch (e) { }
            },

            async loadSession(sid) {
                this.state.sessionId = sid;
                this.loadSessions();
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';
                if (window.innerWidth <= 768) ui.handleMainClick();

                const res = await axios.get(`/sessions/${sid}/messages`);
                if (res.data.code === 200 || res.data.code === 1) res.data.data.forEach(m => this.addMessageBubble(m.role.toLowerCase(), m.content));

                // Update Title Display
                const active = document.querySelector('.session-item.active');
                if (active) document.getElementById('currentTitle').innerText = active.innerText.trim();

                const win = document.getElementById('chatWindow');
                setTimeout(() => win.scrollTop = win.scrollHeight, 100);
            },

            deleteSession(sid, e) {
                e.stopPropagation();
                ui.confirm('删除此会话？', async () => {
                    try {
                        await axios.delete(`/sessions/${sid}`);
                        if (this.state.sessionId === sid) this.startNewChat();
                        else this.loadSessions();
                    } catch (e) { ui.toast('删除失败', 'error'); }
                });
            },

            startNewChat() {
                this.state.sessionId = null;
                document.getElementById('currentTitle').innerText = 'Novi AI';
                document.getElementById('chatContainer').innerHTML = `<div class="text-center mt-5 pt-5"><div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem; border:none; background:transparent;"><i class="bi bi-stars text-primary"></i></div><h3 class="fw-bold">你好，我是 Novi</h3><p class="text-muted">我可以帮你写代码、做计划，或者仅仅聊聊天。</p></div>`;
                if (window.innerWidth <= 768) ui.handleMainClick();
                this.loadSessions();
            },

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const msg = input.value.trim();
                if (!msg || this.state.isTyping) return;

                this.addMessageBubble('user', msg);
                input.value = '';
                input.style.height = '56px';
                document.getElementById('fullScreenBtn').classList.remove('show');

                const win = document.getElementById('chatWindow');
                win.scrollTop = win.scrollHeight;

                const aiId = 'ai-' + Date.now();
                this.addMessageBubble('assistant', '', aiId);
                const bubble = document.getElementById(aiId);
                this.state.isTyping = true;

                try {
                    const mode = document.querySelector('input[name="apiMode"]:checked').value;
                    const payload = { message: msg, sessionId: this.state.sessionId };

                    Typewriter.start(bubble);

                    if (mode === 'stream') await this.handleStream(payload);
                    else {
                        const res = await axios.post('/chat/send/call', payload);
                        if (res.data.code !== 200 && res.data.code !== 1) throw new Error(res.data.msg);
                        Typewriter.push(res.data.data.response);
                        if (res.data.data.title) this.updateSessionTitle(res.data.data.sessionId, res.data.data.title);
                    }
                } catch (err) {
                    Typewriter.stop();
                    bubble.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle me-2"></i>${err.message || '网络请求失败'}</span>`;
                } finally {
                    if (document.querySelector('input[name="apiMode"]:checked')?.value !== 'stream') {
                        setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; this.loadSessions(); }, 300);
                    }
                }
            },

            async handleStream(payload) {
                try {
                    const res = await fetch(`${this.config.apiBase}/chat/send/stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (!line.trim() || !line.startsWith('data:')) continue;
                            try {
                                const evt = JSON.parse(line.slice(5));
                                if (evt.eventType === 'CONTENT') Typewriter.push(evt.content);
                                else if (evt.eventType === 'METADATA') this.updateSessionTitle(evt.sessionId, evt.title);
                            } catch (e) { }
                        }
                    }
                } finally {
                    setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; this.loadSessions(); }, 300);
                }
            },

            addMessageBubble(role, content, id) {
                const container = document.getElementById('chatContainer');
                if (container.querySelector('.text-center')) container.innerHTML = '';
                const div = document.createElement('div');
                div.className = `message-row ${role}`;
                const avatar = `<div class="avatar ${role === 'user' ? 'avatar-user' : 'avatar-ai'}"><i class="bi bi-${role === 'user' ? 'person-fill' : 'stars'}"></i></div>`;
                const initialHtml = content ? marked.parse(content) : '';
                const bub = `<div class="message-bubble ${role} markdown-body" ${id ? `id="${id}" data-raw=""` : ''}>${initialHtml}</div>`;
                div.innerHTML = avatar + bub;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight; // Fix scroll on add
            },

            updateSessionTitle(sid, title) {
                this.state.sessionId = sid;
                if (title) document.getElementById('currentTitle').innerText = title;
            },

            logout() { localStorage.removeItem('novi_token'); location.reload(); }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>