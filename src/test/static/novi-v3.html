<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Novi · AI 挚友</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.css">

    <style>
        /* ================= 1. 核心变量 ================= */
        :root {
            --primary-color: #4e6ef2;
            --bg-body: #f2f4f7; /* 稍微加深一点背景，突出白色气泡 */
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-input: #ffffff;
            --bg-input-focus: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #666666;
            --border-color: #e5e7eb;
            --border-input: #e5e7eb;

            /* 气泡颜色 - 微信风格 */
            --bubble-user-bg: #95ec69; /* 微信绿 */
            --bubble-user-text: #000000;
            --bubble-ai-bg: #ffffff;
            --bubble-ai-text: #1f1f1f;

            --sidebar-width: 280px;
            --sidebar-width-collapsed: 76px; /* 折叠后的宽度 */
            --toast-top-mobile: 80px;
        }

        [data-bs-theme="dark"] {
            --bg-body: #111111;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-header: #1e1e1e;
            --bg-input: #2c2c2c;
            --bg-input-focus: #333333;
            --text-main: #e3e3e3;
            --text-sub: #aaaaaa;
            --border-color: #333333;
            --border-input: #444444;

            --bubble-user-bg: #2b7c38; /* 深色模式下的绿色 */
            --bubble-user-text: #e3e3e3;
            --bubble-ai-bg: #2c2c2c;
            --bubble-ai-text: #e3e3e3;
        }

        html, body { height: 100%; overflow: hidden; background-color: var(--bg-body); font-family: -apple-system, "Noto Sans SC", "Microsoft YaHei", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; transition: background-color 0.3s; color: var(--text-main); }

        /* 组件基础样式 */
        .form-control, .form-select { background-color: var(--bg-input); border: 1px solid var(--border-input); color: var(--text-main); }
        .form-control:focus, .form-select:focus { background-color: var(--bg-input-focus); border-color: var(--primary-color); color: var(--text-main); box-shadow: 0 0 0 3px rgba(78, 110, 242, 0.25); }

        .view-container { width: 100%; height: 100%; display: none; animation: fadeIn 0.3s ease; }
        .view-container.active { display: flex !important; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ================= 3. 认证视图 ================= */
        #auth-view { align-items: center; justify-content: center; padding: 20px; }
        .auth-card {
            width: 100%; max-width: 400px; padding: 2.5rem;
            background-color: var(--bg-sidebar); border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid var(--border-color);
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .auth-header { margin-bottom: 2rem; text-align: center; }
        .auth-form-wrapper { opacity: 1; transition: opacity 0.2s ease; }
        .auth-form-wrapper.fading { opacity: 0; }

        /* 滑动切换动画 Auth Tabs */
        .auth-tabs-container {
            position: relative;
            background-color: var(--bg-body);
            border-radius: 50px;
            padding: 4px;
            display: flex;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .auth-tab-bg {
            position: absolute;
            top: 4px; left: 4px; bottom: 4px;
            width: calc(50% - 4px);
            background-color: var(--bg-card);
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        .auth-tabs-container.register-mode .auth-tab-bg { transform: translateX(100%); }

        .auth-tab-btn {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            z-index: 2;
            transition: color 0.2s;
            background: none; border: none;
        }
        .auth-tab-btn.active { color: var(--primary-color); }

        .password-group .input-group-text {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            border-left: none;
            color: var(--text-sub);
            cursor: pointer;
        }
        .password-group .form-control { border-right: none; }

        /* ================= 4. 聊天视图布局 ================= */
        #chat-view { flex-direction: row; position: relative; }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.3s ease, transform 0.3s ease; /* 增加 width 动画 */
            flex-shrink: 0;
        }

        .chat-main { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-body); position: relative; transition: transform 0.3s ease; z-index: 50; }

        /* ================= 侧边栏折叠核心逻辑 (仅限桌面端) ================= */
        /* 关键修复：使用 media query 包裹折叠逻辑，防止移动端也被“折叠”导致内容消失 */
        @media (min-width: 769px) {
            #chat-view.sidebar-collapsed .sidebar {
                width: var(--sidebar-width-collapsed);
            }

            /* 修复：侧边栏折叠时，将底部设置栏推到底部 */
            #chat-view.sidebar-collapsed .sidebar > .border-top {
                margin-top: auto;
            }

            /* 折叠时隐藏元素 */
            #chat-view.sidebar-collapsed .sidebar .text-label,
            #chat-view.sidebar-collapsed .sidebar #sessionList {
                display: none !important;
            }

            /* 折叠时调整新建按钮样式 */
            #chat-view.sidebar-collapsed .sidebar .btn-new-chat {
                padding-left: 0;
                padding-right: 0;
                justify-content: center;
            }
            #chat-view.sidebar-collapsed .sidebar .btn-new-chat i {
                margin-right: 0 !important;
            }

            /* 折叠时调整底部用户菜单 */
            #chat-view.sidebar-collapsed .sidebar .user-dropdown-btn {
                justify-content: center;
                padding: 0.5rem 0;
            }
            #chat-view.sidebar-collapsed .sidebar .user-dropdown-btn .avatar {
                margin: 0 !important;
            }
            #chat-view.sidebar-collapsed .sidebar .user-dropdown-btn i.bi-three-dots-vertical {
                display: none;
            }

            /* 折叠时设置菜单不被遮挡：改为 Fixed 定位显示在侧边栏右侧 */
            /* 关键修复：bottom 改为 70px，避免遮挡头像按钮 */
            #chat-view.sidebar-collapsed .sidebar .dropdown-menu {
                position: fixed;
                left: calc(var(--sidebar-width-collapsed) + 10px);
                bottom: 70px; /* 提高位置 */
                top: auto;
                transform: none !important;
                width: 200px;
                z-index: 1050;
            }
        }

        /* 汉堡按钮样式覆写 */
        .sidebar-toggle-btn {
            background-color: transparent !important;
            color: var(--text-sub);
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            color: var(--text-main);
        }
        [data-bs-theme="dark"] .sidebar-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main);
        }

        /* ====================================================== */

        @media (max-width: 768px) {
            .sidebar { position: absolute; left: 0; top: 0; bottom: 0; transform: translateX(-100%); border-right: none; box-shadow: none; width: var(--sidebar-width) !important; }
            .sidebar-open .sidebar { transform: translateX(0); box-shadow: 2px 0 20px rgba(0,0,0,0.2); }
            .sidebar-open .chat-main::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; }

            /* 移动端确保内容总是可见，防止被 sidebar-collapsed 错误隐藏 */
            .sidebar .text-label, .sidebar #sessionList { display: block !important; }
        }

        /* 聊天窗口 */
        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem;
            scroll-behavior: auto;
        }

        .chat-container {
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
        }

        .message-row { display: flex; margin-bottom: 1.5rem; align-items: flex-start; }
        .message-row.user { justify-content: flex-end; }

        /* 头像样式 */
        .avatar {
            width: 40px; height: 40px; border-radius: 6px; /* 方形圆角，更像微信 */
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
            overflow: hidden;
        }
        .message-row.assistant .avatar { margin-right: 12px; }
        .message-row.user .avatar { margin-left: 12px; order: 2; }

        .avatar-ai { background: #fff; color: var(--primary-color); }
        .avatar-user { background: var(--primary-color); color: #fff; }

        .message-bubble {
            max-width: 75%;
            padding: 10px 16px;
            border-radius: 8px; /* 气泡圆角 */
            font-size: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* AI 消息样式：白色背景气泡 */
        .message-bubble.assistant {
            background: var(--bubble-ai-bg);
            color: var(--bubble-ai-text);
        }

        /* 用户消息样式：绿色背景气泡 */
        .message-bubble.user {
            background: var(--bubble-user-bg);
            color: var(--bubble-user-text) !important;
            order: 1;
        }
        .message-bubble.user * { color: inherit !important; margin-bottom: 0; }

        /* ================= 输入区域重构 ================= */
        .chat-input-area {
            background-color: var(--bg-body);
            padding: 0 1rem 1.5rem 1rem;
            position: relative;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .input-wrapper {
            width: 100%;
            max-width: 850px;
            background-color: var(--bg-input);
            border-radius: 24px;
            position: relative;
            border: 1px solid transparent;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .input-wrapper:focus-within {
            background-color: var(--bg-input-focus);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #messageInput {
            background: transparent;
            border: none;
            resize: none;
            overflow-y: hidden;
            min-height: 56px;
            max-height: 200px;
            padding: 16px 50px 16px 20px; /* 上右下左，右侧留出按钮空间 */
            width: 100%;
            border-radius: 24px;
            font-size: 1rem;
            line-height: 1.5; /* 56px 高度 - 32px padding = 24px 内容，刚好一行 */
        }

        #messageInput:focus { box-shadow: none; outline: none; }

        /* 全屏按钮 - 仅在内容变多时显示 */
        #fullScreenBtn {
            position: absolute;
            top: 12px;
            right: 16px;
            z-index: 5;
            border-radius: 50%;
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-sub);
            background: transparent;
            border: none;
            transition: opacity 0.2s;
            opacity: 0;
            pointer-events: none;
        }
        #fullScreenBtn.show { opacity: 1; pointer-events: auto; }
        #fullScreenBtn:hover { background-color: rgba(0,0,0,0.05); }

        /* 发送按钮 - 右下角 */
        #sendBtn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            padding: 0;
            background-color: var(--primary-color); /* 默认蓝色，显眼一点 */
            color: #fff;
            border: none;
            transition: all 0.2s;
            z-index: 6;
        }
        #sendBtn:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(78, 110, 242, 0.4); }
        #sendBtn i { font-size: 1.1rem; margin-left: 2px; }

        /* Session List */
        .session-item { padding: 10px 16px; margin: 4px 8px; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); transition: background 0.2s; height: 44px; font-size: 0.9rem; }
        .session-item:hover { background-color: rgba(0,0,0,0.05); }
        .session-item.active { background-color: rgba(78, 110, 242, 0.1); color: var(--primary-color) !important; font-weight: 600; }
        .session-item.active .text-muted { color: var(--primary-color) !important; }

        /* Markdown & Highlight fixes */
        .markdown-body { background-color: transparent !important; font-family: inherit !important; color: inherit !important; }
        .markdown-body pre { background-color: rgba(0,0,0,0.05) !important; border-radius: 8px; }
        [data-bs-theme="dark"] .markdown-body pre { background-color: rgba(255,255,255,0.08) !important; }
        [data-bs-theme="dark"] .message-bubble { box-shadow: 0 1px 5px rgba(255,255,255,0.5); !important; }



        /* 修复：防止 markdown 解析吃掉标点，虽然主要靠 JS 配置，但样式上防止溢出 */
        .markdown-body p { margin-bottom: 0.5rem; }
        .markdown-body p:last-child { margin-bottom: 0; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1060; }
        .custom-toast {
            background: var(--bg-card); color: var(--text-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-radius: 12px;
            animation: slideInRight 0.3s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .custom-toast.hiding { animation: fadeOut 0.3s ease forwards; }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Settings View */
        #settings-view { background-color: var(--bg-body); overflow-y: auto; }
        .settings-container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
        .settings-card { background: var(--bg-card); border-radius: 20px; border: none; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.02); margin-bottom: 2rem; }
        .nav-pills-settings .nav-link { border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.5rem; transition: all 0.2s; }
        .nav-pills-settings .nav-link:hover { background-color: rgba(0,0,0,0.03); }
        .nav-pills-settings .nav-link.active { background-color: var(--primary-color); color: #fff; font-weight: bold; }

        .persona-card { border: 2px solid transparent; border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.2s; background-color: var(--bg-input); height: 100%; text-align: center; position: relative; }
        .persona-card:hover { transform: translateY(-2px); background-color: var(--bg-input-focus); border-color: var(--primary-color); }
        .persona-card.selected { border-color: var(--primary-color); background-color: rgba(78, 110, 242, 0.05); }
        .persona-card.selected::after { content: '\F26E'; font-family: 'bootstrap-icons'; position: absolute; top: 10px; right: 10px; color: var(--primary-color); }

        /* 隐藏滚动条样式但保留功能 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(128, 128, 128, 0.4); }
    </style>
</head>
<body>

<!-- Fullscreen Editor Modal -->
<div class="modal fade" id="fullScreenInputModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content" style="background: var(--bg-body);">
            <div class="modal-header border-bottom">
                <h5 class="modal-title fw-bold">沉浸式编辑</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="container h-100 py-4">
                    <textarea id="fullScreenTextarea" class="form-control border-0 h-100 shadow-none" style="font-size: 1.1rem; background: transparent; resize: none;" placeholder="在这里尽情输入..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="ui.submitFullScreenInput()">完成</button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content p-3 rounded-4" style="background: var(--bg-card); color: var(--text-main);">
            <div class="modal-body text-center">
                <h5 class="fw-bold mb-3">确认</h5>
                <p class="text-muted small mb-4" id="confirmMessage"></p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger rounded-pill px-4" id="confirmBtnAction">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end rounded-start-4" tabindex="-1" id="settingsOffcanvas" style="background: var(--bg-card); color: var(--text-main);">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold">设置</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="nav flex-column nav-pills nav-pills-settings gap-2" id="mobileSettingsTabs"></div>
    </div>
</div>

<!-- 1. 认证视图 -->
<div id="auth-view" class="view-container active">
    <div class="auth-card" id="authCard">
        <div class="auth-header">
            <h2 class="fw-bold mb-2" style="color: var(--primary-color);">Novi</h2>
            <p class="text-muted">AI 挚友 · 懂你所想</p>
        </div>

        <!-- 滑动切换 Tabs -->
        <div class="auth-tabs-container" id="authTabs">
            <div class="auth-tab-bg"></div>
            <button class="auth-tab-btn active" onclick="ui.switchAuthTab('login')">登录</button>
            <button class="auth-tab-btn" onclick="ui.switchAuthTab('register')">注册</button>
        </div>

        <div id="loginFormWrapper" class="auth-form-wrapper">
            <form id="loginForm">
                <div class="mb-3"><input type="text" class="form-control rounded-3 px-3 py-2" id="loginUser" placeholder="用户名" required></div>
                <div class="mb-4">
                    <div class="input-group password-group">
                        <input type="password" class="form-control rounded-start-3 px-3 py-2" id="loginPass" placeholder="密码" required>
                        <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('loginPass', this)"><i class="bi bi-eye-slash"></i></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">进入</button>
            </form>
        </div>
        <div id="registerFormWrapper" class="auth-form-wrapper d-none">
            <form id="registerForm">
                <div class="mb-2"><input type="text" class="form-control rounded-3" id="regUser" placeholder="用户名" required></div>
                <div class="mb-2"><input type="text" class="form-control rounded-3" id="regNick" placeholder="昵称" required></div>
                <div class="mb-2"><input type="email" class="form-control rounded-3" id="regEmail" placeholder="邮箱" required></div>
                <div class="mb-4">
                    <div class="input-group password-group">
                        <input type="password" class="form-control rounded-start-3" id="regPass" placeholder="密码" required>
                        <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('regPass', this)"><i class="bi bi-eye-slash"></i></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 shadow-sm">注册</button>
            </form>
        </div>
    </div>
</div>

<!-- 2. 聊天视图 -->
<div id="chat-view" class="view-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="p-3 d-flex justify-content-between align-items-center">
            <!-- 菜单按钮：绑定了新的 ui.handleSidebarToggle 函数 -->
            <button class="btn rounded-pill text-muted border-0 sidebar-toggle-btn" onclick="ui.handleSidebarToggle()">
                <i class="bi bi-list fs-5"></i>
            </button>

            <span class="fw-bold ms-2 text-label" style="white-space: nowrap;">历史记录</span>
            <div class="ms-auto"></div>
        </div>

        <!-- 新会话按钮 -->
        <div class="px-3 mb-3">
            <button class="btn btn-primary w-100 rounded-pill py-2 shadow-sm btn-new-chat d-flex align-items-center justify-content-center" onclick="app.startNewChat()">
                <i class="bi bi-plus-lg me-2"></i>
                <span class="text-label">新对话</span>
            </button>
        </div>

        <!-- 会话列表 -->
        <div class="flex-grow-1 overflow-auto px-2" id="sessionList"></div>

        <!-- 底部用户设置 -->
        <div class="p-3 border-top">
            <div class="dropdown dropup w-100" id="userDropdownContainer">
                <button class="btn w-100 d-flex align-items-center p-2 rounded hover-bg text-start border-0 user-dropdown-btn" data-bs-toggle="dropdown" style="color: var(--text-main);">
                    <div class="avatar avatar-user me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">U</div>
                    <div class="flex-grow-1 overflow-hidden text-label"><div class="fw-bold text-truncate" id="userNickDisplay">User</div></div>
                    <i class="bi bi-three-dots-vertical text-muted"></i>
                </button>
                <ul class="dropdown-menu shadow-lg border-0 rounded-4 mb-2">
                    <li><a class="dropdown-item py-2" href="#" onclick="ui.navigateTo('settings-view')"><i class="bi bi-gear me-2"></i>设置</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger py-2" href="#" onclick="app.logout()"><i class="bi bi-box-arrow-right me-2"></i>退出</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="chat-main" onclick="ui.handleMainClick(event)">
        <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3" style="background: var(--bg-header);">
            <div class="d-flex align-items-center">
                <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);" onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                <h6 class="mb-0 fw-bold" id="currentTitle" style="color: var(--text-main);">Novi AI</h6>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="form-check form-switch mb-0" title="深色模式">
                    <input class="form-check-input" type="checkbox" id="themeSwitch">
                    <label class="form-check-label" for="themeSwitch"><i class="bi bi-moon-stars" style="color: var(--text-main);"></i></label>
                </div>
                <div class="btn-group btn-group-sm">
                    <input type="radio" class="btn-check" name="apiMode" id="modeStream" value="stream" checked>
                    <label class="btn btn-outline-secondary" for="modeStream">流式</label>
                    <input type="radio" class="btn-check" name="apiMode" id="modeCall" value="call">
                    <label class="btn btn-outline-secondary" for="modeCall">普通</label>
                </div>
            </div>
        </header>

        <!-- 聊天窗口容器 -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-container" id="chatContainer">
                <div class="text-center mt-5 pt-5">
                    <div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem; border: none; background: transparent;"><i class="bi bi-stars text-primary"></i></div>
                    <h3 class="fw-bold" style="color: var(--text-main);">你好，我是 Novi</h3>
                    <p style="color: var(--text-sub);">我可以帮你写代码、做计划，或者仅仅聊聊天。</p>
                </div>
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea id="messageInput" class="form-control" rows="1" placeholder="输入消息..."></textarea>

                <!-- 全屏按钮 (右上，默认隐藏) -->
                <button id="fullScreenBtn" onclick="ui.openFullScreenInput()" title="全屏编辑">
                    <i class="bi bi-arrows-angle-expand"></i>
                </button>

                <!-- 发送按钮 (右下) -->
                <button id="sendBtn" onclick="app.sendMessage()" title="发送消息">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- 3. 设置视图 -->
<div id="settings-view" class="view-container">
    <div class="settings-container">
        <!-- 头部调整：移动端显示汉堡按钮 -->
        <div class="mb-4 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <button class="btn btn-icon rounded-circle me-3 hover-bg" onclick="ui.navigateTo('chat-view')" style="width:40px;height:40px;background:var(--bg-input);color:var(--text-main);"><i class="bi bi-arrow-left"></i></button>
                <h4 class="fw-bold mb-0">设置</h4>
            </div>
            <!-- 移动端设置导航触发器 -->
            <button class="btn btn-outline-secondary border-0 d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas">
                <i class="bi bi-list fs-4"></i>
            </button>
        </div>

        <div class="row g-4">
            <div class="col-lg-3 d-none d-lg-block">
                <nav class="nav flex-column nav-pills nav-pills-settings" id="settingsDesktopNav">
                    <button class="nav-link active text-start mb-2" data-bs-toggle="pill" data-bs-target="#tab-profile" onclick="ui.syncMobileNav('tab-profile')"><i class="bi bi-person me-2"></i>个人资料</button>
                    <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#tab-persona" onclick="ui.syncMobileNav('tab-persona')"><i class="bi bi-magic me-2"></i>AI 设定</button>
                    <button class="nav-link text-start text-danger mt-4" onclick="app.logout()"><i class="bi bi-box-arrow-left me-2"></i>退出登录</button>
                </nav>
            </div>

            <div class="col-lg-9">
                <div class="tab-content" id="settingsTabContent">
                    <div class="tab-pane fade show active" id="tab-profile">
                        <div class="settings-card">
                            <h5 class="fw-bold mb-4">个人信息</h5>
                            <form id="profileForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">用户名</label>
                                        <input type="text" class="form-control rounded-3" id="pfUsername" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">昵称</label>
                                        <input type="text" class="form-control rounded-3" id="pfNickname">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-muted">邮箱</label>
                                        <input type="email" class="form-control rounded-3" id="pfEmail">
                                    </div>
                                </div>
                                <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4" type="button" onclick="app.saveProfile()">保存更改</button></div>
                            </form>
                        </div>
                        <!-- 安全设置恢复 -->
                        <div class="settings-card">
                            <h5 class="fw-bold mb-4 text-danger">安全设置</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">新密码</label>
                                    <div class="input-group password-group">
                                        <input type="password" class="form-control rounded-start-3" id="pfNewPass" placeholder="如不修改请留空">
                                        <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('pfNewPass', this)"><i class="bi bi-eye-slash"></i></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">当前密码</label>
                                    <div class="input-group password-group">
                                        <input type="password" class="form-control rounded-start-3" id="pfCurrentPass" placeholder="修改密码需验证">
                                        <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('pfCurrentPass', this)"><i class="bi bi-eye-slash"></i></span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 text-end"><button class="btn btn-outline-danger rounded-pill px-4" type="button" onclick="app.saveProfile()">修改密码</button></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-persona">
                        <div class="settings-card">
                            <h5 class="fw-bold mb-4">核心性格</h5>
                            <div class="row row-cols-2 row-cols-lg-3 g-3 mb-4" id="personalityGrid"></div>
                            <div class="mt-3 d-none" id="customPersonaInputDiv">
                                <label class="form-label small fw-bold text-muted">自定义 Prompt</label>
                                <textarea class="form-control rounded-3" id="psCustomPersona" rows="3" placeholder="输入你想要的 Prompt..."></textarea>
                            </div>
                        </div>
                        <div class="settings-card">
                            <h5 class="fw-bold mb-4">交互偏好</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">回复风格</label>
                                    <select class="form-select rounded-3" id="psTone">
                                        <option value="normal">默认</option>
                                        <option value="emoji_heavy">✨ 活泼</option>
                                        <option value="concise">简洁</option>
                                        <option value="verbose">详细</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">语言</label>
                                    <select class="form-select rounded-3" id="psLanguage">
                                        <option value="">自动</option>
                                        <option value="zh_CN">中文</option>
                                        <option value="en_US">English</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold text-muted">如何称呼你</label>
                                    <input type="text" class="form-control rounded-3" id="psAddressName">
                                </div>
                            </div>
                            <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4" onclick="app.savePreferences()">应用设置</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Onboarding: 优化逻辑 -->
<div class="modal fade" id="onboardingModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5 border-0 shadow-lg rounded-5" style="background-color: var(--bg-card); color: var(--text-main);">
            <div class="mb-4"><div class="avatar avatar-ai mx-auto" style="width: 80px; height: 80px; font-size: 3rem; background: transparent;"><i class="bi bi-stars text-primary"></i></div></div>
            <h2 class="fw-bold mb-3">欢迎来到 Novi</h2>
            <p class="text-muted mb-5">初次见面，请选择你喜欢的 AI 性格</p>
            <div class="text-start mb-4">
                <label class="form-label fw-bold small text-muted">性格偏好</label>
                <select class="form-select form-select-lg rounded-3" id="obPersonality">
                    <option value="default">标准 (平衡理智)</option>
                    <option value="witty">幽默 (风趣好玩)</option>
                    <option value="gentle">温柔 (治愈系)</option>
                    <option value="professional">专业 (严谨学术)</option>
                    <option value="tsundere">傲娇 (哼，勉为其难)</option>
                </select>
            </div>
            <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5" onclick="app.submitOnboarding()">开启旅程</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- 引入 Marked -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    // 恢复核心性格选项
    const PERSONALITY_OPTIONS = [
        { id: 'default', icon: 'bi-emoji-smile', title: '标准', desc: '平衡、理智' },
        { id: 'witty', icon: 'bi-emoji-laughing', title: '幽默', desc: '风趣好玩' },
        { id: 'gentle', icon: 'bi-flower1', title: '温柔', desc: '知心、治愈' },
        { id: 'professional', icon: 'bi-briefcase', title: '专家', desc: '严谨、学术' },
        { id: 'tsundere', icon: 'bi-lightning', title: '傲娇', desc: '口是心非' },
        { id: 'custom', icon: 'bi-pencil-square', title: '自定义', desc: '完全由你决定' }
    ];

    // 配置 Marked，开启 breaks 支持换行
    marked.use({
        breaks: true,
        gfm: true
    });

    // 优化后的打字机类 - 修复 Markdown 渲染吞字问题
    const Typewriter = {
        queue: [],
        element: null,
        isTyping: false,
        timer: null,
        chatWindow: null,
        fullText: "", // 存储完整文本，避免 split 造成的解析问题

        start(element) {
            this.element = element;
            this.queue = [];
            this.fullText = "";
            this.isTyping = true;
            this.chatWindow = document.getElementById('chatWindow');
            this.processQueue();
        },

        push(text) {
            // 简单推入字符
            this.queue.push(...text.split(''));
            if (!this.isTyping) this.processQueue();
        },

        stop() {
            this.isTyping = false;
            clearTimeout(this.timer);
            // 渲染剩余所有内容
            if (this.queue.length > 0) {
                this.fullText += this.queue.join('');
                this.queue = [];
            }
            if (this.element) {
                const currentRaw = this.element.dataset.raw || '';
                // 最终渲染一次，确保 markdown 闭合
                this.render(this.fullText || currentRaw);
            }
        },

        processQueue() {
            if (this.queue.length === 0) {
                if (!this.isTyping) return;
                this.timer = setTimeout(() => this.processQueue(), 50);
                return;
            }

            const speed = this.queue.length > 50 ? 5 : (this.queue.length > 20 ? 15 : 30);
            const chunkSize = this.queue.length > 100 ? 10 : (this.queue.length > 50 ? 5 : 2);

            let chunk = '';
            for(let i = 0; i < chunkSize && this.queue.length > 0; i++) {
                chunk += this.queue.shift();
            }

            this.fullText += chunk;
            this.render(this.fullText);

            this.timer = setTimeout(() => this.processQueue(), speed);
        },

        render(rawText) {
            if (!this.element) return;
            this.element.dataset.raw = rawText;
            // 使用 marked 解析完整文本，避免分段解析导致的闭合标签错误
            this.element.innerHTML = marked.parse(rawText);

            const win = this.chatWindow;
            if (!win) return;
            const threshold = 150;
            const isNearBottom = win.scrollHeight - win.scrollTop - win.clientHeight < threshold;
            if (isNearBottom) {
                win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
            }
        }
    };

    const ui = {
        confirmModal: null, onboardingModal: null, offcanvas: null, confirmCallback: null, fullScreenModal: null,
        lastToastTime: 0, // 防爆点击

        init() {
            this.confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            this.onboardingModal = new bootstrap.Modal(document.getElementById('onboardingModal'));
            this.offcanvas = new bootstrap.Offcanvas(document.getElementById('settingsOffcanvas'));
            this.fullScreenModal = new bootstrap.Modal(document.getElementById('fullScreenInputModal'));

            document.getElementById('confirmBtnAction').addEventListener('click', () => {
                if(this.confirmCallback) this.confirmCallback();
                this.confirmModal.hide();
            });
            this.renderPersonalityGrid();
            this.initMobileSettingsNav();

            // 输入框逻辑：垂直居中已通过 CSS padding 修复。全屏按钮逻辑修复。
            const msgInput = document.getElementById('messageInput');
            const fsBtn = document.getElementById('fullScreenBtn');

            msgInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value === '') this.style.height = '56px'; // 初始高度

                // 只有当高度增加（超过一行）或字数较多时显示全屏按钮
                if (this.scrollHeight > 90) {
                    fsBtn.classList.add('show');
                } else {
                    fsBtn.classList.remove('show');
                }
            });
            // 初始化
            msgInput.style.height = '56px';
        },

        togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            } else {
                input.type = 'password';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            }
        },

        openFullScreenInput() {
            const mainInput = document.getElementById('messageInput');
            document.getElementById('fullScreenTextarea').value = mainInput.value;
            this.fullScreenModal.show();
        },

        submitFullScreenInput() {
            const fullText = document.getElementById('fullScreenTextarea').value;
            const mainInput = document.getElementById('messageInput');
            mainInput.value = fullText;
            // 触发 input 事件调整高度和按钮显示
            mainInput.dispatchEvent(new Event('input'));
            this.fullScreenModal.hide();
            mainInput.focus();
        },

        initMobileSettingsNav() {
            const desktopNav = document.getElementById('settingsDesktopNav');
            const mobileNav = document.getElementById('mobileSettingsTabs');
            mobileNav.innerHTML = desktopNav.innerHTML;
            mobileNav.querySelectorAll('.nav-link').forEach(btn => {
                if(btn.getAttribute('onclick').includes('logout')) return;
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-bs-target').replace('#', '');
                    this.syncMobileNav(targetId);
                    this.offcanvas.hide();
                });
            });
        },

        syncMobileNav(targetId) {
            const triggerEl = document.querySelector(`#settingsDesktopNav button[data-bs-target="#${targetId}"]`);
            bootstrap.Tab.getInstance(triggerEl).show();
        },

        navigateTo(viewId) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if (viewId === 'settings-view') { app.loadProfile(); app.loadPreferences(); }
        },

        switchAuthTab(tab) {
            const loginWrapper = document.getElementById('loginFormWrapper');
            const regWrapper = document.getElementById('registerFormWrapper');
            const tabsContainer = document.getElementById('authTabs');
            const btns = tabsContainer.querySelectorAll('.auth-tab-btn');
            const card = document.getElementById('authCard');

            // 动画效果：移动背景 pill
            if(tab === 'register') {
                tabsContainer.classList.add('register-mode');
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
            } else {
                tabsContainer.classList.remove('register-mode');
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            }

            // 表单切换逻辑
            card.style.height = card.offsetHeight + 'px';
            const activeWrapper = tab === 'login' ? regWrapper : loginWrapper;
            const nextWrapper = tab === 'login' ? loginWrapper : regWrapper;

            activeWrapper.classList.add('fading');

            setTimeout(() => {
                activeWrapper.classList.add('d-none');
                nextWrapper.classList.remove('d-none');
                nextWrapper.classList.add('fading');

                card.style.height = 'auto';
                nextWrapper.classList.remove('fading');
            }, 200);
        },

        toggleSidebar(e) {
            if(e) e.stopPropagation();
            document.getElementById('chat-view').classList.toggle('sidebar-open');
        },

        // 新增：智能处理侧边栏按钮点击
        handleSidebarToggle() {
            if (window.innerWidth <= 768) {
                // 移动端：关闭/打开整个侧边栏
                this.toggleSidebar();
            } else {
                // 桌面端：切换折叠状态
                this.toggleDesktopSidebar();
            }
        },

        toggleDesktopSidebar() {
            const chatView = document.getElementById('chat-view');
            // 使用 classList toggle 处理折叠状态
            chatView.classList.toggle('sidebar-collapsed');
        },

        handleMainClick() {
            document.getElementById('chat-view').classList.remove('sidebar-open');
            // 注意：这里不移除 sidebar-collapsed，因为那是用户主动选择的状态
        },

        toast(msg, type = 'info') {
            // 防爆逻辑：500ms 内只能弹一个
            const now = Date.now();
            if (now - this.lastToastTime < 500) return;
            this.lastToastTime = now;

            const container = document.getElementById('toastContainer');
            const id = 'toast-' + now;
            const bgClass = type === 'success' ? 'border-success' : (type === 'error' ? 'border-danger' : '');
            const iconClass = type === 'success' ? 'bi-check-circle-fill text-success' : (type === 'error' ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary');

            const html = `
                <div id="${id}" class="toast align-items-center custom-toast ${bgClass} show" role="alert">
                    <div class="d-flex p-3 align-items-center">
                        <i class="bi ${iconClass} fs-5 me-3"></i>
                        <div class="toast-body p-0 fw-medium">${msg}</div>
                        <button type="button" class="btn-close me-2 m-auto" onclick="ui.closeToast('${id}')"></button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            // 3秒后自动关闭，带退出动画
            setTimeout(() => ui.closeToast(id), 3000);
        },

        closeToast(id) {
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.add('hiding');
            el.addEventListener('animationend', () => el.remove());
        },

        confirm(msg, callback) {
            document.getElementById('confirmMessage').innerText = msg;
            this.confirmCallback = callback;
            this.confirmModal.show();
        },

        renderPersonalityGrid() {
            const container = document.getElementById('personalityGrid');
            container.innerHTML = PERSONALITY_OPTIONS.map(p => `
                <div class="col">
                    <div class="persona-card" onclick="ui.selectPersona('${p.id}')" id="card-${p.id}">
                        <i class="bi ${p.icon} fs-2 mb-2 d-block text-primary"></i>
                        <div class="fw-bold">${p.title}</div>
                        <div class="small text-muted mt-1">${p.desc}</div>
                    </div>
                </div>`).join('');
        },

        selectPersona(id) {
            document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected'));
            document.getElementById(`card-${id}`).classList.add('selected');
            const customInput = document.getElementById('customPersonaInputDiv');
            if (id === 'custom') {
                customInput.classList.remove('d-none');
                app.currentPreferences.personalityMode = document.getElementById('psCustomPersona').value || 'custom';
            } else {
                customInput.classList.add('d-none');
                app.currentPreferences.personalityMode = id;
            }
        }
    };

    const app = {
        config: { apiBase: 'http://localhost:8080/api/v1' },
        state: { token: localStorage.getItem('novi_token'), user: {}, sessionId: null, isTyping: false },
        currentPreferences: {},

        init() {
            ui.init();
            this.setupAxios();
            this.bindEvents();
            const isDark = localStorage.getItem('novi_theme') === 'dark';
            document.getElementById('themeSwitch').checked = isDark;
            if(isDark) document.documentElement.setAttribute('data-bs-theme', 'dark');
            if (this.state.token) this.initLoggedInState();
            document.getElementById('psCustomPersona').addEventListener('input', (e) => {
                if (document.getElementById('card-custom').classList.contains('selected')) this.currentPreferences.personalityMode = e.target.value;
            });
        },

        setupAxios() {
            axios.defaults.baseURL = this.config.apiBase;
            axios.interceptors.request.use(c => { if(this.state.token) c.headers.Authorization = `Bearer ${this.state.token}`; return c; });
            axios.interceptors.response.use(r => r, e => { if(e.response?.status === 401) this.logout(); return Promise.reject(e); });
        },

        bindEvents() {
            document.getElementById('loginForm').addEventListener('submit', e => {
                e.preventDefault();
                this.doAuth('/users/login', {
                    username: document.getElementById('loginUser').value,
                    password: document.getElementById('loginPass').value
                });
            });
            document.getElementById('registerForm').addEventListener('submit', e => {
                e.preventDefault();
                this.doAuth('/users/register', {
                    username: document.getElementById('regUser').value,
                    nickname: document.getElementById('regNick').value,
                    email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPass').value
                }, true);
            });
            document.getElementById('themeSwitch').addEventListener('change', e => {
                const theme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('novi_theme', theme);
            });
            document.getElementById('messageInput').addEventListener('keydown', e => {
                if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); }
            });
        },

        async doAuth(url, data, isReg) {
            try {
                const res = await axios.post(url, data);
                if (res.data.code === 1) {
                    if (isReg) {
                        ui.toast('注册成功，请登录', 'success');
                        ui.switchAuthTab('login');
                    } else {
                        this.state.token = res.data.data.token;
                        localStorage.setItem('novi_token', this.state.token);
                        ui.toast('欢迎回来', 'success');
                        setTimeout(() => this.initLoggedInState(true), 500);
                    }
                } else ui.toast(res.data.msg, 'error');
            } catch (e) { ui.toast('请求失败: ' + (e.response?.data?.msg || e.message), 'error'); }
        },

        async initLoggedInState(checkOnboarding = false) {
            ui.navigateTo('chat-view');
            try {
                const me = await axios.get('/users/me');
                this.state.user = me.data.data;
                document.getElementById('userNickDisplay').textContent = this.state.user.nickname || this.state.user.username;
                this.loadSessions();
                if(checkOnboarding) this.checkFirstTimeLogin();
            } catch(e) {}
        },

        async checkFirstTimeLogin() {
            try {
                const res = await axios.get('/preferences');
                const prefs = res.data.data;
                // 逻辑优化：如果还没设置过性格，就弹窗。不再检查 AddressName，因为注册时已有昵称。
                if (!prefs || prefs.personalityMode === 'default') ui.onboardingModal.show();
            } catch(e){}
        },

        async submitOnboarding() {
            const payload = {
                personalityMode: document.getElementById('obPersonality').value, // 使用选择的性格
                userAddressName: this.state.user.nickname, // 默认使用昵称
                toneStyle: 'normal', language: null
            };
            try {
                await axios.put('/preferences', payload);
                ui.onboardingModal.hide();
                this.addMessageBubble('assistant', `你好 ${payload.userAddressName}！设置已更新。`);
            } catch(e) { ui.toast('保存失败', 'error'); }
        },

        async loadProfile() {
            try {
                const res = await axios.get('/users/me');
                const u = res.data.data;
                document.getElementById('pfUsername').value = u.username;
                document.getElementById('pfEmail').value = u.email;
                document.getElementById('pfNickname').value = u.nickname;
                document.getElementById('pfNewPass').value = '';
                document.getElementById('pfCurrentPass').value = '';
            } catch(e){}
        },

        async saveProfile() {
            const data = {
                nickname: document.getElementById('pfNickname').value,
                email: document.getElementById('pfEmail').value,
                newPassword: document.getElementById('pfNewPass').value || null,
                currentPassword: document.getElementById('pfCurrentPass').value || null
            };
            // 如果填写了新密码，必须填写旧密码
            if(data.newPassword && !data.currentPassword) return ui.toast('修改密码需提供旧密码', 'error');
            try {
                await axios.put('/users/me', data);
                ui.toast('资料已更新', 'success');
            } catch(e) { ui.toast(e.response?.data?.msg || '更新失败', 'error'); }
        },

        async loadPreferences() {
            try {
                const res = await axios.get('/preferences');
                const p = res.data.data || {};
                this.currentPreferences = p;
                const isPredefined = PERSONALITY_OPTIONS.some(opt => opt.id === p.personalityMode);
                if (isPredefined) {
                    ui.selectPersona(p.personalityMode || 'default');
                    document.getElementById('psCustomPersona').value = '';
                } else {
                    ui.selectPersona('custom');
                    document.getElementById('psCustomPersona').value = p.personalityMode || '';
                }
                document.getElementById('psTone').value = p.toneStyle || 'normal';
                document.getElementById('psLanguage').value = p.language || '';
                document.getElementById('psAddressName').value = p.userAddressName || '';
            } catch(e){}
        },

        async savePreferences() {
            let pMode = 'default';
            if (document.getElementById('card-custom').classList.contains('selected')) {
                pMode = document.getElementById('psCustomPersona').value || 'custom';
            } else {
                const sel = document.querySelector('.persona-card.selected');
                pMode = sel ? sel.id.replace('card-', '') : 'default';
            }
            const data = {
                personalityMode: pMode,
                toneStyle: document.getElementById('psTone').value,
                language: document.getElementById('psLanguage').value || null,
                userAddressName: document.getElementById('psAddressName').value
            };
            try {
                await axios.put('/preferences', data);
                ui.toast('设置已保存', 'success');
            } catch(e) { ui.toast('保存失败', 'error'); }
        },

        async loadSessions() {
            try {
                const res = await axios.get('/sessions');
                const list = document.getElementById('sessionList');
                list.innerHTML = '';
                if(res.data.code === 1) {
                    res.data.data.forEach(s => {
                        const div = document.createElement('div');
                        div.className = `session-item ${s.id === this.state.sessionId ? 'active' : ''}`;
                        div.onclick = () => this.loadSession(s.id);
                        div.innerHTML = `
                            <div class="text-truncate" style="max-width: 180px;">${s.title||'新会话'}</div>
                            <i class="bi bi-x btn text-muted" onclick="app.deleteSession('${s.id}', event)" style="font-size: 1.1rem;"></i>
                        `;
                        list.appendChild(div);
                    });
                }
            } catch(e){}
        },

        async loadSession(sid) {
            this.state.sessionId = sid;
            this.loadSessions();
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            ui.handleMainClick();
            const res = await axios.get(`/sessions/${sid}/messages`);
            if(res.data.code === 1) res.data.data.forEach(m => this.addMessageBubble(m.role.toLowerCase(), m.content));
            const active = document.querySelector('.session-item.active');
            if(active) document.getElementById('currentTitle').innerText = active.innerText.trim();

            // Scroll to bottom on load
            const win = document.getElementById('chatWindow');
            setTimeout(() => win.scrollTop = win.scrollHeight, 100);
        },

        deleteSession(sid, e) {
            e.stopPropagation();
            ui.confirm('删除此会话？', async () => {
                try {
                    await axios.delete(`/sessions/${sid}`);
                    if(this.state.sessionId === sid) this.startNewChat();
                    else this.loadSessions();
                } catch(e) { ui.toast('删除失败', 'error'); }
            });
        },

        startNewChat() {
            this.state.sessionId = null;
            document.getElementById('currentTitle').innerText = 'Novi AI';
            document.getElementById('chatContainer').innerHTML = `<div class="text-center mt-5 pt-5"><div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem; border:none; background:transparent;"><i class="bi bi-stars text-primary"></i></div><h3 class="fw-bold">你好，我是 Novi</h3><p class="text-muted">我可以帮你写代码、做计划，或者仅仅聊聊天。</p></div>`;
            ui.handleMainClick();
            this.loadSessions();
        },

        async sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if(!msg || this.state.isTyping) return;

            this.addMessageBubble('user', msg);
            input.value = '';
            input.style.height = '56px'; // Reset height
            // 隐藏全屏按钮
            document.getElementById('fullScreenBtn').classList.remove('show');

            // Scroll to bottom
            const win = document.getElementById('chatWindow');
            win.scrollTop = win.scrollHeight;

            const aiId = 'ai-' + Date.now();
            this.addMessageBubble('assistant', '', aiId);
            const bubble = document.getElementById(aiId);
            this.state.isTyping = true;

            try {
                const mode = document.querySelector('input[name="apiMode"]:checked').value;
                const payload = { message: msg, sessionId: this.state.sessionId };

                Typewriter.start(bubble);

                if (mode === 'stream') await this.handleStream(payload);
                else {
                    const res = await axios.post('/chat/send/call', payload);
                    if(res.data.code !== 1) throw new Error(res.data.msg);
                    Typewriter.push(res.data.data.response);
                    if(res.data.data.title) this.updateSessionTitle(res.data.data.sessionId, res.data.data.title);
                }
            } catch(err) {
                Typewriter.stop();
                bubble.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle me-2"></i>${err.message || '网络请求失败'}</span>`;
            } finally {
                if(document.querySelector('input[name="apiMode"]:checked')?.value !== 'stream') {
                    setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; this.loadSessions(); }, 300);
                }
            }
        },

        async handleStream(payload) {
            try {
                const res = await fetch(`${this.config.apiBase}/chat/send/stream`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.state.token}` }, body: JSON.stringify(payload)
                });
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value, {stream:true});
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(!line.trim() || !line.startsWith('data:')) continue;
                        try {
                            const evt = JSON.parse(line.slice(5));
                            if(evt.eventType === 'CONTENT') Typewriter.push(evt.content);
                            else if (evt.eventType === 'METADATA') this.updateSessionTitle(evt.sessionId, evt.title);
                        } catch(e){}
                    }
                }
            } finally {
                setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; this.loadSessions(); }, 300);
            }
        },

        addMessageBubble(role, content, id) {
            const container = document.getElementById('chatContainer');
            if(container.querySelector('.text-center')) container.innerHTML = '';

            const div = document.createElement('div');
            div.className = `message-row ${role}`;

            // 修正头像显示：现在 User 和 AI 都有头像
            const avatar = `<div class="avatar ${role==='user'?'avatar-user':'avatar-ai'}"><i class="bi bi-${role==='user'?'person-fill':'stars'}"></i></div>`;

            const initialHtml = content ? marked.parse(content) : '';

            const bub = `<div class="message-bubble ${role} markdown-body" ${id?`id="${id}" data-raw=""`:''}>${initialHtml}</div>`;

            // 注意顺序：User 头像在右侧由 CSS flex-direction/order 控制，但 DOM 结构统一
            div.innerHTML = avatar + bub;
            container.appendChild(div);
        },

        updateSessionTitle(sid, title) {
            this.state.sessionId = sid;
            if(title) document.getElementById('currentTitle').innerText = title;
        },

        logout() {
            localStorage.removeItem('novi_token');
            location.reload();
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>