<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Novi · AI 挚友 & 智能出题</title>
    <!-- 引入外部库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.css">

    <style>
        /* ================= 1. 核心变量 ================= */
        :root {
            --primary-color: #4e6ef2;
            --bg-body: #f2f4f7;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-header: rgba(255, 255, 255, 0.95);
            --bg-input: #ffffff;
            --bg-input-focus: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #666666;
            --border-color: #e5e7eb;
            --border-input: #e5e7eb;

            --bubble-user-bg: #95ec69;
            --bubble-user-text: #000000;
            --bubble-ai-bg: #ffffff;
            --bubble-ai-text: #1f1f1f;

            --sidebar-width: 280px;
            --sidebar-width-collapsed: 76px;
            --toast-top-mobile: 80px;
        }

        [data-bs-theme="dark"] {
            --bg-body: #111111;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-header: #1e1e1e;
            --bg-input: #2c2c2c;
            --bg-input-focus: #333333;
            --text-main: #e3e3e3;
            --text-sub: #aaaaaa;
            --border-color: #333333;
            --border-input: #444444;

            --bubble-user-bg: #2b7c38;
            --bubble-user-text: #e3e3e3;
            --bubble-ai-bg: #2c2c2c;
            --bubble-ai-text: #e3e3e3;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-body);
            font-family: -apple-system, "Noto Sans SC", "Microsoft YaHei", BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: background-color 0.3s;
            color: var(--text-main);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            color: var(--text-main);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-input-focus);
            border-color: var(--primary-color);
            color: var(--text-main);
            box-shadow: 0 0 0 3px rgba(78, 110, 242, 0.25);
        }

        .view-container {
            width: 100%;
            height: 100%;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: flex !important;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================= 认证视图样式 ================= */
        #auth-view {
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            background-color: var(--bg-sidebar);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .auth-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .auth-form-wrapper {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .auth-form-wrapper.fading {
            opacity: 0;
        }

        .auth-tabs-container {
            position: relative;
            background-color: var(--bg-body);
            border-radius: 50px;
            padding: 4px;
            display: flex;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .auth-tab-bg {
            position: absolute;
            top: 4px;
            left: 4px;
            bottom: 4px;
            width: calc(50% - 4px);
            background-color: var(--bg-card);
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .auth-tabs-container.register-mode .auth-tab-bg {
            transform: translateX(100%);
        }

        .auth-tab-btn {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            z-index: 2;
            transition: color 0.2s;
            background: none;
            border: none;
        }

        .auth-tab-btn.active {
            color: var(--primary-color);
        }

        .password-group .input-group-text {
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            border-left: none;
            color: var(--text-sub);
            cursor: pointer;
        }

        .password-group .form-control {
            border-right: none;
        }

        /* ================= 布局与侧边栏 ================= */
        #chat-view,
        #exam-view {
            flex-direction: row;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.3s ease, transform 0.3s ease;
            flex-shrink: 0;
            height: 100%;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-body);
            position: relative;
            transition: transform 0.3s ease;
            z-index: 50;
            height: 100%;
            overflow: hidden;
        }

        @media (min-width: 769px) {

            #chat-view.sidebar-collapsed .sidebar,
            #exam-view.sidebar-collapsed .sidebar {
                width: var(--sidebar-width-collapsed);
            }

            .sidebar-collapsed .sidebar .text-label,
            .sidebar-collapsed .sidebar #sessionList,
            .sidebar-collapsed .sidebar #examHistoryList,
            .sidebar-collapsed .sidebar #sidebar-chat-elements .d-flex.justify-content-between,
            /* 隐藏管理栏 */
            .sidebar-collapsed .sidebar #sidebar-exam-elements .d-flex.justify-content-between {
                display: none !important;
            }

            .sidebar-collapsed .sidebar .btn-new-chat {
                padding: 0;
                justify-content: center;
            }

            .sidebar-collapsed .sidebar .btn-new-chat i {
                margin-right: 0 !important;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn {
                justify-content: center;
                padding: 0.5rem 0;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn .avatar {
                margin: 0 !important;
            }

            .sidebar-collapsed .sidebar .user-dropdown-btn i.bi-three-dots-vertical {
                display: none;
            }

            .sidebar-collapsed .sidebar .dropdown-menu {
                position: fixed;
                left: calc(var(--sidebar-width-collapsed) + 10px);
                bottom: 70px;
                top: auto;
                width: 200px;
                z-index: 1050;
            }
        }

        .sidebar-toggle-btn {
            background-color: transparent !important;
            color: var(--text-sub);
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            color: var(--text-main);
        }

        [data-bs-theme="dark"] .sidebar-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                border-right: none;
                box-shadow: none;
                width: var(--sidebar-width) !important;
            }

            .sidebar-open .sidebar {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
            }

            .sidebar-open .chat-main::after {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .sidebar .text-label,
            .sidebar #sessionList,
            .sidebar #examHistoryList {
                display: block !important;
            }
        }

        /* 模式切换导航 */
        .mode-nav {
            padding: 0 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .mode-nav-btn {
            border: none;
            background: transparent;
            padding: 10px;
            border-radius: 12px;
            text-align: left;
            color: var(--text-sub);
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .mode-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
        }

        .mode-nav-btn.active {
            background-color: rgba(78, 110, 242, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        .mode-nav-btn i {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        /* ================= 聊天窗口 ================= */
        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem;
            scroll-behavior: auto;
        }

        .chat-container {
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
        }

        .message-row {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .message-row.assistant .avatar {
            margin-right: 12px;
        }

        .message-row.user .avatar {
            margin-left: 12px;
            order: 2;
        }

        .avatar-ai {
            background: #fff;
            color: var(--primary-color);
        }

        .avatar-user {
            background: var(--primary-color);
            color: #fff;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .message-bubble.assistant {
            background: var(--bubble-ai-bg);
            color: var(--bubble-ai-text);
        }

        .message-bubble.user {
            background: var(--bubble-user-bg);
            color: var(--bubble-user-text) !important;
            order: 1;
        }

        .message-bubble.user * {
            color: inherit !important;
            margin-bottom: 0;
        }

        /* ================= 3. 美化后的输入区域 ================= */
        .chat-input-area {
            background-color: var(--bg-body);
            padding: 0 1rem 1.5rem 1rem;
            position: relative;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .input-wrapper {
            width: 100%;
            max-width: 850px;
            background-color: var(--bg-input);
            border-radius: 1.5rem;
            /* 更大圆角 */
            position: relative;
            border: 1px solid var(--border-input);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            /* 柔和阴影 */
            padding: 12px 16px;
        }

        .input-wrapper:focus-within {
            background-color: var(--bg-input-focus);
            box-shadow: 0 8px 24px rgba(78, 110, 242, 0.12);
            /* 聚焦时强调 */
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        #messageInput {
            background: transparent;
            border: none;
            resize: none;
            overflow-y: hidden;
            min-height: 52px;
            max-height: 200px;
            padding: 0;
            width: 100%;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        #messageInput:focus {
            box-shadow: none;
            outline: none;
        }

        /* 输入框底部工具栏 */
        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            /* 极淡分割线 */
        }

        [data-bs-theme="dark"] .input-toolbar {
            border-top-color: rgba(255, 255, 255, 0.05);
        }

        /* 美化后的模型选择器 (Bootstrap Dropdown) */
        .model-selector-btn {
            background-color: rgba(78, 110, 242, 0.08);
            color: var(--primary-color);
            border: 1px solid transparent;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 6px 16px;
            transition: all 0.2s;
        }

        .model-selector-btn:hover,
        .model-selector-btn:focus,
        .model-selector-btn[aria-expanded="true"] {
            background-color: rgba(78, 110, 242, 0.15);
            color: var(--primary-color);
            border-color: rgba(78, 110, 242, 0.1);
        }

        [data-bs-theme="dark"] .model-selector-btn {
            background-color: rgba(78, 110, 242, 0.2);
            color: #8ab4f8;
            /* 亮蓝色，增加对比度 */
        }

        [data-bs-theme="dark"] .model-selector-btn:hover,
        [data-bs-theme="dark"] .model-selector-btn:focus {
            background-color: rgba(78, 110, 242, 0.3);
            color: #aecbfa;
        }

        /* 美化下拉菜单 */
        .model-dropdown-menu {
            border: 1px solid var(--border-color);
            padding: 8px;
            min-width: 200px;
            background-color: var(--bg-card);
        }

        .model-dropdown-menu .dropdown-item {
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: var(--text-main);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .model-dropdown-menu .dropdown-item:hover {
            background-color: rgba(78, 110, 242, 0.08);
            color: var(--primary-color);
        }

        .model-dropdown-menu .dropdown-item.active {
            background-color: rgba(78, 110, 242, 0.15);
            color: var(--primary-color);
            font-weight: 600;
        }

        /* 选中时的对勾 */
        .model-dropdown-menu .dropdown-item.active::after {
            content: '\F26E';
            /* bi-check-lg */
            font-family: 'bootstrap-icons';
            font-size: 1rem;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #fullScreenBtn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-sub);
            background: transparent;
            border: none;
            transition: all 0.2s;
        }

        #fullScreenBtn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
        }

        #sendBtn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            /* 圆角矩形 */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(78, 110, 242, 0.3);
        }

        #sendBtn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        #sendBtn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(78, 110, 242, 0.4);
        }

        /* 会话列表项 */
        .session-item {
            padding: 10px 16px;
            margin: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
            transition: all 0.2s;
            min-height: 44px;
            font-size: 0.9rem;
            position: relative;
            border: 1px solid transparent;
        }

        .session-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* 优化深色模式 Hover 效果 */
        [data-bs-theme="dark"] .session-item:hover {
            background-color: rgba(255, 255, 255, 0.12) !important;
        }

        .session-item.active {
            background-color: rgba(78, 110, 242, 0.1);
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        .session-item.active .text-muted {
            color: var(--primary-color) !important;
        }

        /* 编辑模式下的列表项样式 */
        .session-item.editing-mode {
            cursor: pointer;
        }

        .session-item.item-selected {
            background-color: rgba(78, 110, 242, 0.15) !important;
            border-color: rgba(78, 110, 242, 0.3) !important;
        }

        /* Markdown */
        .markdown-body {
            background-color: transparent !important;
            font-family: inherit !important;
            color: inherit !important;
        }

        .markdown-body pre {
            background-color: rgba(0, 0, 0, 0.05) !important;
            border-radius: 8px;
        }

        [data-bs-theme="dark"] .markdown-body pre {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        .markdown-body p {
            margin-bottom: 0.5rem;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }

        .custom-toast {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-radius: 12px;
            animation: slideInRight 0.3s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .custom-toast.hiding {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* ================= 设置视图 ================= */
        #settings-view {
            background-color: var(--bg-body);
            overflow-y: auto;
        }

        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: 20px;
            border: none;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            margin-bottom: 2rem;
        }

        .nav-pills-settings .nav-link {
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .nav-pills-settings .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .nav-pills-settings .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: bold;
        }

        .persona-card {
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--bg-input);
            height: 100%;
            text-align: center;
            position: relative;
        }

        .persona-card:hover {
            transform: translateY(-2px);
            background-color: var(--bg-input-focus);
            border-color: var(--primary-color);
        }

        .persona-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(78, 110, 242, 0.05);
        }

        .persona-card.selected::after {
            content: '\F26E';
            font-family: 'bootstrap-icons';
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--primary-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.4);
        }

        /* ================= 出题模式样式 ================= */
        .exam-container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .exam-config-panel {
            width: 320px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .exam-preview-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-body);
            position: relative;
        }

        .paper-card {
            background-color: var(--bg-card);
            max-width: 800px;
            margin: 0 auto;
            min-height: 1100px;
            padding: 60px 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 2px;
            color: var(--text-main);
            font-family: "Times New Roman", "SimSun", serif;
        }

        .paper-title {
            text-align: center;
            font-weight: bold;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-family: "SimHei", sans-serif;
        }

        .paper-subtitle {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: var(--text-sub);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1.5rem;
            line-height: 1.6;
        }

        .question-content {
            font-size: 1.15rem;
            line-height: 2;
            text-align: justify;
            margin-bottom: 1rem;
        }

        .blank-space {
            display: inline;
            font-family: "Courier New", monospace;
            color: var(--text-main);
            margin: 0 2px;
            font-weight: bold;
        }

        .exam-meta-tag {
            font-size: 0.9rem;
            padding: 4px 10px;
            background: rgba(78, 110, 242, 0.08);
            color: var(--primary-color);
            border-radius: 4px;
            display: inline-block;
            margin: 0 5px;
            font-family: sans-serif;
        }

        /* 修复深色模式下表格头部的背景色 */
        [data-bs-theme="dark"] .table-light th {
            background-color: #2c2c2c;
            color: var(--text-main);
            border-color: var(--border-color);
        }

        [data-bs-theme="dark"] .table-bordered {
            border-color: var(--border-color);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        [data-bs-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        /* ================= 移动端表格优化 ================= */
        @media (max-width: 768px) {
            .mobile-optimized-table {
                border: none !important;
            }

            .mobile-optimized-table thead {
                display: none;
            }

            .mobile-optimized-table tbody {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .mobile-optimized-table tbody tr {
                display: flex;
                flex-wrap: wrap;
                background-color: var(--bg-input) !important;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            }

            .mobile-optimized-table td {
                border: none !important;
                background: transparent !important;
                padding: 4px 0 !important;
            }

            /* 题号 */
            .mobile-optimized-table td:nth-child(1) {
                width: 40%;
                font-weight: bold;
                color: var(--text-main);
                display: flex;
                align-items: center;
            }

            .mobile-optimized-table td:nth-child(1)::before {
                content: "题号";
                font-size: 0.8rem;
                color: var(--text-sub);
                background: rgba(0, 0, 0, 0.05);
                padding: 2px 6px;
                border-radius: 4px;
                margin-right: 8px;
                font-weight: normal;
            }

            [data-bs-theme="dark"] .mobile-optimized-table td:nth-child(1)::before {
                background: rgba(255, 255, 255, 0.1);
            }

            /* 答案 */
            .mobile-optimized-table td:nth-child(2) {
                width: 60%;
                text-align: right !important;
                font-weight: bold;
                color: var(--primary-color) !important;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            .mobile-optimized-table td:nth-child(2)::before {
                content: "答案";
                font-size: 0.8rem;
                color: var(--text-sub);
                margin-right: 8px;
                font-weight: normal;
            }

            /* 解析 */
            .mobile-optimized-table td:nth-child(3) {
                width: 100%;
                margin-top: 8px;
                padding-top: 8px !important;
                border-top: 1px dashed var(--border-color) !important;
                padding-left: 0 !important;
                /* override ps-4 */
                text-align: justify !important;
                font-size: 0.95rem;
                color: var(--text-sub);
                line-height: 1.6 !important;
            }

            .mobile-optimized-table td:nth-child(3)::before {
                content: "解析：";
                display: block;
                font-weight: bold;
                margin-bottom: 4px;
                color: var(--text-main);
            }
        }

        @media (max-width: 992px) {
            .exam-container {
                flex-direction: column;
                overflow-y: auto;
            }

            .exam-config-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                height: auto;
            }

            .exam-preview-panel {
                height: auto;
                overflow: visible;
            }

            .paper-card {
                padding: 30px;
            }
        }
    </style>
</head>

<body>

    <!-- 全屏输入模态框 -->
    <div class="modal fade" id="fullScreenInputModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: var(--bg-body);">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold">沉浸式编辑</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="container h-100 py-4">
                        <textarea id="fullScreenTextarea" class="form-control border-0 h-100 shadow-none"
                            style="font-size: 1.1rem; background: transparent; resize: none;"
                            placeholder="在这里尽情输入..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4"
                        onclick="ui.submitFullScreenInput()">完成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局提示与确认框 -->
    <div class="toast-container" id="toastContainer"></div>
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content p-3 rounded-4" style="background: var(--bg-card); color: var(--text-main);">
                <div class="modal-body text-center">
                    <h5 class="fw-bold mb-3">确认</h5>
                    <p class="text-muted small mb-4" id="confirmMessage"></p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4" id="confirmBtnAction">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 侧边栏设置菜单 (移动端) -->
    <div class="offcanvas offcanvas-end rounded-start-4" tabindex="-1" id="settingsOffcanvas"
        style="background: var(--bg-card); color: var(--text-main);">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold">设置</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="nav flex-column nav-pills nav-pills-settings gap-2" id="mobileSettingsTabs"></div>
        </div>
    </div>

    <!-- 1. 认证视图 -->
    <div id="auth-view" class="view-container active">
        <div class="auth-card" id="authCard">
            <div class="auth-header">
                <h2 class="fw-bold mb-2" style="color: var(--primary-color);">Novi</h2>
                <p class="text-muted">AI 挚友 · 懂你所想</p>
            </div>
            <div class="auth-tabs-container" id="authTabs">
                <div class="auth-tab-bg"></div>
                <button class="auth-tab-btn active" onclick="ui.switchAuthTab('login')">登录</button>
                <button class="auth-tab-btn" onclick="ui.switchAuthTab('register')">注册</button>
            </div>
            <div id="loginFormWrapper" class="auth-form-wrapper">
                <form id="loginForm">
                    <div class="mb-3"><input type="text" class="form-control rounded-3 px-3 py-2" id="loginUser"
                            placeholder="用户名" required></div>
                    <div class="mb-4">
                        <div class="input-group password-group">
                            <input type="password" class="form-control rounded-start-3 px-3 py-2" id="loginPass"
                                placeholder="密码" required>
                            <span class="input-group-text rounded-end-3"
                                onclick="ui.togglePassword('loginPass', this)"><i class="bi bi-eye-slash"></i></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">进入</button>
                </form>
            </div>
            <div id="registerFormWrapper" class="auth-form-wrapper d-none">
                <form id="registerForm">
                    <div class="mb-2"><input type="text" class="form-control rounded-3" id="regUser" placeholder="用户名"
                            required></div>
                    <div class="mb-2"><input type="text" class="form-control rounded-3" id="regNick" placeholder="昵称"
                            required></div>
                    <div class="mb-2"><input type="email" class="form-control rounded-3" id="regEmail" placeholder="邮箱"
                            required></div>
                    <div class="mb-4">
                        <div class="input-group password-group">
                            <input type="password" class="form-control rounded-start-3" id="regPass" placeholder="密码"
                                required>
                            <span class="input-group-text rounded-end-3" onclick="ui.togglePassword('regPass', this)"><i
                                    class="bi bi-eye-slash"></i></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 shadow-sm">注册</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 侧边栏模板 -->
    <template id="sidebar-template">
        <aside class="sidebar" id="sidebar">
            <div class="p-3 d-flex justify-content-between align-items-center flex-shrink-0">
                <button class="btn rounded-pill text-muted border-0 sidebar-toggle-btn"
                    onclick="ui.handleSidebarToggle()">
                    <i class="bi bi-list fs-5"></i>
                </button>
                <span class="fw-bold ms-2 text-label" style="white-space: nowrap;">功能导航</span>
                <div class="ms-auto"></div>
            </div>

            <!-- 功能切换区 -->
            <div class="mode-nav mt-2 flex-shrink-0">
                <button class="mode-nav-btn active" id="nav-btn-chat" onclick="app.switchMode('chat')">
                    <i class="bi bi-chat-text"></i>
                    <span class="text-label">智能对话</span>
                </button>
                <button class="mode-nav-btn" id="nav-btn-exam" onclick="app.switchMode('exam')">
                    <i class="bi bi-file-earmark-text"></i>
                    <span class="text-label">AI 出题</span>
                </button>
            </div>

            <hr class="mx-3 my-2 flex-shrink-0" style="border-color: var(--border-color);">

            <!-- 1. 聊天模式侧边栏内容 (优化版：添加批量管理) -->
            <div id="sidebar-chat-elements" class="d-flex flex-column flex-grow-1 overflow-hidden"
                style="min-height: 0;">
                <div class="px-3 mb-3 mt-2 flex-shrink-0">
                    <button
                        class="btn btn-primary w-100 rounded-pill py-2 shadow-sm btn-new-chat d-flex align-items-center justify-content-center"
                        onclick="app.startNewChat()">
                        <i class="bi bi-plus-lg me-2"></i>
                        <span class="text-label">新对话</span>
                    </button>
                </div>

                <!-- 头部操作区 -->
                <div class="px-3 mb-2 mt-2 small text-muted text-label fw-bold flex-shrink-0 d-flex justify-content-between align-items-center"
                    style="min-height: 32px;">
                    <span id="chatHistoryTitle">历史记录</span>

                    <!-- 默认视图：显示管理按钮 -->
                    <button class="btn btn-link btn-sm p-0 text-muted text-decoration-none btn-manage-chat"
                        onclick="app.toggleChatEditMode()" style="font-size: 0.85rem;">
                        管理
                    </button>

                    <!-- 编辑视图：显示删除和取消 -->
                    <div class="d-none align-items-center gap-2 chat-edit-controls">
                        <button class="btn btn-danger btn-sm py-0 px-2 rounded-pill btn-batch-delete-chat"
                            onclick="app.deleteSelectedSessions()" style="font-size: 0.8rem;">删除(0)</button>
                        <button class="btn btn-secondary btn-sm py-0 px-2 rounded-pill"
                            onclick="app.toggleChatEditMode()" style="font-size: 0.8rem;">取消</button>
                    </div>
                </div>

                <!-- 全选栏 (仅在编辑模式下显示) -->
                <div class="px-3 mb-2 d-none align-items-center border-bottom pb-2 chat-select-all-bar">
                    <div class="form-check">
                        <input class="form-check-input select-all-chat-top" type="checkbox"
                            onchange="app.toggleSelectAllChat(this)">
                        <label class="form-check-label small text-muted"
                            onclick="this.previousElementSibling.click()">全选会话</label>
                    </div>
                </div>

                <div class="flex-grow-1 overflow-auto px-2" id="sessionList"></div>
            </div>

            <!-- 2. 出题模式侧边栏内容 -->
            <div id="sidebar-exam-elements" class="d-none flex-column flex-grow-1 overflow-hidden"
                style="min-height: 0; position: relative;">

                <!-- 头部操作区 -->
                <div class="px-3 mb-2 mt-2 small text-muted text-label fw-bold flex-shrink-0 d-flex justify-content-between align-items-center"
                    style="min-height: 32px;">
                    <span id="historyHeaderTitle">生成历史</span>

                    <!-- 默认视图：显示管理按钮 -->
                    <button class="btn btn-link btn-sm p-0 text-muted text-decoration-none btn-manage-history"
                        onclick="exam.toggleEditMode()" style="font-size: 0.85rem;">
                        管理
                    </button>

                    <!-- 编辑视图：显示删除和取消 -->
                    <div class="d-none align-items-center gap-2 history-edit-controls">
                        <button class="btn btn-danger btn-sm py-0 px-2 rounded-pill btn-batch-delete"
                            onclick="exam.deleteSelected()" style="font-size: 0.8rem;">删除(0)</button>
                        <button class="btn btn-secondary btn-sm py-0 px-2 rounded-pill" onclick="exam.toggleEditMode()"
                            style="font-size: 0.8rem;">取消</button>
                    </div>
                </div>

                <!-- 全选栏 (仅在编辑模式下显示) -->
                <div class="px-3 mb-2 d-none align-items-center border-bottom pb-2 history-select-all-bar">
                    <div class="form-check">
                        <input class="form-check-input select-all-history-top" type="checkbox"
                            onchange="exam.toggleSelectAll(this)">
                        <label class="form-check-label small text-muted"
                            onclick="this.previousElementSibling.click()">全选所有记录</label>
                    </div>
                </div>

                <div class="flex-grow-1 overflow-auto px-2" id="examHistoryList">
                    <div class="text-center text-muted small mt-4 p-3">暂无生成记录</div>
                </div>
            </div>

            <div class="mt-auto p-3 border-top flex-shrink-0">
                <div class="dropdown dropup w-100" id="userDropdownContainer">
                    <button
                        class="btn w-100 d-flex align-items-center p-2 rounded hover-bg text-start border-0 user-dropdown-btn"
                        data-bs-toggle="dropdown" style="color: var(--text-main);">
                        <div class="avatar avatar-user me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">U
                        </div>
                        <div class="flex-grow-1 overflow-hidden text-label">
                            <div class="fw-bold text-truncate" id="userNickDisplay">User</div>
                        </div>
                        <i class="bi bi-three-dots-vertical text-muted"></i>
                    </button>
                    <ul class="dropdown-menu shadow-lg border-0 rounded-4 mb-2">
                        <li><a class="dropdown-item py-2" href="#" onclick="ui.navigateTo('settings-view')"><i
                                    class="bi bi-gear me-2"></i>设置</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger py-2" href="#" onclick="app.logout()"><i
                                    class="bi bi-box-arrow-right me-2"></i>退出</a></li>
                    </ul>
                </div>
            </div>
        </aside>
    </template>

    <!-- 2. 聊天视图 -->
    <div id="chat-view" class="view-container">
        <!-- Sidebar 会被动态插入到这里 -->
        <main class="chat-main" onclick="ui.handleMainClick(event)">
            <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3"
                style="background: var(--bg-header);">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);"
                        onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                    <h6 class="mb-0 fw-bold" id="currentTitle" style="color: var(--text-main);">Novi AI</h6>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0" title="深色模式">
                        <input class="form-check-input theme-switcher" type="checkbox" id="themeSwitchChat"
                            onchange="ui.toggleTheme(this)">
                        <label class="form-check-label" for="themeSwitchChat"><i class="bi bi-moon-stars"
                                style="color: var(--text-main);"></i></label>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <input type="radio" class="btn-check" name="apiMode" id="modeStream" value="stream" checked>
                        <label class="btn btn-outline-secondary" for="modeStream">流式</label>
                        <input type="radio" class="btn-check" name="apiMode" id="modeCall" value="call">
                        <label class="btn btn-outline-secondary" for="modeCall">普通</label>
                    </div>
                </div>
            </header>

            <div class="chat-window" id="chatWindow">
                <div class="chat-container" id="chatContainer">
                    <div class="text-center mt-5 pt-5">
                        <div class="avatar avatar-ai mx-auto mb-3"
                            style="width: 64px; height: 64px; font-size: 2rem; border: none; background: transparent;">
                            <i class="bi bi-stars text-primary"></i>
                        </div>
                        <h3 class="fw-bold" style="color: var(--text-main);">你好，我是 Novi</h3>
                        <p style="color: var(--text-sub);">我可以帮你写代码、做计划，或者仅仅聊聊天。</p>
                    </div>
                </div>
            </div>

            <!-- 重构后的输入区域：上下分层 + 模型选择 (Dropdown版) -->
            <div class="chat-input-area">
                <div class="input-wrapper">
                    <!-- 上层：文本输入 -->
                    <textarea id="messageInput" class="form-control" rows="1" placeholder="输入消息..."></textarea>

                    <!-- 下层：工具栏 -->
                    <div class="input-toolbar">
                        <!-- 使用 Bootstrap Dropdown 实现更美观的子菜单 -->
                        <div class="model-selector dropdown">
                            <button class="btn rounded-pill model-selector-btn d-flex align-items-center gap-2"
                                type="button" data-bs-toggle="dropdown" aria-expanded="false" id="chatModelBtn">
                                <i class="bi bi-robot"></i> <span id="chatModelLabel">Loading...</span> <i
                                    class="bi bi-chevron-down small opacity-75"></i>
                            </button>
                            <ul class="dropdown-menu model-dropdown-menu shadow-lg rounded-4 p-2"
                                id="chatModelDropdownList">
                                <!-- 动态插入模型选项 -->
                            </ul>
                            <input type="hidden" id="chatModelSelect" value="">
                        </div>

                        <div class="input-actions">
                            <button id="fullScreenBtn" onclick="ui.openFullScreenInput()" title="全屏编辑">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                            <button id="sendBtn" onclick="app.sendMessage()" title="发送消息">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 3. AI 出题视图 -->
    <div id="exam-view" class="view-container">
        <!-- Sidebar 会被动态插入到这里 -->
        <main class="chat-main">
            <header class="chat-header d-flex align-items-center justify-content-between px-4 py-3 border-bottom"
                style="background: var(--bg-header);">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link p-0 me-3 d-md-none" style="color: var(--text-main);"
                        onclick="ui.toggleSidebar(event)"><i class="bi bi-list fs-4"></i></button>
                    <h6 class="mb-0 fw-bold" style="color: var(--text-main);">AI 智能出题助手</h6>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0" title="深色模式">
                        <input class="form-check-input theme-switcher" type="checkbox" id="themeSwitchExam"
                            onchange="ui.toggleTheme(this)">
                        <label class="form-check-label" for="themeSwitchExam"><i class="bi bi-moon-stars"
                                style="color: var(--text-main);"></i></label>
                    </div>
                    <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="exam.reset()">
                        <i class="bi bi-arrow-clockwise me-1"></i> 重置
                    </button>
                </div>
            </header>

            <div class="exam-container">
                <!-- 左侧：配置面板 -->
                <div class="exam-config-panel">
                    <h5 class="fw-bold mb-4">出题配置</h5>
                    <form id="examForm" onsubmit="exam.generate(event)">
                        <!-- 新增：模型选择 -->
                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examModel" aria-label="选择模型">
                                <!-- 动态插入 -->
                            </select>
                            <label for="examModel">AI 模型</label>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examSubject" aria-label="选择科目">
                                <option disabled selected>加载中...</option>
                            </select>
                            <label for="examSubject">选择科目</label>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select rounded-3" id="examType" aria-label="题型">
                                <option disabled selected>请先选择科目</option>
                            </select>
                            <label for="examType">题型</label>
                        </div>

                        <!-- 自定义主题始终显示 -->
                        <div class="form-floating mb-4" id="customTopicDiv">
                            <input type="text" class="form-control rounded-3" id="examTopic" placeholder="例如：科技、文化">
                            <label for="examTopic">自定义主题 (可选)</label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold text-muted">难度系数</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="examDifficulty" id="diffEasy" value="simple"
                                    autocomplete="off">
                                <label class="btn btn-outline-secondary" for="diffEasy">简单</label>

                                <input type="radio" class="btn-check" name="examDifficulty" id="diffMedium"
                                    value="medium" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary" for="diffMedium">标准</label>

                                <input type="radio" class="btn-check" name="examDifficulty" id="diffHard" value="hard"
                                    autocomplete="off">
                                <label class="btn btn-outline-secondary" for="diffHard">困难</label>
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label small fw-bold text-muted">题目数量</label>
                            <input type="number" class="form-control rounded-3" id="examQuantity" value="1" min="1"
                                max="5">
                        </div>

                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm mb-3">
                            <i class="bi bi-magic me-2"></i>生成试题
                        </button>
                    </form>
                </div>

                <!-- 右侧：预览面板 -->
                <div class="exam-preview-panel">
                    <div id="paperLoading" class="loading-overlay d-none">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h5 class="fw-bold">AI 正在根据考纲出题中...</h5>
                            <p class="text-muted small">分析考点 · 组织文本 · 生成解析</p>
                        </div>
                    </div>

                    <div id="paperEmpty"
                        class="h-100 d-flex flex-direction-column align-items-center justify-content-center text-center text-muted">
                        <div>
                            <i class="bi bi-file-earmark-text display-1 opacity-25"></i>
                            <p class="mt-3">在左侧配置参数后点击生成</p>
                        </div>
                    </div>

                    <div id="paperContent" class="d-none">
                        <div class="d-flex justify-content-end mb-3 gap-2">
                            <div class="form-check form-switch pt-2">
                                <input class="form-check-input" type="checkbox" id="showAnswersSwitch"
                                    onchange="exam.toggleAnswers()">
                                <label class="form-check-label" for="showAnswersSwitch">显示解析</label>
                            </div>
                            <button class="btn btn-success rounded-pill px-4" onclick="exam.exportWord()">
                                <i class="bi bi-file-word me-1"></i> 导出 Word
                            </button>
                        </div>

                        <div class="paper-card" id="paperExportArea">
                            <div class="paper-title" id="paperTitleText">AI 智能生成试卷</div>
                            <div id="paperSubtitleContainer" class="paper-subtitle d-none"></div>
                            <div class="text-center mb-4">
                                <span class="exam-meta-tag" id="tagSubject">科目：英语</span>
                                <span class="exam-meta-tag" id="tagType">题型：语法填空</span>
                                <span class="exam-meta-tag" id="tagDiff">难度：标准</span>
                            </div>

                            <div id="paperBody">
                                <!-- JS 渲染内容 -->
                            </div>

                            <div id="paperAnswers" class="mt-5 pt-4 border-top d-none">
                                <div id="answersBody"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 4. 设置视图 -->
    <div id="settings-view" class="view-container">
        <div class="settings-container">
            <div class="mb-4 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <button class="btn btn-icon rounded-circle me-3 hover-bg" onclick="ui.navigateTo('chat-view')"
                        style="width:40px;height:40px;background:var(--bg-input);color:var(--text-main);"><i
                            class="bi bi-arrow-left"></i></button>
                    <h4 class="fw-bold mb-0">设置</h4>
                </div>
                <button class="btn btn-outline-secondary border-0 d-lg-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#settingsOffcanvas">
                    <i class="bi bi-list fs-4"></i>
                </button>
            </div>
            <div class="row g-4">
                <div class="col-lg-3 d-none d-lg-block">
                    <nav class="nav flex-column nav-pills nav-pills-settings" id="settingsDesktopNav">
                        <button class="nav-link active text-start mb-2" data-bs-toggle="pill"
                            data-bs-target="#tab-profile" onclick="ui.syncMobileNav('tab-profile')"><i
                                class="bi bi-person me-2"></i>个人资料</button>
                        <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#tab-persona"
                            onclick="ui.syncMobileNav('tab-persona')"><i class="bi bi-magic me-2"></i>AI 设定</button>
                        <button class="nav-link text-start text-danger mt-4" onclick="app.logout()"><i
                                class="bi bi-box-arrow-left me-2"></i>退出登录</button>
                    </nav>
                </div>
                <div class="col-lg-9">
                    <div class="tab-content" id="settingsTabContent">
                        <div class="tab-pane fade show active" id="tab-profile">
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">个人信息</h5>
                                <form id="profileForm">
                                    <div class="row g-3">
                                        <div class="col-md-6"><label
                                                class="form-label small fw-bold text-muted">用户名</label><input
                                                type="text" class="form-control rounded-3" id="pfUsername" disabled>
                                        </div>
                                        <div class="col-md-6"><label
                                                class="form-label small fw-bold text-muted">昵称</label><input type="text"
                                                class="form-control rounded-3" id="pfNickname"></div>
                                        <div class="col-12"><label
                                                class="form-label small fw-bold text-muted">邮箱</label><input
                                                type="email" class="form-control rounded-3" id="pfEmail"></div>
                                    </div>
                                    <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4"
                                            type="button" onclick="app.saveProfile()">保存更改</button></div>
                                </form>
                            </div>
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4 text-danger">安全设置</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">新密码</label>
                                        <div class="input-group password-group">
                                            <input type="password" class="form-control rounded-start-3" id="pfNewPass"
                                                placeholder="如不修改请留空">
                                            <span class="input-group-text rounded-end-3"
                                                onclick="ui.togglePassword('pfNewPass', this)"><i
                                                    class="bi bi-eye-slash"></i></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">当前密码</label>
                                        <div class="input-group password-group">
                                            <input type="password" class="form-control rounded-start-3"
                                                id="pfCurrentPass" placeholder="修改密码需验证">
                                            <span class="input-group-text rounded-end-3"
                                                onclick="ui.togglePassword('pfCurrentPass', this)"><i
                                                    class="bi bi-eye-slash"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 text-end"><button class="btn btn-outline-danger rounded-pill px-4"
                                        type="button" onclick="app.saveProfile()">修改密码</button></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-persona">
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">核心性格</h5>
                                <div class="row row-cols-2 row-cols-lg-3 g-3 mb-4" id="personalityGrid"></div>
                                <div class="mt-3 d-none" id="customPersonaInputDiv">
                                    <label class="form-label small fw-bold text-muted">自定义 Prompt</label>
                                    <textarea class="form-control rounded-3" id="psCustomPersona" rows="3"
                                        placeholder="输入你想要的 Prompt..."></textarea>
                                </div>
                            </div>
                            <div class="settings-card">
                                <h5 class="fw-bold mb-4">交互偏好</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">回复风格</label>
                                        <select class="form-select rounded-3" id="psTone">
                                            <!-- 动态渲染 -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">语言</label>
                                        <select class="form-select rounded-3" id="psLanguage">
                                            <option value="">自动</option>
                                            <option value="zh_CN">中文</option>
                                            <option value="en_US">English</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-muted">如何称呼你</label>
                                        <input type="text" class="form-control rounded-3" id="psAddressName">
                                    </div>
                                </div>
                                <div class="mt-4 text-end"><button class="btn btn-primary rounded-pill px-4"
                                        onclick="app.savePreferences()">应用设置</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal fade" id="onboardingModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-5 border-0 shadow-lg rounded-5"
                style="background-color: var(--bg-card); color: var(--text-main);">
                <div class="mb-4">
                    <div class="avatar avatar-ai mx-auto"
                        style="width: 80px; height: 80px; font-size: 3rem; background: transparent;"><i
                            class="bi bi-stars text-primary"></i></div>
                </div>
                <h2 class="fw-bold mb-3">欢迎来到 Novi</h2>
                <p class="text-muted mb-5">初次见面，请选择你喜欢的 AI 性格</p>
                <div class="text-start mb-4">
                    <label class="form-label fw-bold small text-muted">性格偏好</label>
                    <select class="form-select form-select-lg rounded-3" id="obPersonality">
                        <option value="default">标准 (平衡理智)</option>
                        <!-- 动态渲染更多选项 -->
                    </select>
                </div>
                <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5"
                    onclick="app.submitOnboarding()">开启旅程</button>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // 图标映射配置
        const ICON_MAP = {
            'default': 'bi-emoji-smile',
            'witty': 'bi-emoji-laughing',
            'gentle': 'bi-flower1',
            'professional': 'bi-briefcase',
            'tsundere': 'bi-lightning',
            'custom': 'bi-pencil-square'
        };

        // 辅助获取图标，如果未配置则返回默认星星
        function getIcon(key) {
            // key 可能是 'personality_witty' 或 'witty'
            const shortKey = key.replace('personality_', '');
            return ICON_MAP[shortKey] || 'bi-stars';
        }

        marked.use({ breaks: true, gfm: true });

        // 打字机效果
        const Typewriter = {
            queue: [], element: null, isTyping: false, timer: null, chatWindow: null, fullText: "",
            start(element) { this.element = element; this.queue = []; this.fullText = ""; this.isTyping = true; this.chatWindow = document.getElementById('chatWindow'); this.processQueue(); },
            push(text) { this.queue.push(...text.split('')); if (!this.isTyping) this.processQueue(); },
            stop() {
                this.isTyping = false; clearTimeout(this.timer);
                if (this.queue.length > 0) { this.fullText += this.queue.join(''); this.queue = []; }
                if (this.element) this.render(this.fullText || (this.element.dataset.raw || ''));
            },
            processQueue() {
                if (this.queue.length === 0) { if (!this.isTyping) return; this.timer = setTimeout(() => this.processQueue(), 50); return; }
                const speed = this.queue.length > 50 ? 5 : (this.queue.length > 20 ? 15 : 30);
                let chunk = ''; for (let i = 0; i < (this.queue.length > 100 ? 10 : 2) && this.queue.length > 0; i++) chunk += this.queue.shift();
                this.fullText += chunk; this.render(this.fullText); this.timer = setTimeout(() => this.processQueue(), speed);
            },
            render(rawText) {
                if (!this.element) return; this.element.dataset.raw = rawText; this.element.innerHTML = marked.parse(rawText);
                const win = this.chatWindow; if (!win) return;
                if (win.scrollHeight - win.scrollTop - win.clientHeight < 150) win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
            }
        };

        const ui = {
            confirmModal: null, offcanvas: null, confirmCallback: null, fullScreenModal: null, lastToastTime: 0,

            init() {
                this.confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                this.offcanvas = new bootstrap.Offcanvas(document.getElementById('settingsOffcanvas'));
                this.fullScreenModal = new bootstrap.Modal(document.getElementById('fullScreenInputModal'));

                document.getElementById('confirmBtnAction').addEventListener('click', () => { if (this.confirmCallback) this.confirmCallback(); this.confirmModal.hide(); });
                // renderPersonalityGrid 现在由 app.loadSystemConfigs 调用
                this.initMobileSettingsNav();
                this.renderSidebar();

                const msgInput = document.getElementById('messageInput');
                // 移除旧的全屏按钮检测逻辑，因为现在按钮是固定的
                if (msgInput) {
                    msgInput.addEventListener('input', function () {
                        this.style.height = 'auto';
                        // 限制最大高度，避免撑破布局
                        const newHeight = Math.min(this.scrollHeight, 200);
                        this.style.height = (this.value === '' ? '52px' : newHeight + 'px');
                    });
                    msgInput.style.height = '52px';
                }
            },

            // 渲染侧边栏（同时注入到 Chat 和 Exam 视图）
            renderSidebar() {
                const tpl = document.getElementById('sidebar-template').content;
                const chatSide = document.querySelector('#chat-view');
                if (chatSide && !chatSide.querySelector('.sidebar')) chatSide.prepend(tpl.cloneNode(true));
                const examSide = document.querySelector('#exam-view');
                if (examSide && !examSide.querySelector('.sidebar')) examSide.prepend(tpl.cloneNode(true));
            },

            // 更新侧边栏状态（根据当前模式显示不同内容）
            updateSidebarState(mode) {
                document.querySelectorAll('.mode-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll(`#nav-btn-${mode}`).forEach(btn => btn.classList.add('active'));
                // 切换侧边栏列表内容
                const showId = `sidebar-${mode}-elements`;
                document.querySelectorAll(`[id^="sidebar-"][id$="-elements"]`).forEach(el => el.classList.add('d-none'));
                document.querySelectorAll(`#${showId}`).forEach(el => {
                    el.classList.remove('d-none');
                    el.classList.add('d-flex');
                });
            },

            togglePassword(inputId, btn) {
                const input = document.getElementById(inputId); const icon = btn.querySelector('i');
                if (input.type === 'password') { input.type = 'text'; icon.classList.replace('bi-eye-slash', 'bi-eye'); } else { input.type = 'password'; icon.classList.replace('bi-eye', 'bi-eye-slash'); }
            },
            openFullScreenInput() { document.getElementById('fullScreenTextarea').value = document.getElementById('messageInput').value; this.fullScreenModal.show(); },
            submitFullScreenInput() { const mainInput = document.getElementById('messageInput'); mainInput.value = document.getElementById('fullScreenTextarea').value; mainInput.dispatchEvent(new Event('input')); this.fullScreenModal.hide(); mainInput.focus(); },
            initMobileSettingsNav() {
                const desktopNav = document.getElementById('settingsDesktopNav'); const mobileNav = document.getElementById('mobileSettingsTabs');
                mobileNav.innerHTML = desktopNav.innerHTML;
                mobileNav.querySelectorAll('.nav-link').forEach(btn => {
                    if (btn.getAttribute('onclick').includes('logout')) return;
                    btn.addEventListener('click', (e) => { this.syncMobileNav(e.currentTarget.getAttribute('data-bs-target').replace('#', '')); this.offcanvas.hide(); });
                });
            },
            syncMobileNav(targetId) { const triggerEl = document.querySelector(`#settingsDesktopNav button[data-bs-target="#${targetId}"]`); bootstrap.Tab.getInstance(triggerEl).show(); },

            navigateTo(viewId) {
                document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if (viewId === 'settings-view') { app.loadProfile(); app.loadPreferences(); }
            },

            switchAuthTab(tab) {
                const loginWrapper = document.getElementById('loginFormWrapper'); const regWrapper = document.getElementById('registerFormWrapper');
                const tabsContainer = document.getElementById('authTabs'); const btns = tabsContainer.querySelectorAll('.auth-tab-btn'); const card = document.getElementById('authCard');
                if (tab === 'register') { tabsContainer.classList.add('register-mode'); btns[0].classList.remove('active'); btns[1].classList.add('active'); } else { tabsContainer.classList.remove('register-mode'); btns[0].classList.add('active'); btns[1].classList.remove('active'); }
                card.style.height = card.offsetHeight + 'px';
                const activeWrapper = tab === 'login' ? regWrapper : loginWrapper; const nextWrapper = tab === 'login' ? loginWrapper : regWrapper;
                activeWrapper.classList.add('fading');
                setTimeout(() => { activeWrapper.classList.add('d-none'); nextWrapper.classList.remove('d-none'); nextWrapper.classList.add('fading'); card.style.height = 'auto'; nextWrapper.classList.remove('fading'); }, 200);
            },

            toggleSidebar(e) { if (e) e.stopPropagation(); document.querySelectorAll('.view-container.active').forEach(el => el.classList.toggle('sidebar-open')); },
            handleSidebarToggle() {
                if (window.innerWidth <= 768) this.toggleSidebar();
                else {
                    document.getElementById('chat-view').classList.toggle('sidebar-collapsed');
                    document.getElementById('exam-view').classList.toggle('sidebar-collapsed');
                }
            },
            handleMainClick() { document.querySelectorAll('.view-container').forEach(el => el.classList.remove('sidebar-open')); },

            toast(msg, type = 'info') {
                const now = Date.now(); if (now - this.lastToastTime < 500) return; this.lastToastTime = now;
                const container = document.getElementById('toastContainer'); const id = 'toast-' + now;
                const bgClass = type === 'success' ? 'border-success' : (type === 'error' ? 'border-danger' : '');
                const iconClass = type === 'success' ? 'bi-check-circle-fill text-success' : (type === 'error' ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary');
                const html = `<div id="${id}" class="toast align-items-center custom-toast ${bgClass} show" role="alert"><div class="d-flex p-3 align-items-center"><i class="bi ${iconClass} fs-5 me-3"></i><div class="toast-body p-0 fw-medium">${msg}</div><button type="button" class="btn-close me-2 m-auto" onclick="ui.closeToast('${id}')"></button></div></div>`;
                container.insertAdjacentHTML('beforeend', html); setTimeout(() => ui.closeToast(id), 3000);
            },
            closeToast(id) { const el = document.getElementById(id); if (!el) return; el.classList.add('hiding'); el.addEventListener('animationend', () => el.remove()); },
            confirm(msg, callback) { document.getElementById('confirmMessage').innerText = msg; this.confirmCallback = callback; this.confirmModal.show(); },

            // 动态渲染性格卡片
            renderPersonalityGrid(list) {
                const container = document.getElementById('personalityGrid');
                if (!container) return;

                // 先渲染从后端获取的性格
                let html = list.map(p => {
                    // 去除 'personality_' 前缀作为 ID
                    const id = p.configKey.replace('personality_', '');
                    const icon = getIcon(p.configKey);
                    // description 字段通常是性格描述，configValue 是详细prompt
                    // 这里我们假设 description 是短标题或描述
                    const title = p.description ? p.description.split('性格')[0] : id; // 简单处理标题
                    const desc = p.configValue.length > 20 ? p.configValue.substring(0, 20) + '...' : p.configValue;

                    return `<div class="col"><div class="persona-card" onclick="ui.selectPersona('${id}')" id="card-${id}"><i class="bi ${icon} fs-2 mb-2 d-block text-primary"></i><div class="fw-bold">${title}</div><div class="small text-muted mt-1 text-truncate">${desc}</div></div></div>`;
                }).join('');

                // 追加自定义卡片
                html += `<div class="col"><div class="persona-card" onclick="ui.selectPersona('custom')" id="card-custom"><i class="bi bi-pencil-square fs-2 mb-2 d-block text-primary"></i><div class="fw-bold">自定义</div><div class="small text-muted mt-1">完全由你决定</div></div></div>`;

                container.innerHTML = html;

                // 同时更新 Onboarding 弹窗中的下拉框
                const obSelect = document.getElementById('obPersonality');
                if (obSelect) {
                    let optionsHtml = list.map(p => {
                        const id = p.configKey.replace('personality_', '');
                        const title = p.description || id;
                        return `<option value="${id}">${title}</option>`;
                    }).join('');
                    obSelect.innerHTML = optionsHtml;
                }
            },

            // 动态渲染语气选项
            renderToneOptions(list) {
                const select = document.getElementById('psTone');
                if (!select) return;
                let html = '';
                list.forEach(t => {
                    // 去除 'tone_' 前缀作为 value
                    const value = t.configKey.replace('tone_', '');
                    // 简单的描述处理
                    let label = t.description || value;
                    html += `<option value="${value}">${label}</option>`;
                });
                select.innerHTML = html;
            },

            // 动态渲染模型列表 (同时更新聊天和出题界面)
            renderModelList(models) {
                // 1. 聊天界面的 Dropdown
                const chatDropdown = document.getElementById('chatModelDropdownList');
                if (chatDropdown) {
                    let chatHtml = '';
                    models.forEach(m => {
                        // 默认选中激活的模型
                        const activeClass = m.isActive ? 'active' : '';
                        chatHtml += `<li><button class="dropdown-item rounded-3 ${activeClass}" type="button" onclick="app.setChatModel('${m.modelName}', '${m.description || m.modelName}', this)">${m.description || m.modelName}</button></li>`;

                        // 如果当前是激活模型，初始化按钮显示
                        if (m.isActive && !localStorage.getItem('novi_chat_model')) {
                            const label = document.getElementById('chatModelLabel');
                            const input = document.getElementById('chatModelSelect');
                            if (label) label.innerText = m.description || m.modelName;
                            if (input) input.value = m.modelName;
                        }
                    });
                    chatDropdown.innerHTML = chatHtml;
                }

                // 2. 出题界面的 Select
                const examSelect = document.getElementById('examModel');
                if (examSelect) {
                    let examHtml = '';
                    let defaultModel = null;

                    models.forEach(m => {
                        examHtml += `<option value="${m.modelName}">${m.description || m.modelName}</option>`;
                        // 记录激活的模型作为默认值
                        if (m.isActive) {
                            defaultModel = m.modelName;
                        }
                    });
                    examSelect.innerHTML = examHtml;

                    // 恢复之前的选择，如果没有则使用默认激活的模型
                    const savedExamModel = localStorage.getItem('novi_exam_model');
                    if (savedExamModel) {
                        examSelect.value = savedExamModel;
                    } else if (defaultModel) {
                        examSelect.value = defaultModel;
                        localStorage.setItem('novi_exam_model', defaultModel);
                    }
                }
            },

            selectPersona(id) {
                document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected'));
                const card = document.getElementById(`card-${id}`);
                if (card) card.classList.add('selected');

                const customInput = document.getElementById('customPersonaInputDiv');
                if (customInput) {
                    if (id === 'custom') {
                        customInput.classList.remove('d-none');
                        app.currentPreferences.personalityMode = document.getElementById('psCustomPersona').value || 'custom';
                    } else {
                        customInput.classList.add('d-none');
                        app.currentPreferences.personalityMode = id;
                    }
                }
            },
            toggleTheme(el) {
                const theme = el.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('novi_theme', theme);
                // 同步所有开关状态
                document.querySelectorAll('.theme-switcher').forEach(chk => chk.checked = el.checked);
            }
        };

        /* ================= AI 出题模块逻辑 ================= */
        /* ================= AI 出题模块逻辑 (优化版) ================= */
        const exam = {
            data: null,
            isEditMode: false,

            init() {
                // 监听题型选择，控制主题输入框显示
                const typeSelect = document.getElementById('examType');
                const topicDiv = document.getElementById('customTopicDiv');
                if (topicDiv) {
                    topicDiv.classList.remove('d-none');
                }
                if (typeSelect && topicDiv) {
                    typeSelect.addEventListener('change', (e) => {
                        if (['阅读理解', '选择题', '语法填空'].includes(e.target.value)) topicDiv.classList.remove('d-none');
                        else topicDiv.classList.add('d-none');
                    });
                }

                // 持久化 AI 模型选择
                const savedModel = localStorage.getItem('novi_exam_model');
                if (savedModel) {
                    const select = document.getElementById('examModel');
                    if (select) select.value = savedModel;
                }
                const modelSelect = document.getElementById('examModel');
                if (modelSelect) {
                    modelSelect.addEventListener('change', (e) => {
                        localStorage.setItem('novi_exam_model', e.target.value);
                    });
                }
            },

            // 加载科目列表
            async loadSubjects() {
                try {
                    // 修正 API 路径：移除 /v1 前缀
                    const apiRoot = app.config.apiBase.replace('/v1', '');
                    const res = await axios.get(`${apiRoot}/question/categories/subjects`);

                    if (res.data.code === 200 || res.data.code === 1) {
                        const subjects = res.data.data || [];
                        const select = document.getElementById('examSubject');
                        if (select && subjects.length > 0) {
                            select.innerHTML = subjects.map(s => `<option value="${s.name}" data-id="${s.id}">${s.name}</option>`).join('');

                            // 绑定变更事件
                            select.onchange = (e) => {
                                const opt = e.target.options[e.target.selectedIndex];
                                if (opt) this.loadTypes(opt.getAttribute('data-id'));
                            };

                            // 默认加载第一个科目的题型
                            this.loadTypes(subjects[0].id);
                        }
                    }
                } catch (e) {
                    console.error("加载科目失败", e);
                    ui.toast('加载科目数据失败', 'error');
                }
            },

            // 加载题型列表
            async loadTypes(subjectId) {
                if (!subjectId) return;
                try {
                    const apiRoot = app.config.apiBase.replace('/v1', '');
                    const res = await axios.get(`${apiRoot}/question/categories/types?subjectId=${subjectId}`);

                    if (res.data.code === 200 || res.data.code === 1) {
                        const types = res.data.data || [];
                        const select = document.getElementById('examType');
                        if (select) {
                            select.innerHTML = types.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
                            // 触发 change 事件以更新 UI（如显示/隐藏主题输入框）
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                } catch (e) {
                    console.error("加载题型失败", e);
                }
            },

            // 生成试卷 (调用后端 API)
            async generate(e) {
                e.preventDefault();
                const subject = document.getElementById('examSubject').value;
                const questionType = document.getElementById('examType').value;
                const theme = document.getElementById('examTopic').value;
                const difficulty = document.querySelector('input[name="examDifficulty"]:checked').value;
                const quantity = document.getElementById('examQuantity').value;
                const model = document.getElementById('examModel').value;

                document.getElementById('paperLoading').classList.remove('d-none');
                document.getElementById('paperEmpty').classList.add('d-none');
                document.getElementById('paperContent').classList.add('d-none');

                try {
                    const res = await axios.post('/questions/generate', {
                        subject, questionType, theme, difficulty, quantity: parseInt(quantity), model
                    });

                    if (res.data.code === 200 || res.data.code === 1) {
                        const result = res.data.data;
                        let questions = [];

                        // 解析后端数据
                        try {
                            const parsed = (typeof result.questions === 'string') ? JSON.parse(result.questions) : result.questions;
                            if (Array.isArray(parsed)) {
                                questions = parsed;
                            } else {
                                questions = [parsed];
                            }
                        } catch (err) {
                            console.error("JSON Parse Error", err);
                            throw new Error("题目数据解析失败");
                        }

                        this.data = { questions, recordId: result.recordId };

                        this.renderPaper(this.data);
                        this.loadHistory();
                        ui.toast('试卷生成成功！', 'success');
                    } else {
                        throw new Error(res.data.msg || '生成失败');
                    }
                } catch (err) {
                    ui.toast(err.message || '网络请求失败', 'error');
                    document.getElementById('paperEmpty').classList.remove('d-none');
                } finally {
                    document.getElementById('paperLoading').classList.add('d-none');
                    if (this.data) document.getElementById('paperContent').classList.remove('d-none');
                }
            },

            // 加载出题历史 (保持不变)
            async loadHistory() {
                try {
                    const res = await axios.get('/questions/history');
                    const lists = document.querySelectorAll('#examHistoryList');
                    if (res.data.code === 200 || res.data.code === 1) {
                        const html = res.data.data.map(item => {
                            const timeStr = new Date(item.createdAt).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            const themeDisplay = item.theme ? ` | ${item.theme}` : '';
                            const typeDisplay = item.questionType === '语法填空' ? '语法填空' : item.questionType;

                            return `
                            <div class="session-item d-flex align-items-center ${this.isEditMode ? 'editing-mode' : ''}"
                                 onclick="exam.handleItemClick(${item.id}, event)"
                                 data-id="${item.id}">
                                <div class="form-check me-2 d-none history-checkbox-wrapper">
                                    <input class="form-check-input history-checkbox" type="checkbox" value="${item.id}" onclick="event.stopPropagation(); exam.updateSelectionUI()">
                                </div>
                                <div class="d-flex flex-column w-100" style="pointer-events: none;">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold text-truncate" style="max-width: 140px;">${typeDisplay}${themeDisplay}</span>
                                        <div class="d-flex align-items-center">
                                             <span class="small text-muted me-2">${timeStr}</span>
                                             <i class="bi bi-x btn text-muted p-0 history-delete-btn" style="font-size: 1.1rem; pointer-events: auto;" onclick="exam.deleteRecord(${item.id}, event)"></i>
                                        </div>
                                    </div>
                                    <div class="small text-muted text-truncate">${item.subject} · ${item.difficulty}</div>
                                </div>
                            </div>`;
                        }).join('');
                        lists.forEach(el => el.innerHTML = html || '<div class="text-center text-muted small mt-4 p-3">暂无生成记录</div>');

                        if (this.isEditMode) {
                            this.applyEditModeStyles(true);
                        }
                    }
                } catch (e) { console.error('History Load Failed', e); }
            },

            toggleEditMode() {
                this.isEditMode = !this.isEditMode;
                this.applyEditModeStyles(this.isEditMode);
            },

            applyEditModeStyles(isEdit) {
                const toggle = (selector, show) => {
                    document.querySelectorAll(selector).forEach(el => {
                        if (show) {
                            el.classList.remove('d-none');
                            if (el.classList.contains('history-edit-controls') || el.classList.contains('history-select-all-bar')) {
                                el.classList.add('d-flex');
                            }
                        } else {
                            el.classList.add('d-none');
                            el.classList.remove('d-flex');
                        }
                    });
                };

                toggle('.btn-manage-history', !isEdit);
                toggle('.history-edit-controls', isEdit);
                toggle('.history-select-all-bar', isEdit);

                document.querySelectorAll('#examHistoryList .session-item').forEach(item => {
                    if (isEdit) item.classList.add('editing-mode');
                    else item.classList.remove('editing-mode', 'item-selected');
                });

                document.querySelectorAll('.history-checkbox-wrapper').forEach(el => {
                    if (isEdit) el.classList.remove('d-none'); else el.classList.add('d-none');
                });

                document.querySelectorAll('.history-delete-btn').forEach(el => {
                    if (isEdit) el.classList.add('d-none'); else el.classList.remove('d-none');
                });

                if (!isEdit) {
                    document.querySelectorAll('.history-checkbox').forEach(chk => chk.checked = false);
                    document.querySelectorAll('.select-all-history-top').forEach(chk => chk.checked = false);
                    this.updateSelectionUI();
                }
            },

            handleItemClick(id, event) {
                if (this.isEditMode) {
                    if (event.target.type === 'checkbox') return;
                    const checkbox = event.currentTarget.querySelector('.history-checkbox');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        this.updateSelectionUI();
                    }
                } else {
                    this.loadRecord(id);
                }
            },

            toggleSelectAll(source) {
                document.querySelectorAll('.history-checkbox').forEach(chk => chk.checked = source.checked);
                document.querySelectorAll('.select-all-history-top').forEach(chk => chk.checked = source.checked);
                this.updateSelectionUI();
            },

            updateSelectionUI() {
                const checkboxes = document.querySelectorAll('.history-checkbox');
                let count = 0;
                const checkedIds = new Set();

                checkboxes.forEach(chk => {
                    const item = chk.closest('.session-item');
                    if (chk.checked) {
                        checkedIds.add(chk.value);
                        if (item) item.classList.add('item-selected');
                    } else {
                        if (item) item.classList.remove('item-selected');
                    }
                });

                count = checkedIds.size;
                document.querySelectorAll('.btn-batch-delete').forEach(btn => {
                    btn.textContent = `删除(${count})`;
                });
            },

            async deleteSelected() {
                const checked = document.querySelectorAll('.history-checkbox:checked');
                if (checked.length === 0) return ui.toast('请先选择记录', 'info');
                const ids = [...new Set(Array.from(checked).map(cb => cb.value))];
                const confirmMsg = `确认删除这 ${ids.length} 条记录吗？`;

                ui.confirm(confirmMsg, async () => {
                    try {
                        const promises = ids.map(id => axios.delete(`/questions/history/${id}`));
                        await Promise.all(promises);
                        ui.toast(`成功删除 ${ids.length} 条记录`, 'success');
                        if (this.data && ids.includes(String(this.data.recordId))) {
                            this.reset();
                        }
                        this.loadHistory();
                        this.toggleEditMode();
                    } catch (e) {
                        ui.toast('批量删除过程中出现错误', 'error');
                        this.loadHistory();
                    }
                });
            },

            deleteRecord(id, e) {
                e.stopPropagation();
                ui.confirm('确认删除这条出题记录吗？', async () => {
                    try {
                        await axios.delete(`/questions/history/${id}`);
                        this.loadHistory();
                        if (this.data && this.data.recordId === id) {
                            this.reset();
                        }
                        ui.toast('删除成功', 'success');
                    } catch (e) {
                        ui.toast('删除失败', 'error');
                    }
                });
            },

            async loadRecord(id) {
                if (this.isEditMode) return;
                try {
                    const res = await axios.get(`/questions/history/${id}`);
                    if (res.data.code === 200 || res.data.code === 1) {
                        const result = res.data.data;
                        let questions = [];
                        try {
                            const parsed = (typeof result.questions === 'string') ? JSON.parse(result.questions) : result.questions;
                            questions = Array.isArray(parsed) ? parsed : [parsed];
                        } catch (err) {
                            questions = [];
                        }

                        this.data = { questions, recordId: result.recordId };
                        document.getElementById('paperEmpty').classList.add('d-none');
                        document.getElementById('paperContent').classList.remove('d-none');
                        this.renderPaper(this.data);
                        if (window.innerWidth <= 768) ui.handleMainClick();
                    }
                } catch (e) { ui.toast('加载失败', 'error'); }
            },

            parseListToMap(text) {
                if (!text || typeof text !== 'string') return {};
                const map = {};
                const regex = /(\d+)\s*[\.、]/g;
                let match;
                const indices = [];
                while ((match = regex.exec(text)) !== null) {
                    const num = parseInt(match[1]);
                    if (num > 0 && num < 100) {
                        indices.push({
                            num: num,
                            start: regex.lastIndex,
                            matchStart: match.index
                        });
                    }
                }
                if (indices.length === 0) return {};
                for (let i = 0; i < indices.length; i++) {
                    const current = indices[i];
                    const next = indices[i + 1];
                    const end = next ? next.matchStart : text.length;
                    let content = text.substring(current.start, end).trim();
                    content = content.replace(/^[;；\.,，]+/, '').replace(/[;；\.,，]+$/, '');
                    if (content) {
                        map[current.num] = content;
                    }
                }
                return map;
            },

            // ================= 核心修改：渲染试卷 (支持新格式) =================
            renderPaper(data) {
                const questions = data.questions;
                const paperBody = document.getElementById('paperBody');
                const answersBody = document.getElementById('answersBody');

                paperBody.innerHTML = '';
                answersBody.innerHTML = '';

                // 初始化试卷基础信息
                if (questions && questions.length > 0) {
                    const meta = questions[0];
                    document.getElementById('paperTitleText').innerText = meta.title || 'AI 智能生成试卷';
                    document.getElementById('tagType').innerText = `包含题型：${questions.length} 种`;
                    // 默认显示难度，取第一个题目的instruction作为副标题（如果有）
                    const subtitleEl = document.getElementById('paperSubtitleContainer');
                    if (meta.instruction) {
                        // 不在这里显示instruction，因为每个Part都有自己的instruction，放在Part内部渲染
                        subtitleEl.classList.add('d-none');
                    } else {
                        subtitleEl.classList.add('d-none');
                    }
                    document.getElementById('tagDiff').innerText = `难度：标准`;
                }

                let contentHtml = '';
                let answersContainerHtml = '';

                questions.forEach((q, index) => {
                    let partItems = []; // 当前大题的所有小题答案

                    // --- 渲染标题和指导语 ---
                    const partTitle = q.title || `Part ${index + 1}`;
                    const instruction = q.instruction ? `<div class="text-muted small mb-3 border-start border-4 border-primary ps-2">${q.instruction}</div>` : '';

                    contentHtml += `<div class="mb-5"><h4 class="fw-bold mb-3">${partTitle}</h4>${instruction}`;

                    // --- 根据 ui_type 渲染不同题型 ---
                    switch (q.ui_type) {
                        case 'cloze_passage':
                        case 'reading_cloze':
                            // 1. 填空类题型：文章即题干，需替换 [[__id__]]
                            let stemHtml = q.stem || '';

                            // 正则替换 [[__123__]] 为可视化下划线
                            stemHtml = stemHtml.replace(/\[\[__(\d+)__\]\]/g, (match, id) => {
                                return `<span class="fw-bold mx-1 text-primary">[${id}]</span><span class="blank-space border-bottom border-dark d-inline-block text-center" style="min-width: 60px; height: 1.5em; vertical-align: bottom;"></span>`;
                            });

                            contentHtml += `<div class="question-content lh-lg">${stemHtml}</div>`;

                            // 收集答案 (q.answers 数组结构)
                            if (Array.isArray(q.answers)) {
                                q.answers.forEach(a => {
                                    partItems.push({
                                        num: a.index,
                                        ans: a.correct,
                                        ana: a.analysis
                                    });
                                });
                            }
                            break;

                        case 'sort_sentence':
                            // 2. 连词成句：题干是打乱的词，需要提供书写横线
                            const words = q.stem.split('/').map(w => `<span class="badge bg-light text-dark border me-1 mb-1 fw-normal fs-6">${w.trim()}</span>`).join(' ');

                            contentHtml += `
                                <div class="card bg-light border-0 mb-3">
                                    <div class="card-body text-center">
                                        <div class="mb-3 d-flex flex-wrap justify-content-center">${words}</div>
                                    </div>
                                </div>
                                <div class="mb-2"><strong>Your Answer:</strong></div>
                                <div class="border-bottom border-secondary mb-4" style="height: 30px;"></div>
                            `;

                            // 收集答案 (q.answer 对象结构)
                            if (q.answer) {
                                partItems.push({
                                    num: index + 1, // 排序题通常作为单题，直接用大题索引或自定义逻辑
                                    ans: q.answer.correct,
                                    ana: q.answer.analysis
                                });
                            }
                            break;

                        default:
                            // 3. 兼容旧格式或未知格式
                            let oldText = (q.article_content || q.content || '').replace(/\n/g, '<br>');
                            // 简单的下划线替换兼容
                            oldText = oldText.replace(/_+/g, '<span class="blank-space">__________</span>');
                            contentHtml += `<div class="question-content">${oldText}</div>`;

                            // 尝试解析旧格式答案
                            if (q.answer) {
                                if (Array.isArray(q.answer)) {
                                    q.answer.forEach((a, i) => partItems.push({ num: i + 1, ans: a, ana: q.analysis?.[i] }));
                                } else if (typeof q.answer === 'string') {
                                    partItems.push({ num: index + 1, ans: q.answer, ana: q.analysis });
                                }
                            }
                            break;
                    }

                    contentHtml += `</div>`; // Close Part Div

                    // --- 构建该部分的答案表格 ---
                    if (partItems.length > 0) {
                        if (index > 0) answersContainerHtml += '<hr class="my-5">';

                        answersContainerHtml += `<div class="mb-4"><h6 class="fw-bold text-secondary mb-3">${partTitle} 参考答案</h6>`;
                        answersContainerHtml += `
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle mb-0 mobile-optimized-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px;" class="text-center">#</th>
                                        <th style="width: 25%;" class="text-center">答案</th>
                                        <th class="text-start ps-4">解析</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        partItems.forEach(item => {
                            answersContainerHtml += `
                                <tr>
                                    <td class="text-center fw-bold text-secondary">${item.num}</td>
                                    <td class="text-center text-primary fw-bold text-break">${item.ans}</td>
                                    <td class="text-muted small text-break text-start ps-4" style="line-height: 1.6;">${item.ana || '暂无解析'}</td>
                                </tr>`;
                        });

                        answersContainerHtml += `</tbody></table></div></div>`;
                    }
                });

                paperBody.innerHTML = contentHtml;
                answersBody.innerHTML = answersContainerHtml;

                document.getElementById('showAnswersSwitch').checked = false;
                document.getElementById('paperAnswers').classList.add('d-none');
            },

            toggleAnswers() {
                const show = document.getElementById('showAnswersSwitch').checked;
                const el = document.getElementById('paperAnswers');
                if (show) el.classList.remove('d-none'); else el.classList.add('d-none');
            },

            reset() {
                document.getElementById('paperContent').classList.add('d-none');
                document.getElementById('paperEmpty').classList.remove('d-none');
                document.getElementById('examForm').reset();
            },

            exportWord() {
                // 导出逻辑基本保持不变，因为是基于 innerHTML 导出的
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title></head><body>";
                const footer = "</body></html>";
                const styles = `
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    .paper-title { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 20px; }
                    .question-content { text-indent: 0; line-height: 1.5; text-align: justify; margin-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; }
                    th { background-color: #f2f2f2; text-align: center; font-weight: bold; }
                    td { text-align: left; vertical-align: middle; }
                    .text-primary { color: #000; font-weight: bold; }
                    .blank-space { display: inline-block; border-bottom: 1px solid #000; min-width: 50px; }
                </style>
                `;
                const sourceHTML = document.getElementById("paperExportArea").innerHTML;
                const source = header + styles + sourceHTML + footer;
                const blob = new Blob(['\ufeff', source], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'AI智能试卷.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                ui.toast('文档导出中...', 'success');
            }
        };

        /* ================= 核心 App 逻辑 ================= */
        const app = {
            config: { apiBase: 'http://localhost:8080/api/v1' },
            state: { token: localStorage.getItem('novi_token'), user: {}, sessionId: null, isTyping: false, systemConfigs: { personalities: [], tones: [], models: [] } },
            currentPreferences: {},
            isChatEditMode: false, // 新增：聊天批量删除模式状态

            init() {
                ui.init();
                // 关键修改：exam.init() 只绑定 UI 事件，不发请求
                exam.init();
                this.setupAxios();
                this.bindEvents();
                const isDark = localStorage.getItem('novi_theme') === 'dark';
                document.querySelectorAll('.theme-switcher').forEach(el => el.checked = isDark);
                if (isDark) document.documentElement.setAttribute('data-bs-theme', 'dark');

                // 移除：不在初始化时立即加载系统配置，防止未登录导致的 401 无限刷新循环
                // this.loadSystemConfigs();

                if (this.state.token) this.initLoggedInState();

                document.getElementById('psCustomPersona').addEventListener('input', (e) => {
                    if (document.getElementById('card-custom').classList.contains('selected')) this.currentPreferences.personalityMode = e.target.value;
                });

                // 恢复聊天模型选择
                const savedChatModel = localStorage.getItem('novi_chat_model');
                const savedChatLabel = localStorage.getItem('novi_chat_model_label');
                if (savedChatModel) {
                    // 更新隐藏的 input 值和按钮显示
                    const input = document.getElementById('chatModelSelect');
                    const label = document.getElementById('chatModelLabel');

                    if (input) input.value = savedChatModel;
                    if (label && savedChatLabel) label.innerText = savedChatLabel;
                }
            },

            // 加载系统配置（模型、性格、语气）
            async loadSystemConfigs() {
                try {
                    // 修正 API 路径：Config 模块的接口没有 /v1 前缀
                    // apiBase 是 http://localhost:8080/api/v1，我们需要 http://localhost:8080/api
                    const configBase = this.config.apiBase.replace('/v1', '');

                    // 并行请求
                    const [modelsRes, personalitiesRes, tonesRes] = await Promise.all([
                        axios.get(`${configBase}/model/config/list`).catch(() => ({ data: { data: [] } })),
                        axios.get(`${configBase}/prompt/config/type/1`).catch(() => ({ data: { data: [] } })),
                        axios.get(`${configBase}/prompt/config/type/2`).catch(() => ({ data: { data: [] } }))
                    ]);

                    this.state.systemConfigs.models = modelsRes.data.data || [];
                    this.state.systemConfigs.personalities = personalitiesRes.data.data || [];
                    this.state.systemConfigs.tones = tonesRes.data.data || [];

                    // 渲染 UI
                    ui.renderModelList(this.state.systemConfigs.models);
                    ui.renderPersonalityGrid(this.state.systemConfigs.personalities);
                    ui.renderToneOptions(this.state.systemConfigs.tones);

                } catch (e) {
                    console.error("加载系统配置失败", e);
                    // 不弹窗报错，以免干扰用户（因为这通常在后台静默加载）
                }
            },

            // 新增：设置聊天模型
            setChatModel(modelValue, modelLabel, element) {
                // 更新隐藏域值，用于发送请求
                document.getElementById('chatModelSelect').value = modelValue;
                // 更新按钮文本显示
                document.getElementById('chatModelLabel').innerText = modelLabel;

                // 更新菜单选中样式
                const menu = element.closest('.dropdown-menu');
                menu.querySelectorAll('.dropdown-item').forEach(btn => btn.classList.remove('active'));
                element.classList.add('active');

                // 持久化存储
                localStorage.setItem('novi_chat_model', modelValue);
                localStorage.setItem('novi_chat_model_label', modelLabel);
            },

            switchMode(mode) {
                if (mode === 'chat') {
                    ui.navigateTo('chat-view');
                    this.loadSessions(); // 切换回对话模式时刷新会话列表
                } else if (mode === 'exam') {
                    ui.navigateTo('exam-view');
                    exam.loadHistory(); // 切换到出题模式时刷新历史
                }
                ui.updateSidebarState(mode);
                if (window.innerWidth <= 768) ui.handleMainClick();
            },

            setupAxios() {
                axios.defaults.baseURL = this.config.apiBase;
                axios.interceptors.request.use(c => { if (this.state.token) c.headers.Authorization = `Bearer ${this.state.token}`; return c; });
                axios.interceptors.response.use(r => r, e => { if (e.response?.status === 401) this.logout(); return Promise.reject(e); });
            },

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', e => {
                    e.preventDefault();
                    this.doAuth('/users/login', {
                        username: document.getElementById('loginUser').value,
                        password: document.getElementById('loginPass').value
                    });
                });
                document.getElementById('registerForm').addEventListener('submit', e => {
                    e.preventDefault();
                    this.doAuth('/users/register', {
                        username: document.getElementById('regUser').value,
                        nickname: document.getElementById('regNick').value,
                        email: document.getElementById('regEmail').value,
                        password: document.getElementById('regPass').value
                    }, true);
                });
                // 绑定主题切换事件已移至 ui.toggleTheme 统一处理
                document.getElementById('messageInput').addEventListener('keydown', e => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); }
                });
            },

            async doAuth(url, data, isReg) {
                try {
                    const res = await axios.post(url, data);
                    if (res.data.code === 200 || res.data.code === 1) {
                        if (isReg) {
                            ui.toast('注册成功，请登录', 'success');
                            ui.switchAuthTab('login');
                        } else {
                            this.state.token = res.data.data.token;
                            localStorage.setItem('novi_token', this.state.token);
                            ui.toast('欢迎回来', 'success');
                            setTimeout(() => this.initLoggedInState(true), 500);
                        }
                    } else ui.toast(res.data.msg || res.data.message, 'error');
                } catch (e) { ui.toast('请求失败: ' + (e.response?.data?.msg || e.message), 'error'); }
            },

            async initLoggedInState(checkOnboarding = false) {
                this.switchMode('chat'); // 默认进聊天

                // 关键修改：登录成功后才加载系统配置和出题数据
                this.loadSystemConfigs();
                exam.loadSubjects();

                try {
                    const me = await axios.get('/users/me');
                    this.state.user = me.data.data;
                    document.querySelectorAll('#userNickDisplay').forEach(el => el.textContent = this.state.user.nickname || this.state.user.username);
                    this.loadSessions();
                    if (checkOnboarding) this.checkFirstTimeLogin();
                } catch (e) { }
            },

            async checkFirstTimeLogin() {
                try {
                    const res = await axios.get('/preferences');
                    const prefs = res.data.data;
                    if (!prefs || prefs.personalityMode === 'default') ui.onboardingModal.show();
                } catch (e) { }
            },

            async submitOnboarding() {
                const payload = {
                    personalityMode: document.getElementById('obPersonality').value,
                    userAddressName: this.state.user.nickname,
                    toneStyle: 'normal', language: null
                };
                try {
                    await axios.put('/preferences', payload);
                    ui.onboardingModal.hide();
                    this.addMessageBubble('assistant', `你好 ${payload.userAddressName}！设置已更新。`);
                } catch (e) { ui.toast('保存失败', 'error'); }
            },

            async loadProfile() {
                try {
                    const res = await axios.get('/users/me');
                    const u = res.data.data;
                    document.getElementById('pfUsername').value = u.username;
                    document.getElementById('pfEmail').value = u.email;
                    document.getElementById('pfNickname').value = u.nickname;
                    document.getElementById('pfNewPass').value = '';
                    document.getElementById('pfCurrentPass').value = '';
                } catch (e) { }
            },

            async saveProfile() {
                const data = {
                    nickname: document.getElementById('pfNickname').value,
                    email: document.getElementById('pfEmail').value,
                    newPassword: document.getElementById('pfNewPass').value || null,
                    currentPassword: document.getElementById('pfCurrentPass').value || null
                };
                if (data.newPassword && !data.currentPassword) return ui.toast('修改密码需提供旧密码', 'error');
                try {
                    await axios.put('/users/me', data);
                    ui.toast('资料已更新', 'success');
                } catch (e) { ui.toast(e.response?.data?.msg || '更新失败', 'error'); }
            },

            // 修复后的加载偏好设置，不再依赖 selectPersona 来避免覆盖值
            async loadPreferences() {
                try {
                    const res = await axios.get('/preferences');
                    const p = res.data.data || {};
                    this.currentPreferences = p;

                    // 1. 清除所有选中状态
                    document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected'));

                    // 2. 查找是否匹配预设
                    // 注意：这里的匹配逻辑需要基于后端返回的数据
                    // 后端返回的 p.personalityMode 通常是去除了前缀的 key (例如 'witty')
                    // 或者如果是自定义，就是自定义的内容

                    // 检查是否在系统预设列表中 (需要遍历加载的配置)
                    const personalities = this.state.systemConfigs.personalities;
                    const foundOption = personalities.find(opt => opt.configKey === 'personality_' + p.personalityMode);

                    const customInput = document.getElementById('customPersonaInputDiv');

                    if (foundOption) {
                        // 如果是预设，选中对应卡片，隐藏输入框
                        // 注意 ID 匹配
                        const card = document.getElementById(`card-${p.personalityMode}`);
                        if (card) card.classList.add('selected');

                        customInput.classList.add('d-none');
                        document.getElementById('psCustomPersona').value = '';
                    } else {
                        // 如果是自定义（包括 'custom' 字符串或具体 prompt），选中自定义卡片
                        // 或者是默认的 'default' 但没找到对应配置
                        const customCard = document.getElementById('card-custom');
                        if (customCard) customCard.classList.add('selected');
                        customInput.classList.remove('d-none');

                        // 获取要显示的文本，如果是 'custom' 占位符则显示空
                        const textToShow = (p.personalityMode === 'custom' || p.personalityMode === 'default') ? '' : p.personalityMode;

                        // 设置值
                        const inputEl = document.getElementById('psCustomPersona');
                        inputEl.value = textToShow || '';

                        if (textToShow) {
                            inputEl.placeholder = textToShow;
                        } else {
                            inputEl.placeholder = "输入你想要的 Prompt...";
                        }
                    }

                    // 语气设置
                    // p.toneStyle 存储的是去除了 'tone_' 前缀的值 (例如 'normal')
                    const toneSelect = document.getElementById('psTone');
                    if (toneSelect) toneSelect.value = p.toneStyle || 'normal';

                    document.getElementById('psLanguage').value = p.language || '';
                    document.getElementById('psAddressName').value = p.userAddressName || '';
                } catch (e) {
                    console.error("加载偏好失败", e);
                }
            },

            async savePreferences() {
                let pMode = 'default';
                if (document.getElementById('card-custom').classList.contains('selected')) {
                    pMode = document.getElementById('psCustomPersona').value || 'custom';
                } else {
                    const sel = document.querySelector('.persona-card.selected');
                    pMode = sel ? sel.id.replace('card-', '') : 'default';
                }
                const data = {
                    personalityMode: pMode,
                    toneStyle: document.getElementById('psTone').value,
                    language: document.getElementById('psLanguage').value || null,
                    userAddressName: document.getElementById('psAddressName').value
                };
                try {
                    await axios.put('/preferences', data);
                    ui.toast('设置已保存', 'success');
                } catch (e) { ui.toast('保存失败', 'error'); }
            },

            async loadSessions() {
                try {
                    const res = await axios.get('/sessions');
                    const list = document.querySelectorAll('#sessionList');
                    list.forEach(el => el.innerHTML = '');
                    if (res.data.code === 200 || res.data.code === 1) {
                        const html = res.data.data.map(s => `
                            <div class="session-item d-flex align-items-center ${s.id === this.state.sessionId ? 'active' : ''} ${this.isChatEditMode ? 'editing-mode' : ''}"
                                 onclick="app.handleSessionItemClick('${s.id}', event)"
                                 data-id="${s.id}">
                                <div class="form-check me-2 d-none chat-checkbox-wrapper">
                                    <input class="form-check-input chat-checkbox" type="checkbox" value="${s.id}" onclick="event.stopPropagation(); app.updateChatSelectionUI()">
                                </div>
                                <div class="d-flex flex-column w-100" style="pointer-events: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-truncate fw-medium" style="max-width: 170px;">${s.title || '新会话'}</div>
                                        <i class="bi bi-x btn text-muted p-0 chat-delete-btn ms-2 ${this.isChatEditMode ? 'd-none' : ''}" onclick="app.deleteSession('${s.id}', event)" style="font-size: 1.1rem; pointer-events: auto;"></i>
                                    </div>
                                    <div class="small text-muted text-truncate" style="font-size: 0.8rem;">${new Date(s.createdAt || Date.now()).toLocaleDateString()}</div>
                                </div>
                            </div>`).join('');
                        list.forEach(el => el.innerHTML = html);

                        // 如果处于编辑模式，恢复 UI 状态
                        if (this.isChatEditMode) {
                            this.applyChatEditModeStyles(true);
                        }
                    }
                } catch (e) { }
            },

            // --- 新增：聊天会话批量管理逻辑 (类似 Exam) ---
            toggleChatEditMode() {
                this.isChatEditMode = !this.isChatEditMode;
                this.applyChatEditModeStyles(this.isChatEditMode);
            },

            applyChatEditModeStyles(isEdit) {
                const toggle = (selector, show) => {
                    document.querySelectorAll(selector).forEach(el => {
                        if (show) {
                            el.classList.remove('d-none');
                            if (el.classList.contains('chat-edit-controls') || el.classList.contains('chat-select-all-bar')) {
                                el.classList.add('d-flex');
                            }
                        } else {
                            el.classList.add('d-none');
                            el.classList.remove('d-flex');
                        }
                    });
                };

                toggle('.btn-manage-chat', !isEdit);
                toggle('.chat-edit-controls', isEdit);
                toggle('.chat-select-all-bar', isEdit);

                // 列表项样式
                document.querySelectorAll('#sessionList .session-item').forEach(item => {
                    if (isEdit) {
                        item.classList.add('editing-mode');
                        // 移除 active 样式以免混淆，或者保留但变淡
                        item.classList.remove('active');
                    } else {
                        item.classList.remove('editing-mode', 'item-selected');
                        // 恢复 active
                        if (item.dataset.id === this.state.sessionId) item.classList.add('active');
                    }
                });

                // 复选框与单删按钮
                document.querySelectorAll('.chat-checkbox-wrapper').forEach(el => {
                    if (isEdit) el.classList.remove('d-none'); else el.classList.add('d-none');
                });
                document.querySelectorAll('.chat-delete-btn').forEach(el => {
                    if (isEdit) el.classList.add('d-none'); else el.classList.remove('d-none');
                });

                // 重置
                if (!isEdit) {
                    document.querySelectorAll('.chat-checkbox').forEach(chk => chk.checked = false);
                    document.querySelectorAll('.select-all-chat-top').forEach(chk => chk.checked = false);
                    this.updateChatSelectionUI();
                    // 刷新以恢复正确的 Active 状态
                    this.loadSessions();
                }
            },

            handleSessionItemClick(sid, event) {
                if (this.isChatEditMode) {
                    if (event.target.type === 'checkbox') return;
                    const checkbox = event.currentTarget.querySelector('.chat-checkbox');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        this.updateChatSelectionUI();
                    }
                } else {
                    this.loadSession(sid);
                }
            },

            toggleSelectAllChat(source) {
                document.querySelectorAll('.chat-checkbox').forEach(chk => chk.checked = source.checked);
                document.querySelectorAll('.select-all-chat-top').forEach(chk => chk.checked = source.checked);
                this.updateChatSelectionUI();
            },

            updateChatSelectionUI() {
                const checkboxes = document.querySelectorAll('.chat-checkbox');
                const checkedIds = new Set();
                checkboxes.forEach(chk => {
                    const item = chk.closest('.session-item');
                    if (chk.checked) {
                        checkedIds.add(chk.value);
                        if (item) item.classList.add('item-selected');
                    } else {
                        if (item) item.classList.remove('item-selected');
                    }
                });
                document.querySelectorAll('.btn-batch-delete-chat').forEach(btn => {
                    btn.textContent = `删除(${checkedIds.size})`;
                });
            },

            async deleteSelectedSessions() {
                const checked = document.querySelectorAll('.chat-checkbox:checked');
                if (checked.length === 0) return ui.toast('请先选择会话', 'info');
                const ids = [...new Set(Array.from(checked).map(cb => cb.value))];

                ui.confirm(`确认删除这 ${ids.length} 个会话吗？`, async () => {
                    try {
                        const promises = ids.map(id => axios.delete(`/sessions/${id}`));
                        await Promise.all(promises);
                        ui.toast(`成功删除 ${ids.length} 个会话`, 'success');

                        if (ids.includes(this.state.sessionId)) {
                            this.startNewChat();
                        } else {
                            this.loadSessions();
                        }
                        this.toggleChatEditMode(); // 退出编辑模式
                    } catch (e) {
                        ui.toast('批量删除部分失败', 'error');
                        this.loadSessions();
                    }
                });
            },

            async loadSession(sid) {
                this.state.sessionId = sid;
                this.loadSessions();
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';
                if (window.innerWidth <= 768) ui.handleMainClick();

                const res = await axios.get(`/sessions/${sid}/messages`);
                if (res.data.code === 200 || res.data.code === 1) res.data.data.forEach(m => this.addMessageBubble(m.role.toLowerCase(), m.content));

                // Update Title Display
                // 由于 loadSessions 是异步的，这里可能需要延时或者直接查找 DOM
                setTimeout(() => {
                    const active = document.querySelector(`.session-item[data-id="${sid}"]`);
                    if (active) {
                        const titleDiv = active.querySelector('.fw-medium');
                        if (titleDiv) document.getElementById('currentTitle').innerText = titleDiv.innerText.trim();
                    }
                }, 100);

                const win = document.getElementById('chatWindow');
                setTimeout(() => win.scrollTop = win.scrollHeight, 100);
            },

            deleteSession(sid, e) {
                e.stopPropagation();
                ui.confirm('删除此会话？', async () => {
                    try {
                        await axios.delete(`/sessions/${sid}`);
                        if (this.state.sessionId === sid) this.startNewChat();
                        else this.loadSessions();
                    } catch (e) { ui.toast('删除失败', 'error'); }
                });
            },

            startNewChat() {
                this.state.sessionId = null;
                document.getElementById('currentTitle').innerText = 'Novi AI';
                document.getElementById('chatContainer').innerHTML = `<div class="text-center mt-5 pt-5"><div class="avatar avatar-ai mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem; border:none; background:transparent;"><i class="bi bi-stars text-primary"></i></div><h3 class="fw-bold">你好，我是 Novi</h3><p class="text-muted">我可以帮你写代码、做计划，或者仅仅聊聊天。</p></div>`;
                if (window.innerWidth <= 768) ui.handleMainClick();
                this.loadSessions();
            },

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const msg = input.value.trim();
                // 获取选中的 AI 模型
                const model = document.getElementById('chatModelSelect').value;

                if (!msg || this.state.isTyping) return;

                this.addMessageBubble('user', msg);
                input.value = '';
                input.style.height = '52px'; // 重置高度
                // 不需要再移除全屏按钮 class，因为布局变了

                const win = document.getElementById('chatWindow');
                win.scrollTop = win.scrollHeight;

                const aiId = 'ai-' + Date.now();
                this.addMessageBubble('assistant', '', aiId);
                const bubble = document.getElementById(aiId);
                this.state.isTyping = true;

                try {
                    const mode = document.querySelector('input[name="apiMode"]:checked').value;
                    const payload = {
                        message: msg,
                        sessionId: this.state.sessionId,
                        model: model // 传递模型参数
                    };

                    Typewriter.start(bubble);

                    if (mode === 'stream') await this.handleStream(payload);
                    else {
                        const res = await axios.post('/chat/send/call', payload);
                        if (res.data.code !== 200 && res.data.code !== 1) throw new Error(res.data.msg);
                        Typewriter.push(res.data.data.response);
                        if (res.data.data.title) this.updateSessionTitle(res.data.data.sessionId, res.data.data.title);
                    }
                } catch (err) {
                    Typewriter.stop();
                    bubble.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle me-2"></i>${err.message || '网络请求失败'}</span>`;
                } finally {
                    if (document.querySelector('input[name="apiMode"]:checked')?.value !== 'stream') {
                        setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; this.loadSessions(); }, 300);
                    }
                }
            },

            async handleStream(payload) {
                try {
                    const res = await fetch(`${this.config.apiBase}/chat/send/stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (!line.trim() || !line.startsWith('data:')) continue;
                            try {
                                const evt = JSON.parse(line.slice(5));
                                if (evt.eventType === 'CONTENT') Typewriter.push(evt.content);
                                else if (evt.eventType === 'METADATA') this.updateSessionTitle(evt.sessionId, evt.title);
                            } catch (e) { }
                        }
                    }
                } finally {
                    setTimeout(() => { Typewriter.stop(); this.state.isTyping = false; this.loadSessions(); }, 300);
                }
            },

            addMessageBubble(role, content, id) {
                const container = document.getElementById('chatContainer');
                if (container.querySelector('.text-center')) container.innerHTML = '';
                const div = document.createElement('div');
                div.className = `message-row ${role}`;
                const avatar = `<div class="avatar ${role === 'user' ? 'avatar-user' : 'avatar-ai'}"><i class="bi bi-${role === 'user' ? 'person-fill' : 'stars'}"></i></div>`;
                const initialHtml = content ? marked.parse(content) : '';
                const bub = `<div class="message-bubble ${role} markdown-body" ${id ? `id="${id}" data-raw=""` : ''}>${initialHtml}</div>`;
                div.innerHTML = avatar + bub;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight; // Fix scroll on add
            },

            updateSessionTitle(sid, title) {
                this.state.sessionId = sid;
                if (title) document.getElementById('currentTitle').innerText = title;
            },

            logout() { localStorage.removeItem('novi_token'); location.reload(); }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>

</html>