# API 文档 - 用户管理 (User Management)

## 模块概览

**模块**： 用户管理 (User Management)

**Base URL**： `/api/v1`

此模块负责处理所有与用户账户相关的功能，包括注册、登录和资料管理。



## 1. 统一响应格式 (Unified Response Format)

所有API接口（除认证失败外）均返回 `HTTP 200 OK`，响应体是一个统一的 `Result` 对象。

**`Result` 对象结构:**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": { ... }
}
```

- `code` (Integer): 状态码。
  - **`1`**: 表示业务操作成功。
  - **`0`**: 表示业务操作失败（例如：用户名已存在、密码错误等）。
- `msg` (String): 描述信息。
  - `code: 1` 时, 通常为 `"success"`。
  - `code: 0` 时, 为具体的错误提示信息。
- `data` (Object): 响应数据。
  - `code: 1` 时, 存放返回的数据对象（如用户信息、Token等）。
  - `code: 0` 时, 通常为 `null`。

**响应示例:**

**✅ 业务成功 (Success):**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": {
    "userId": 1,
    "username": "test_user"
  }
}
```

**❌ 业务失败 (Error):**

```JSON
{
  "code": 0,
  "msg": "Invalid username or password",
  "data": null
}
```



## 2. 鉴权与错误处理 (Auth & Error Handling)

### 鉴权 (Authentication)

- 需要鉴权的接口（已在文档中标注）必须在HTTP请求头 (Header) 中携带 `Authorization` 字段。
- **Header 格式：** `Authorization: Bearer <your_jwt_token>`
- 此 `token` 在用户成功调用 **"用户登录"** 接口时从 `data` 字段中返回。

### 错误处理 (Error Handling)

1. **业务错误 (Business Errors):**

   - **HTTP 状态码:** `200 OK`
   - **响应体:** `Result` 对象，其中 `code: 0`，`msg` 包含错误信息。
   - *示例: "用户名已存在", "密码格式错误", "邮箱不合法"。*

2. **认证/鉴权失败 (Auth Errors):**

   - 如果请求未携带Token或Token无效/过期，**Spring Security安全框架** 会在请求到达Controller**之前**拦截。

   - **HTTP 状态码:** `401 Unauthorized`

   - **响应体:** （通常不遵循 `Result` 格式，而是Spring Security的默认错误响应）

     ```JSON
     {
       "status": 401,
       "error": "Unauthorized",
       "message": "Full authentication is required to access this resource",
       "path": "/api/v1/users/me"
     }
     ```

------



## 3. API 接口详解

### 3.1. 用户注册 (Create User)

- **Endpoint:** `POST /api/v1/users`
- **描述:** 创建一个新用户账户。
- **鉴权:** 否

#### 请求 (Request)

**Body (JSON):** `UserRegistrationRequest.java` (DTO)

```JSON
{
  "username": "new_user",
  "nickname": "nick_name",
  "password": "Password123!",
  "email": "user@example.com"
}
```

#### 响应 (Response)

**✅ 成功: `200 OK`**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": null,
}
```

- `data` 中返回新创建的用户信息（不包含密码）。

**❌ 失败 (例如: 用户名已存在): `200 OK`**

```JSON
{
  "code": 0,
  "msg": "Username already exists",
  "data": null
}
```

------



### 3.2. 用户登录 (User Login)

- **Endpoint:** `POST /api/v1/auth/login`
- **描述:** 校验用户名和密码。如果成功，生成一个JWT Token并返回。
- **鉴权:** 否

#### 请求 (Request)

**Body (JSON):** `LoginRequest.java` (DTO)

```JSON
{
  "username": "new_user",
  "password": "Password123!"
}
```

#### 响应 (Response)

**✅ 成功: `200 OK`**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIi...",
    "userId": 1
  }
}
```

- `data.token` (String): 用于后续请求的JWT Bearer Token。

**❌ 失败 (例如: 密码错误): `200 OK`**

```JSON
{
  "code": 0,
  "msg": "Invalid username or password",
  "data": null
}
```

------



### 3.3. 获取当前用户资料 (Get Current User Profile)

- **Endpoint:** `GET /api/v1/users/me`
- **描述:** 获取当前已登录用户的详细资料。`me` 是一个特殊的标识符，代表当前Token的用户。
- **鉴权:** 是 (Bearer Token)

#### 请求 (Request)

- 无请求体。

#### 响应 (Response)

**✅ 成功: `200 OK`**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": {
    "id": 1,
    "username": "new_user",
    "nickname": "Novi的挚友",
    "email": "user@example.com",
    "createdAt": "2025-11-09T20:05:00Z"
  }
}
```

- `data` 中是 `UserProfileDto.java` 对象。

**(认证失败会返回 `HTTP 401`，参见 2. 鉴权与错误处理)**

------



### 3.4. 更新当前用户资料 (Update Current User Profile)

- **Endpoint:** `PUT /api/v1/users/me`
- **描述:** 更新当前已登录用户的资料，如昵称或邮箱。`PUT` 请求表示完整替换可更新字段。
- **鉴权:** 是 (Bearer Token)

#### 请求 (Request)

**Body (JSON):** `UpdateProfileRequest.java` (DTO)

```JSON
{
  "nickname": "最好的挚友",
  "email": "new_email@example.com"
}
```

#### 响应 (Response)

**✅ 成功: `200 OK`**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": {
    "id": 1,
    "username": "new_user",
    "nickname": "最好的挚友",
    "email": "new_email@example.com",
    "createdAt": "2025-11-09T20:05:00Z"
  }
}
```

- `data` 中返回更新后的完整用户信息。

**❌ 失败 (例如: Email冲突): `200 OK`**

```JSON
{
  "code": 0,
  "msg": "Email already in use",
  "data": null
}
```

------



### 3.5. 获取用户偏好 (Get User Preferences)

- **Endpoint:** `GET /api/v1/users/me/preferences`
- **描述:** 获取用户对Novi的个性化配置（存储在 `preferences` JSON 字段中）。
- **鉴权:** 是 (Bearer Token)

#### 请求 (Request)

- 无请求体。

#### 响应 (Response)

**✅ 成功: `200 OK`**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": {
    "personality": "witty",
    "voice": "female_A",
    "response_length": "concise"
  }
}
```

- `data` 中直接返回 `preferences` 字段的JSON对象。

------



### 3.6. 更新用户偏好 (Update User Preferences)

- **Endpoint:** `PUT /api/v1/users/me/preferences`
- **描述:** **完全替换** `user_account` 表中 `preferences` 字段的JSON内容。
- **鉴权:** 是 (Bearer Token)

#### 请求 (Request)

**Body (JSON):** `UserPreferencesDto.java` (DTO)

```JSON
{
  "personality": "gentle",
  "voice": "female_A",
  "response_length": "detailed"
}
```

- *注意: 请求体是偏好对象本身，而不是 `{ "preferences": { ... } }`。*

#### 响应 (Response)

**✅ 成功: `200 OK`**

```JSON
{
  "code": 1,
  "msg": "success",
  "data": {
    "personality": "gentle",
    "voice": "female_A",
    "response_length": "detailed"
  }
}
```

- `data` 中返回更新后的偏好设置。

**❌ 失败 (例如: JSON结构不合法): `200 OK`**



```JSON
{
  "code": 0,
  "msg": "Invalid preferences format",
  "data": null
}
```