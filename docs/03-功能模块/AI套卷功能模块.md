# AI å¥—å·åŠŸèƒ½æ¨¡å—æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

AI å¥—å·æ¨¡å—æ˜¯åœ¨ "AI å‡ºé¢˜" åŸºç¡€ä¸Šçš„è¿›é˜¶åŠŸèƒ½ã€‚å®ƒå…è®¸ä¸€æ¬¡æ€§ç”ŸæˆåŒ…å«å¤šä¸ªé¢˜å‹ã€æ¶µç›–ä¸åŒçŸ¥è¯†ç‚¹çš„å®Œæ•´è¯•å·ã€‚ç”±äºç”Ÿæˆæ•´å¥—è¯•å·è€—æ—¶è¾ƒé•¿ï¼Œè¯¥æ¨¡å—é‡‡ç”¨ **å¼‚æ­¥å¹¶å‘** ç”Ÿæˆå’Œ **Server-Sent Events (SSE)** å®æ—¶æ¨é€è¿›åº¦çš„æ¶æ„ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **ä¸€é”®ç»„å·**ï¼šæ ¹æ®é¢„è®¾çš„å¥—å·æ¨¡ç‰ˆï¼ˆåŒ…å«å¤šä¸ªé¢˜å‹é…ç½®ï¼‰ï¼Œä¸€é”®ç”Ÿæˆå®Œæ•´è¯•å·ã€‚
- **å¹¶å‘ç”Ÿæˆ**ï¼šåå°é€šè¿‡çº¿ç¨‹æ± å¹¶å‘è°ƒç”¨ AI ç”Ÿæˆå„ä¸ªé¢˜å‹ï¼Œå¤§å¹…ç¼©çŸ­æ€»è€—æ—¶ã€‚
- **å®æ—¶è¿›åº¦ (SSE)**ï¼šå‰ç«¯å®æ—¶æ¥æ”¶æ¯ä¸ªé¢˜å‹çš„ç”Ÿæˆç»“æœï¼Œå³ç”Ÿæˆå³æ¸²æŸ“ï¼Œæ— éœ€ç­‰å¾…å…¨éƒ¨å®Œæˆã€‚
- **æ·±åº¦æ€è€ƒé›†æˆ**ï¼šæ”¯æŒå¯ç”¨æ·±åº¦æ€è€ƒæ¨¡å¼ï¼Œç”Ÿæˆé«˜è´¨é‡çš„ç»¼åˆè¯•å·ã€‚
- **ç»“æ„åŒ–å­˜å‚¨**ï¼šå¥—å·è®°å½• (`paper_generation_record`) ä¸ é¢˜ç›®æ˜ç»† (`paper_question_detail`) åˆ†ç¦»å­˜å‚¨ï¼Œç»“æ„æ¸…æ™°ã€‚

## ğŸ”Œ API æ¥å£

### ç”Ÿæˆå¥—å· (æµå¼)

**æ¥å£è·¯å¾„**ï¼š`POST /api/v1/papers/generate`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "subjectId": 1,
  "paperName": "2024å¹´æ¨¡æ‹Ÿå·ä¸€",
  "enableThinking": true
  // å¯é€‰ï¼šè‡ªå®šä¹‰ paperConfig
}
```

**å“åº”æ ¼å¼**ï¼š`text/event-stream`

## ğŸ“Š ä¸šåŠ¡æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·å‘èµ·ç»„å·è¯·æ±‚] --> B[Controller å»ºç«‹SSEè¿æ¥]
    B --> C[Service å¼‚æ­¥æäº¤ä»»åŠ¡]
    C --> B
    C --> D{éå†é¢˜å‹é…ç½®}
    D --> E[çº¿ç¨‹æ± : æäº¤é¢˜å‹ç”Ÿæˆä»»åŠ¡ 1]
    D --> F[çº¿ç¨‹æ± : æäº¤é¢˜å‹ç”Ÿæˆä»»åŠ¡ 2]
    D --> G[...]
    E --> H[AI ç”Ÿæˆé¢˜å‹ 1]
    F --> I[AI ç”Ÿæˆé¢˜å‹ 2]
    H --> J[ä¿å­˜æ˜ç»†åˆ° DB]
    I --> K[ä¿å­˜æ˜ç»†åˆ° DB]
    J --> L[SSE æ¨é€: event=question]
    K --> L
    L --> M{æ‰€æœ‰ä»»åŠ¡å®Œæˆ?}
    M -->|æ˜¯| N[æ›´æ–°å¥—å·çŠ¶æ€]
    N --> O[SSE æ¨é€: event=complete]
```

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### Controller å±‚

**æ–‡ä»¶**ï¼š`PaperGenerationController.java`

- è´Ÿè´£æ¥æ”¶ç»„å·è¯·æ±‚ï¼Œè®¾ç½® SSE è¶…æ—¶æ—¶é—´ï¼ˆæ™®é€šæ¨¡å¼ 5minï¼Œæ·±åº¦æ€è€ƒ 30minï¼‰ã€‚
- ç»´æŠ¤ SSE Emitter çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¤„ç†è¶…æ—¶å’Œé”™è¯¯å›è°ƒã€‚

### Service å±‚

**æ–‡ä»¶**ï¼š`PaperGenerationService.java`

- **ä»»åŠ¡æ‹†åˆ†**ï¼šæ ¹æ®å¥—å·æ¨¡ç‰ˆï¼Œå°†æ•´å·æ‹†åˆ†ä¸º N ä¸ªå­ä»»åŠ¡ï¼ˆæ¯ä¸ªé¢˜å‹ä¸ºä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚
- **å¹¶å‘æ‰§è¡Œ**ï¼šä½¿ç”¨ `CompletableFuture` å’Œè‡ªå®šä¹‰çº¿ç¨‹æ± å¹¶å‘æ‰§è¡Œå­ä»»åŠ¡ã€‚
- **ç»“æœèšåˆ**ï¼šè™½ç„¶æ˜¯æµå¼æ¨é€ï¼Œä½†åœ¨åå°ä¼šæœ€ç»ˆèšåˆæ‰€æœ‰ç»“æœå¹¶æ›´æ–°ä¸»è®°å½•çŠ¶æ€ã€‚

## ğŸ’¾ æ•°æ®æ¨¡å‹

### 1. PaperGenerationRecord (å¥—å·ä¸»è¡¨)

å­˜å‚¨å¥—å·çš„åŸºç¡€ä¿¡æ¯ã€‚

```java
@TableName("paper_generation_record")
public class PaperGenerationRecord {
    private Long id;
    private Long userId;
    private Long subjectId;
    private String paperName;
    private Integer totalQuestions;
    private Boolean enableThinking;
    // ...
}
```

### 2. PaperQuestionDetail (å¥—å·æ˜ç»†è¡¨)

å­˜å‚¨å¥—å·ä¸­æ¯ä¸ªé¢˜å‹çš„å…·ä½“å†…å®¹ã€‚

```java
@TableName("paper_question_detail")
public class PaperQuestionDetail {
    private Long id;
    private Long paperId;        // å…³è”ä¸»è¡¨
    private String questionType; // é¢˜å‹ç¼–ç 
    private String generatedQuestions; // è¯¥é¢˜å‹çš„é¢˜ç›®JSON
    private Integer displayOrder; // æ˜¾ç¤ºé¡ºåº
    // ...
}
```

## âš ï¸ å…³é”®æŠ€æœ¯ç‚¹

1.  **è¶…æ—¶æ§åˆ¶**ï¼šç”±äºæ·±åº¦æ€è€ƒæ¨¡å‹ï¼ˆå¦‚ Gemini 2.0 Flash Thinkingï¼‰ç”Ÿæˆé€Ÿåº¦è¾ƒæ…¢ï¼Œä¸”å¥—å·åŒ…å«å¤šä¸ªé¢˜å‹ï¼Œå¿…é¡»æ˜¾è‘—å¢åŠ  HTTP å’Œ SSE çš„è¶…æ—¶æ—¶é—´è®¾ç½®ã€‚
2.  **å¹¶å‘ç­–ç•¥**ï¼šé€šè¿‡ `ExecutorService` æˆ– `CompletableFuture` å¹¶å‘è¯·æ±‚ AIï¼Œé¿å…ä¸²è¡Œæ‰§è¡Œå¯¼è‡´çš„æ€»è€—æ—¶è¿‡é•¿ã€‚
3.  **éƒ¨åˆ†å¤±è´¥å¤„ç†**ï¼šå¦‚æœæŸä¸ªé¢˜å‹ç”Ÿæˆå¤±è´¥ï¼ŒSSE ä¼šæ¨é€ `error` äº‹ä»¶ï¼Œä½†ä¸åº”ä¸­æ–­æ•´ä¸ªå¥—å·çš„ç”Ÿæˆï¼ˆé™¤éå…³é”®é”™è¯¯ï¼‰ï¼Œå‰ç«¯åº”èƒ½å¤„ç†éƒ¨åˆ†é¢˜å‹ç¼ºå¤±çš„æƒ…å†µã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [AIå‡ºé¢˜åŠŸèƒ½æ¨¡å—](AIå‡ºé¢˜åŠŸèƒ½æ¨¡å—.md)
- [API æ¥å£æ–‡æ¡£ - å¥—å·ç”Ÿæˆ](../04-APIæ–‡æ¡£/æ¥å£æ–‡æ¡£/1.9-å¥—å·ç”Ÿæˆ.md)
