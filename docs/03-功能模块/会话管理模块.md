# ä¼šè¯ç®¡ç†æ¨¡å—æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¼šè¯ç®¡ç†æ¨¡å—è´Ÿè´£ç®¡ç†ç”¨æˆ·çš„èŠå¤©ä¼šè¯ï¼Œæä¾›ä¼šè¯çš„åˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤ç­‰åŠŸèƒ½ï¼Œæ”¯æŒè‡ªåŠ¨ä¼šè¯è¯†åˆ«å’Œæ ‡é¢˜ç”Ÿæˆã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **è‡ªåŠ¨ä¼šè¯ç®¡ç†**ï¼šæ–°å¯¹è¯è‡ªåŠ¨åˆ›å»ºä¼šè¯
- **æ™ºèƒ½æ ‡é¢˜ç”Ÿæˆ**ï¼šæ ¹æ®é¦–æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆä¼šè¯æ ‡é¢˜
- **ä¼šè¯åˆ—è¡¨**ï¼šæŒ‰æœ€åæ´»è·ƒæ—¶é—´æ’åº
- **å†å²å›æº¯**ï¼šåŠ è½½å®Œæ•´ä¼šè¯å†å²
- **è½¯åˆ é™¤**ï¼šé€»è¾‘åˆ é™¤ï¼Œä¿éšœæ•°æ®å®‰å…¨

## ğŸ”Œ API æ¥å£

### 1. è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨

**æ¥å£è·¯å¾„**ï¼š`GET /api/v1/sessions`

**å“åº”æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "sessionId": "session-uuid-123",
      "sessionTitle": "ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œæˆ‘ä»¬...",
      "createdAt": "2025-11-29T10:00:00",
      "lastActiveTime": "2025-11-29T12:30:00",
      "messageCount": 15
    }
  ]
}
```

### 2. è·å–ä¼šè¯å†å²æ¶ˆæ¯

**æ¥å£è·¯å¾„**ï¼š`GET /api/v1/sessions/{sessionId}/messages`

**è·¯å¾„å‚æ•°**ï¼š
- `sessionId`ï¼šä¼šè¯ID

**å“åº”æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "role": "user",
      "content": "ä½ å¥½ï¼ŒNoviï¼",
      "timestamp": "2025-11-29T10:00:00"
    },
    {
      "id": 2,
      "role": "assistant",
      "content": "ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï½",
      "timestamp": "2025-11-29T10:00:05"
    }
  ]
}
```

### 3. åˆ é™¤ä¼šè¯

**æ¥å£è·¯å¾„**ï¼š`DELETE /api/v1/sessions/{sessionId}`

**è·¯å¾„å‚æ•°**ï¼š
- `sessionId`ï¼šä¼šè¯ID

**å“åº”æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "message": "success"
}
```

## ğŸ“Š ä¸šåŠ¡æµç¨‹

### ä¼šè¯è‡ªåŠ¨ç®¡ç†æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·å‘é€æ¶ˆæ¯] --> B{sessionIdæ˜¯å¦å­˜åœ¨?}
    B -->|null| C[åˆ›å»ºæ–°ä¼šè¯]
    B -->|å­˜åœ¨| D[æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨]
    C --> E[ç”ŸæˆUUIDä½œä¸ºsessionId]
    E --> F[æå–é¦–æ¡æ¶ˆæ¯å‰20å­—ä½œä¸ºæ ‡é¢˜]
    F --> G[ä¿å­˜ä¼šè¯åˆ°æ•°æ®åº“]
    D -->|ä¸å­˜åœ¨| C
    D -->|å­˜åœ¨| H[æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´]
    G --> I[ç»§ç»­å¤„ç†æ¶ˆæ¯]
    H --> I
```

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### Controller å±‚

**æ–‡ä»¶**ï¼š`ChatSessionController.java`

**ä¸»è¦æ–¹æ³•**ï¼š
- `getUserSessions()` - è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨
- `getSessionMessages()` - è·å–ä¼šè¯æ¶ˆæ¯å†å²
- `deleteSession()` - åˆ é™¤ä¼šè¯

### Service å±‚

**æ–‡ä»¶**ï¼š`ChatSessionService.java`

**ä¸»è¦èŒè´£**ï¼š
- ä¼šè¯åˆ›å»ºä¸è¯†åˆ«
- ä¼šè¯æ ‡é¢˜ç”Ÿæˆ
- ä¼šè¯åˆ—è¡¨æŸ¥è¯¢
- ä¼šè¯è½¯åˆ é™¤

**å…³é”®æ–¹æ³•**ï¼š
```java
// åˆ›å»ºæ–°ä¼šè¯
ChatSession createSession(Long userId, String firstMessage);

// æ›´æ–°ä¼šè¯æ´»è·ƒæ—¶é—´
void updateLastActiveTime(String sessionId);

// è·å–ç”¨æˆ·æ‰€æœ‰ä¼šè¯
List<ChatSession> getUserSessions(Long userId);

// åˆ é™¤ä¼šè¯
void deleteSession(String sessionId, Long userId);
```

## ğŸ’¾ æ•°æ®æ¨¡å‹

### ChatSessionï¼ˆä¼šè¯ï¼‰

```java
@TableName("chat_session")
public class ChatSession {
    private Long id;
    private String sessionId;        // UUID
    private Long userId;             // æ‰€å±ç”¨æˆ·
    private String sessionTitle;     // ä¼šè¯æ ‡é¢˜
    private LocalDateTime createdAt;
    private LocalDateTime lastActiveTime;
    private Integer isDeleted;       // è½¯åˆ é™¤æ ‡è®°
}
```

### æ•°æ®åº“è¡¨ç»“æ„

**è¡¨å**ï¼š`chat_session`

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | BIGINT | ä¸»é”®ID |
| `session_id` | VARCHAR(100) | ä¼šè¯UUIDï¼ˆå”¯ä¸€ï¼‰ |
| `user_id` | BIGINT | ç”¨æˆ·ID |
| `session_title` | VARCHAR(200) | ä¼šè¯æ ‡é¢˜ |
| `created_at` | DATETIME | åˆ›å»ºæ—¶é—´ |
| `last_active_time` | DATETIME | æœ€åæ´»è·ƒæ—¶é—´ |
| `is_deleted` | TINYINT | æ˜¯å¦åˆ é™¤ï¼ˆ0/1ï¼‰ |

## ğŸ”„ ä¼šè¯æ ‡é¢˜ç”Ÿæˆ

### ç”Ÿæˆè§„åˆ™

1. **é¦–æ¡æ¶ˆæ¯æˆªå–**ï¼šå–ç”¨æˆ·ç¬¬ä¸€æ¡æ¶ˆæ¯çš„å‰20ä¸ªå­—ç¬¦
2. **çœç•¥å·è¡¥å……**ï¼šè¶…è¿‡20å­—ç¬¦è‡ªåŠ¨æ·»åŠ "..."
3. **å»é™¤æ¢è¡Œ**ï¼šæ›¿æ¢æ¢è¡Œç¬¦ä¸ºç©ºæ ¼
4. **ç‰¹æ®Šå¤„ç†**ï¼šç©ºæ¶ˆæ¯ä½¿ç”¨é»˜è®¤æ ‡é¢˜"æ–°å¯¹è¯"

### ä»£ç ç¤ºä¾‹

```java
public String generateTitle(String firstMessage) {
    if (firstMessage == null || firstMessage.trim().isEmpty()) {
        return "æ–°å¯¹è¯";
    }
    
    String cleanMessage = firstMessage.replaceAll("\\n", " ");
    
    if (cleanMessage.length() > 20) {
        return cleanMessage.substring(0, 20) + "...";
    }
    
    return cleanMessage;
}
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯ä¼šè¯åˆ—è¡¨å®ç°

```javascript
// åŠ è½½ä¼šè¯åˆ—è¡¨
async function loadSessions() {
  const response = await fetch('/api/v1/sessions', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await response.json();
  
  // æŒ‰æœ€åæ´»è·ƒæ—¶é—´æ’åºï¼ˆåç«¯å·²æ’åºï¼‰
  const sessions = data.data;
  
  sessions.forEach(session => {
    renderSessionItem(session);
  });
}

// æ¸²æŸ“ä¼šè¯é¡¹
function renderSessionItem(session) {
  const div = document.createElement('div');
  div.className = 'session-item';
  div.innerHTML = `
    <div class="session-title">${session.sessionTitle}</div>
    <div class="session-time">${formatTime(session.lastActiveTime)}</div>
  `;
  div.onclick = () => loadSessionMessages(session.sessionId);
  sessionList.appendChild(div);
}

// åŠ è½½ä¼šè¯æ¶ˆæ¯
async function loadSessionMessages(sessionId) {
  const response = await fetch(`/api/v1/sessions/${sessionId}/messages`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await response.json();
  
  data.data.forEach(msg => {
    renderMessage(msg.role, msg.content);
  });
}

// åˆ é™¤ä¼šè¯
async function deleteSession(sessionId) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¼šè¯ï¼Ÿ')) return;
  
  await fetch(`/api/v1/sessions/${sessionId}`, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  
  // åˆ·æ–°åˆ—è¡¨
  loadSessions();
}
```

## ğŸ¨ å‰ç«¯UIå»ºè®®

### ä¼šè¯åˆ—è¡¨å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œæˆ‘ä»¬...    â”‚ 12:30
â”‚ å¦‚ä½•å­¦ä¹ Spring Boot...  â”‚ æ˜¨å¤©
â”‚ æ¨èå‡ æœ¬å¥½ä¹¦             â”‚ 2å¤©å‰
â”‚ å‘¨æœ«å»å“ªé‡Œç©æ¯”è¾ƒå¥½...     â”‚ 1å‘¨å‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº¤äº’è®¾è®¡

- **ç‚¹å‡»ä¼šè¯**ï¼šåŠ è½½å†å²æ¶ˆæ¯
- **é•¿æŒ‰ä¼šè¯**ï¼šæ˜¾ç¤ºåˆ é™¤ã€é‡å‘½åç­‰é€‰é¡¹
- **ä¸‹æ‹‰åˆ·æ–°**ï¼šé‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
- **ç½®é¡¶åŠŸèƒ½**ï¼šå¸¸ç”¨ä¼šè¯ç½®é¡¶æ˜¾ç¤º

## ğŸ” æƒé™æ§åˆ¶

1. **ç”¨æˆ·éš”ç¦»**ï¼šåªèƒ½æŸ¥çœ‹å’Œæ“ä½œè‡ªå·±çš„ä¼šè¯
2. **èº«ä»½éªŒè¯**ï¼šé€šè¿‡JWTéªŒè¯ç”¨æˆ·èº«ä»½
3. **æ•°æ®å®‰å…¨**ï¼šè½¯åˆ é™¤ä¿éšœæ•°æ®å¯æ¢å¤

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [AIèŠå¤©åŠŸèƒ½æ¨¡å—](file:///C:/Users/35666/.gemini/antigravity/brain/774ebe23-99e1-46d9-a3e1-52263e77b58e/AIèŠå¤©åŠŸèƒ½æ¨¡å—.md)
- [ç”¨æˆ·ç®¡ç†æ¨¡å—](file:///C:/Users/35666/.gemini/antigravity/brain/774ebe23-99e1-46d9-a3e1-52263e77b58e/ç”¨æˆ·ç®¡ç†æ¨¡å—.md)
