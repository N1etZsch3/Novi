## ğŸš€ NoviÂ·æŒšå‹ï¼šé¡¹ç›®ç»“æ„ç›®å½•



è¿™æ˜¯ä¸€ä¸ªåŸºäº **Spring Boot** çš„æ ‡å‡†Maven/Gradleé¡¹ç›®ç»“æ„ã€‚è¿™ç§ç»“æ„éµå¾ªâ€œå…³æ³¨ç‚¹åˆ†ç¦»â€ (Separation of Concerns) çš„åŸåˆ™ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

```shell
Novi/
â”œâ”€â”€ novi-common/            # å…¬å…±æ¨¡å— (Utils, DTOs, Exceptions)
â”œâ”€â”€ novi-user/              # ç”¨æˆ·æ¨¡å— (User Service & Mapper)
â”œâ”€â”€ novi-ai-config/         # AIé…ç½®æ¨¡å— (Model & Prompt Config)
â”œâ”€â”€ novi-chat/              # èŠå¤©æ ¸å¿ƒæ¨¡å— (Chat Service & Memory)
â”œâ”€â”€ novi-question/          # å‡ºé¢˜æ¨¡å— (Question Generation)
â”œâ”€â”€ novi-view/              # å‰ç«¯è§†å›¾æ¨¡å— (Static Resources)
â”œâ”€â”€ novi-web/               # Webå¯åŠ¨æ¨¡å— (Controllers & Application)
â””â”€â”€ pom.xml                 # çˆ¶å·¥ç¨‹ Maven é…ç½®
```



------



## ğŸ§  æ•´ä½“è®¾è®¡æ€è·¯ä¸æ ¸å¿ƒæµç¨‹



"NoviÂ·æŒšå‹"çš„æ ¸å¿ƒä»·å€¼åœ¨äº**ä¸ªæ€§åŒ–**å’Œ**è®°å¿†**ã€‚æˆ‘ä»¬çš„è®¾è®¡å¿…é¡»å›´ç»•æ•°æ®æµå¦‚ä½•å¢å¼ºè¿™ä¸¤ä¸ªç‚¹æ¥å±•å¼€ã€‚



### 1. æ ¸å¿ƒæ¨¡å—è¯¦è§£



1. **é…ç½®å±‚ (Config)**:
   - `AiConfig`: Spring AI çš„è‡ªåŠ¨é…ç½®ï¼Œé€šè¿‡ `application.properties` åŠ è½½ API Keyã€‚
2. **æ¥å£å±‚ (Controller)**:
   - `ChatController`: æ¥æ”¶ `ChatRequest`ï¼Œè°ƒç”¨ `ChatService`ã€‚
3. **æ•°æ®è®¿é—®å±‚ (Mapper/Repository)**:
   - ä½¿ç”¨ **MyBatis** è¿›è¡Œæ•°æ®åº“æ“ä½œ (`UserAccountMapper`, `ChatSessionMapper`)ã€‚
   - `NoviDatabaseChatMemory`: å®ç° Spring AI çš„ `ChatMemory` æ¥å£ï¼Œè´Ÿè´£å°†èŠå¤©è®°å½•æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚
4. **é¢†åŸŸæ¨¡å‹ (Pojo)**:
   - **Entity**: `UserAccount`, `ChatSession`, `ChatMessage`.
   - **DTO**: `ChatRequest`, `ChatResponse`, `NoviPersonaSettings`.
5. **AIå®¢æˆ·ç«¯ (Spring AI)**:
   - ç›´æ¥ä½¿ç”¨ Spring AI æä¾›çš„ `ChatClient`ï¼Œæ— éœ€æ‰‹åŠ¨å°è£… Adapterã€‚
   - æ”¯æŒæµå¼ (Stream) å’Œé˜»å¡å¼ (Call) è°ƒç”¨ã€‚
6. **æç¤ºè¯æœåŠ¡ (AiPromptConfigService)**:
   - è´Ÿè´£ç®¡ç†ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿ã€æ€§æ ¼æè¿°å’Œè¯­æ°”é£æ ¼ã€‚
   - æ”¯æŒä»æ•°æ®åº“åŠ¨æ€åŠ è½½é…ç½®ã€‚
7. **è®°å¿†æœåŠ¡ (MemoryService)**:
   - **å½“å‰å®ç°**: ä¸»è¦ä¾èµ– `NoviDatabaseChatMemory` è¿›è¡Œä¸Šä¸‹æ–‡ï¼ˆWindow Memoryï¼‰ç®¡ç†ã€‚
   - **æœªæ¥è®¡åˆ’**: å®ç°åŸºäºå‘é‡æ•°æ®åº“çš„é•¿æœŸè®°å¿†æ£€ç´¢å’Œäº‹å®æå–ã€‚



### 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼šä¸€æ¬¡èŠå¤© (Chat Flow)



è¿™æ˜¯ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯çš„å®Œæ•´åç«¯å¤„ç†æµç¨‹ï¼š

**[ç”¨æˆ·] -> [API] -> [Controller] -> [Service] -> [AI] -> [Service] -> [Controller] -> [API] -> [ç”¨æˆ·]**



#### æ­¥éª¤ 1ï¼šè¯·æ±‚è¿›å…¥ (ChatController)

1. ç”¨æˆ·å‘é€ `POST /api/chat/stream` (æˆ– `/call`)ã€‚
2. `ChatController` è°ƒç”¨ `chatService.handleStreamMessage(request)`ã€‚

#### æ­¥éª¤ 2ï¼šç³»ç»Ÿæ¶ˆæ¯æ„å»º (ChatService)

1. **è·å–ç”¨æˆ·ä¸åå¥½**: æŸ¥è¯¢ `UserAccount` å’Œ `UserPreferenceService`ã€‚
2. **æ„å»ºäººè®¾**: æ ¹æ®åå¥½è®¾ç½®ï¼ˆå¦‚ "æ¯’èˆŒ"ã€"æ¸©æŸ”"ï¼‰å’Œ `AiPromptConfigService` ä¸­çš„æ¨¡æ¿ï¼Œç”Ÿæˆ System Promptã€‚
3. **æ³¨å…¥ç¯å¢ƒä¿¡æ¯**: æ³¨å…¥å½“å‰æ—¶é—´ã€æ—¥æœŸã€å­£èŠ‚æš—ç¤ºç­‰ï¼Œå¢å¼º AI çš„çœŸå®æ„Ÿã€‚

#### æ­¥éª¤ 3ï¼šä¼šè¯ç®¡ç† (ChatService)

1. æ£€æŸ¥ `sessionId`ã€‚å¦‚æœæ˜¯æ–°ä¼šè¯ï¼Œåˆ›å»º `ChatSession` å¹¶è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜ï¼ˆæˆªå–å‰20å­—ï¼‰ã€‚
2. å¦‚æœæ˜¯æ—§ä¼šè¯ï¼Œæ›´æ–°æœ€åæ´»è·ƒæ—¶é—´ã€‚

#### æ­¥éª¤ 4ï¼šè°ƒç”¨ AI (Spring AI ChatClient)

1. `ChatService` æ„å»º `Prompt`ï¼ŒåŒ…å« System Message å’Œ User Messageã€‚
2. **æ³¨å…¥è®°å¿†**: ä½¿ç”¨ `NoviDatabaseChatMemory`ï¼ŒSpring AI ä¼šè‡ªåŠ¨å°†ä¹‹å‰çš„å¯¹è¯å†å²ï¼ˆä½œä¸º Advisorï¼‰é™„åŠ åˆ° Prompt ä¸­ã€‚
3. è°ƒç”¨ `chatClient.prompt().stream()` å‘èµ·è¯·æ±‚ã€‚

#### æ­¥éª¤ 5ï¼šæµå¼å“åº”ä¸æŒä¹…åŒ–

1. AI è¿”å›æµå¼æ•°æ® (`Flux<String>`)ã€‚
2. `ChatService` å°†å†…å®¹åŒ…è£…ä¸º `StreamEvent` å¹¶åºåˆ—åŒ–ä¸º JSON è¿”å›ç»™å‰ç«¯ã€‚
3. **è‡ªåŠ¨æŒä¹…åŒ–**: `NoviDatabaseChatMemory` ä¼šæ‹¦æˆªå¯¹è¯ç»“æŸä¿¡å·ï¼Œå°† User Message å’Œ Assistant Response ä¿å­˜åˆ° `chat_message` è¡¨ä¸­ã€‚

#### æ­¥éª¤ 6ï¼šã€TODOã€‘è®°å¿†æå– (MemoryService)

> âš ï¸ æ­¤åŠŸèƒ½å°šæœªå®è£…ï¼Œè®¡åˆ’åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æ·»åŠ ã€‚

1. å¼‚æ­¥åˆ†æå¯¹è¯å†…å®¹ã€‚
2. æå–å…³é”®äº‹å®ï¼ˆå¦‚ç”¨æˆ·å–œå¥½ã€é‡è¦æ—¥æœŸï¼‰ã€‚
3. å­˜å…¥ `user_memory` è¡¨ä¾›ä¸‹æ¬¡æ£€ç´¢ã€‚



### 3. æ•°æ®åº“è®¾è®¡ (Model/Entity)



- **User**: `id`, `username`, `email`, `nickname` (æ˜µç§°), `preferences` (JSON/Stringï¼Œå­˜å‚¨ç”¨æˆ·åå¥½ï¼Œæ¯”å¦‚Noviçš„æ€§æ ¼)ã€‚
- **ChatMessage**: `id`, `userId` (å…³è”User), `role` ("user" æˆ– "assistant"), `content` (æ¶ˆæ¯å†…å®¹), `timestamp`ã€‚
- **Memory**: `id`, `userId` (å…³è”User), `fact` (äº‹å®ï¼Œä¾‹å¦‚ "ç”¨æˆ·çš„ç”Ÿæ—¥æ˜¯10æœˆ1æ—¥"), `type` (ç±»å‹ï¼Œä¾‹å¦‚ "Birthday", "Family", "Pet"), `lastAccessTime` (ç”¨äºLRUç¼“å­˜æˆ–æ£€ç´¢)ã€‚

