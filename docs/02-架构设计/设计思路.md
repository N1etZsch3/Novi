## 🚀 Novi·挚友：项目结构目录

这是一个基于 **Spring Boot** 的多模块 Maven 项目结构。这种结构遵循“关注点分离” (Separation of Concerns) 的原则，易于维护和扩展。

```shell
Novi/
├── .mvn/                   # Maven Wrapper
├── .gitignore              # Git忽略配置
├── pom.xml                 # 父工程 Maven 配置
│
├── novi-common/            # [公共模块] 工具类、通用配置、异常处理
├── novi-user/              # [用户模块] 用户管理、认证
├── novi-chat/              # [聊天模块] 核心聊天业务、会话管理
├── novi-question/          # [出题模块] AI出题功能
├── novi-ai-config/         # [配置模块] AI模型与Prompt配置
└── novi-web/               # [Web模块] 启动入口、API聚合
    ├── src/main/java/com/n1etzsch3/novi/
    │   └── NoviApplication.java    # Spring Boot 启动类
    └── src/main/resources/
        └── application.yml         # 统一配置文件
```

------

## 🧠 整体设计思路与核心流程

"Novi·挚友"的核心价值在于**个性化**和**记忆**。我们的设计必须围绕数据流如何增强这两个点来展开。

### 1. 核心模块详解

1. **公共模块 (novi-common)**:
   - 包含全局异常处理 (`GlobalExceptionHandler`)、统一响应封装 (`Result`)、JWT工具等。
   
2. **AI配置模块 (novi-ai-config)**:
   - **核心职责**: 管理 AI 模型和 Prompt。
   - `DynamicChatModelFactory`: 支持热切换 AI 模型，无需重启。
   - `AiPromptConfigService`: 管理系统提示词模板，支持不同场景（聊天/出题）的 Prompt 切换。

3. **聊天模块 (novi-chat)**:
   - **核心职责**: 处理对话交互。
   - `ChatService`: 编排聊天流程，集成记忆和 Prompt。
   - `NoviDatabaseChatMemory`: 实现 Spring AI 的 `ChatMemory`，持久化聊天记录。

4. **出题模块 (novi-question)**:
   - **核心职责**: AI 智能出题。
   - `QuestionGenerationService`: 根据用户需求组装 Prompt，调用 AI 生成题目并解析 JSON 结果。

5. **用户模块 (novi-user)**:
   - **核心职责**: 用户账户与偏好管理。

### 2. 核心业务流程

#### 流程 A：智能聊天 (Chat Flow)

**[用户] -> [API] -> [ChatController] -> [ChatService] -> [AI] -> [ChatService] -> [用户]**

1. **请求进入**: 用户发送消息。
2. **上下文构建**: 
   - 识别当前场景（普通聊天）。
   - 从 `novi-ai-config` 获取对应的 System Prompt（包含人设、语气）。
   - 从 `NoviDatabaseChatMemory` 加载历史对话作为短期记忆。
3. **AI 调用**: 通过 `DynamicChatModelFactory` 获取当前激活的 `ChatClient` 发起请求。
4. **响应处理**: 支持流式 (SSE) 或阻塞式响应，并自动保存记录。

#### 流程 B：AI 出题 (Question Generation Flow)

**[用户] -> [API] -> [QuestionController] -> [QuestionGenerationService] -> [AI] -> [Database] -> [用户]**

1. **请求进入**: 用户提交出题配置（科目、题型、难度）。
2. **Prompt 组装**: 
   - 获取 "出题模式" 的 System Prompt。
   - 动态拼接出题要求，强制要求 AI 返回 JSON 格式。
3. **AI 调用**: 调用 AI 模型生成内容。
4. **结果解析**: 将 AI 返回的 JSON 字符串解析为结构化数据。
5. **持久化**: 保存出题记录到数据库。

### 3. 数据层设计

- **UserAccount**: 用户基础信息。
- **ChatSession**: 会话元数据。
- **ChatMessage**: 聊天记录（短期记忆）。
- **AiModelConfig**: AI 模型配置（支持热更新）。
- **QuestionGenerationRecord**: 出题历史记录。

### 4. 未来规划

- **长期记忆 (Long-term Memory)**: 基于向量数据库 (Vector DB) 实现 RAG (检索增强生成)，让 AI 记住用户的长期偏好和关键事实。
