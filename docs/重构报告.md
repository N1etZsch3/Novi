# MyBatis-Plus 重构报告

## 1. 概述 (Overview)
本项目已成功从原生 MyBatis + JPA 混合模式迁移至 **MyBatis-Plus**。此次重构旨在简化数据访问层代码，移除冗余的 XML 配置，并统一持久层框架。

## 2. 依赖变更 (Dependency Updates)
- **新增依赖**:
    - `mybatis-plus-boot-starter` (版本: **3.5.7**)：MyBatis-Plus 核心启动器。
    - `mybatis-spring` (版本: **3.0.4**)：解决与 Spring Boot 3.5.7 的兼容性问题。
- **移除依赖**:
    - `spring-boot-starter-data-jpa`：不再需要 JPA 进行实体管理。

## 3. 实体类重构 (Entity Refactoring)
所有实体类 (`UserAccount`, `ChatSession`, `ChatMessage`, `AiPromptConfig`, `UserMemory`) 均已更新：

- **移除 JPA 注解**:
    - 删除 `@Entity`, `@Table(name=...)`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToOne`, `@JoinColumn` 等。
- **添加 MyBatis-Plus 注解**:
    - **`@TableName("表名")`**: 指定数据库表名。
    - **`@TableId(type = IdType.AUTO)`**: 指定主键及自增策略。
    - **`@TableField`**:
        - 用于非主键字段（通常不需要，MyBatis-Plus 会自动映射）。
        - **`@TableField(exist = false)`**: 标记数据库中不存在的字段（如关联对象 `UserAccount user`），防止插入时报错。

## 4. Mapper 层重构 (Mapper Layer)
- **接口升级**:
    - 所有 Mapper 接口 (`UserAccountMapper`, `ChatSessionMapper` 等) 现在继承 **`BaseMapper<T>`**。
    - 获得了开箱即用的 CRUD 方法：`insert`, `deleteById`, `updateById`, `selectById`, `selectList` 等。
- **移除 XML**:
    - 删除了所有 `src/main/resources/mapper/*.xml` 文件。
    - 自定义查询（如 `findSessionIdsByUserId`）改用注解方式 (`@Select`) 或 MyBatis-Plus 的 `QueryWrapper`。

## 5. Service & Repository 层调整
- **Service 实现**:
    - 更新了所有 Service (`ChatServiceImpl`, `UserAccountServiceImpl` 等) 以调用 `BaseMapper` 的方法。
    - 移除了手动编写的 SQL 调用代码。
- **ChatMemory 实现**:
    - **`NoviDatabaseChatMemory`**:
        - 重构了 `add` 方法，使用 `chatMemoryMapper.insert(entity)`。
        - **关键修复**: 在插入 `ChatMessage` 时，显式设置 `userId` 字段 (`.userId(userId)`)，因为 MyBatis-Plus 会忽略被标记为 `@TableField(exist = false)` 的 `UserAccount` 对象，导致此前出现 "Field 'user_id' doesn't have a default value" 错误。

## 6. 遇到的问题与解决方案 (Troubleshooting)
1.  **BeanDefinitionStoreException**:
    - **原因**: MyBatis-Plus 3.5.5 与 Spring Boot 3.5.7 存在兼容性问题。
    - **解决**: 升级 MyBatis-Plus 至 **3.5.7** 并指定 `mybatis-spring` 版本。
2.  **运行时 SQL 错误**:
    - **原因**: 插入消息时 `user_id` 为空。
    - **解决**: 修改 `NoviDatabaseChatMemory`，在构建实体时手动注入 `userId`。

## 7. 总结
重构后，项目结构更加清晰，去除了大量样板代码（XML），并修复了潜在的依赖冲突。应用现已成功启动并能正常处理聊天请求。
