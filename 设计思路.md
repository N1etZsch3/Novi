## ğŸš€ NoviÂ·æŒšå‹ï¼šé¡¹ç›®ç»“æ„ç›®å½•



è¿™æ˜¯ä¸€ä¸ªåŸºäº **Spring Boot** çš„æ ‡å‡†Maven/Gradleé¡¹ç›®ç»“æ„ã€‚è¿™ç§ç»“æ„éµå¾ªâ€œå…³æ³¨ç‚¹åˆ†ç¦»â€ (Separation of Concerns) çš„åŸåˆ™ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

Plaintext

```
novi-zhiyou/
â”œâ”€â”€ .mvn/                   # Maven Wrapper
â”œâ”€â”€ .gitignore              # Gitå¿½ç•¥é…ç½®
â”œâ”€â”€ mvnw                    # Maven Wrapper (Linux/macOS)
â”œâ”€â”€ mvnw.cmd                # Maven Wrapper (Windows)
â”œâ”€â”€ pom.xml                 # Mavené¡¹ç›®é…ç½® (ä¾èµ–ç®¡ç†)
â”‚
â””â”€â”€ src/
    â”œâ”€â”€ main/
    â”‚   â”œâ”€â”€ java/
    â”‚   â”‚   â””â”€â”€ com/novi/zhiyou/    # ä½ çš„Javaä»£ç æ ¹åŒ…
    â”‚   â”‚       â”œâ”€â”€ NoviZhiyouApplication.java  # Spring Boot å¯åŠ¨ç±»
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ config/         # 1. é…ç½®å±‚
    â”‚   â”‚       â”‚   â”œâ”€â”€ SecurityConfig.java     # (å¯é€‰) Spring Securityå®‰å…¨é…ç½®
    â”‚   â”‚       â”‚   â”œâ”€â”€ WebConfig.java          # (å¯é€‰) Webç›¸å…³é…ç½® (å¦‚CORSè·¨åŸŸ)
    â”‚   â”‚       â”‚   â”œâ”€â”€ AppConfig.java          # åº”ç”¨é…ç½® (å¦‚Beanæ³¨å†Œ)
    â”‚   â”‚       â”‚   â””â”€â”€ AiApiConfig.java        # å°è£…AIå‚å•†çš„API Keyå’ŒEndpoint
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ controller/     # 2. æ¥å£å±‚ (Web API)
    â”‚   â”‚       â”‚   â”œâ”€â”€ ChatController.java     # æ ¸å¿ƒèŠå¤©API (/api/chat)
    â”‚   â”‚       â”‚   â”œâ”€â”€ UserController.java     # ç”¨æˆ·ä¿¡æ¯ç®¡ç†API (/api/user)
    â”‚   â”‚       â”‚   â””â”€â”€ MemoryController.java   # (å¯é€‰) è®°å¿†ç®¡ç†API (/api/memory)
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ service/        # 3. æœåŠ¡å±‚ (æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)
    â”‚   â”‚       â”‚   â”œâ”€â”€ ChatService.java        # èŠå¤©æµç¨‹ç¼–æ’
    â”‚   â”‚       â”‚   â”œâ”€â”€ UserService.java        # ç”¨æˆ·ç®¡ç†
    â”‚   â”‚       â”‚   â”œâ”€â”€ MemoryService.java      # è®°å¿†æå–ã€å­˜å‚¨å’Œæ£€ç´¢
    â”‚   â”‚       â”‚   â”œâ”€â”€ PromptService.java      # æç¤ºè¯å·¥ç¨‹ (æœ¬åœ°å°è£…)
    â”‚   â”‚       â”‚   â””â”€â”€ impl/                   # æœåŠ¡å®ç°ç±»
    â”‚   â”‚       â”‚       â”œâ”€â”€ ChatServiceImpl.java
    â”‚   â”‚       â”‚       â””â”€â”€ ...
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ repository/     # 4. æ•°æ®è®¿é—®å±‚
    â”‚   â”‚       â”‚   â”œâ”€â”€ UserRepository.java     # ç”¨æˆ·è¡¨DAO (JPA Repository)
    â”‚   â”‚       â”‚   â”œâ”€â”€ ChatHistoryRepository.java # èŠå¤©è®°å½•è¡¨DAO
    â”‚   â”‚       â”‚   â””â”€â”€ UserMemoryRepository.java   # ç”¨æˆ·è®°å¿†è¡¨DAO
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ model/          # 5. é¢†åŸŸæ¨¡å‹ (æ•°æ®åº“å®ä½“)
    â”‚   â”‚       â”‚   â”œâ”€â”€ entity/                 # æ•°æ®åº“å®ä½“ (Entity)
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ User.java           # ç”¨æˆ·ä¿¡æ¯ (id, name, preferences)
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ ChatMessage.java    # èŠå¤©è®°å½• (id, userId, role, content)
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ Memory.java         # æ ¸å¿ƒè®°å¿† (id, userId, fact, type)
    â”‚   â”‚       â”‚   â””â”€â”€ dto/                    # æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)
    â”‚   â”‚       â”‚       â”œâ”€â”€ ChatRequest.java    # èŠå¤©è¯·æ±‚ä½“
    â”‚   â”‚       â”‚       â”œâ”€â”€ ChatResponse.java   # èŠå¤©å“åº”ä½“
    â”‚   â”‚       â”‚       â”œâ”€â”€ UserProfileDto.java # ç”¨æˆ·èµ„æ–™DTO
    â”‚   â”‚       â”‚
    â”‚   â”‚       â”œâ”€â”€ client/         # 6. å¤–éƒ¨AI APIå®¢æˆ·ç«¯
    â”‚   â”‚       â”‚   â”œâ”€â”€ AiApiClient.java        # ç»Ÿä¸€çš„AIå®¢æˆ·ç«¯æ¥å£ (é€‚é…å™¨æ¨¡å¼)
    â”‚   â”‚       â”‚   â”œâ”€â”€ impl/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ OpenAiClient.java   # OpenAI API å®ç°
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ ClaudeClient.java   # Anthropic Claude API å®ç°
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ ...                 # å…¶ä»–å‚å•†å®ç°
    â”‚   â”‚       â”‚
    â”‚   â”‚       â””â”€â”€ exception/      # 7. å¼‚å¸¸å¤„ç†
    â”‚   â”‚           â”œâ”€â”€ GlobalExceptionHandler.java # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
    â”‚   â”‚           â””â”€â”€ ResourceNotFoundException.java # è‡ªå®šä¹‰å¼‚å¸¸
    â”‚   â”‚
    â”‚   â””â”€â”€ resources/
    â”‚       â”œâ”€â”€ application.properties  # Spring Boot é…ç½®æ–‡ä»¶ (æˆ– application.yml)
    â”‚       â”œâ”€â”€ banner.txt              # (å¯é€‰) Spring Boot å¯åŠ¨æ¨ªå¹…
    â”‚       â”‚
    â”‚       â””â”€â”€ prompts/                # 8. æœ¬åœ°æç¤ºè¯æ¨¡æ¿
    â”‚           â”œâ”€â”€ system_prompt_base.txt     # åŸºç¡€ç³»ç»Ÿæç¤ºè¯ (Noviçš„åŸºå‡†äººè®¾)
    â”‚           â”œâ”€â”€ memory_retrieval_prompt.txt # è®°å¿†æ£€ç´¢æç¤ºè¯
    â”‚           â”œâ”€â”€ memory_extraction_prompt.txt # è®°å¿†æå–æç¤ºè¯
    â”‚           â””â”€â”€ ...
    â”‚
    â””â”€â”€ test/                   # æµ‹è¯•ä»£ç 
        â””â”€â”€ java/
            â””â”€â”€ com/novi/zhiyou/
                â”œâ”€â”€ service/
                â”‚   â””â”€â”€ ChatServiceTest.java
                â””â”€â”€ ...
```

------



## ğŸ§  æ•´ä½“è®¾è®¡æ€è·¯ä¸æ ¸å¿ƒæµç¨‹



"NoviÂ·æŒšå‹"çš„æ ¸å¿ƒä»·å€¼åœ¨äº**ä¸ªæ€§åŒ–**å’Œ**è®°å¿†**ã€‚æˆ‘ä»¬çš„è®¾è®¡å¿…é¡»å›´ç»•æ•°æ®æµå¦‚ä½•å¢å¼ºè¿™ä¸¤ä¸ªç‚¹æ¥å±•å¼€ã€‚



### 1. æ ¸å¿ƒæ¨¡å—è¯¦è§£



1. **é…ç½®å±‚ (Config)**:
   - `AiApiConfig`: ä½¿ç”¨ `@ConfigurationProperties` æ¥å®‰å…¨åœ°ä» `application.properties` åŠ è½½ä¸åŒAIå‚å•†çš„APIå¯†é’¥ã€åŸºç¡€URLç­‰ã€‚è¿™å…è®¸ä½ åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹åˆ‡æ¢æˆ–æ·»åŠ AIæœåŠ¡å•†ã€‚
2. **æ¥å£å±‚ (Controller)**:
   - `ChatController`: å…³é”®å…¥å£ã€‚å®ƒæ¥æ”¶å‰ç«¯ï¼ˆå¦‚Webæˆ–Appï¼‰å‘æ¥çš„ `ChatRequest`ï¼ˆåŒ…å« `userId` å’Œ `message`ï¼‰ã€‚å®ƒä¸å¤„ç†ä»»ä½•é€»è¾‘ï¼Œåªè´Ÿè´£è°ƒç”¨ `ChatService` å¹¶è¿”å›ç»“æœã€‚
3. **æ•°æ®è®¿é—®å±‚ (Repository)**:
   - ä½¿ç”¨ **Spring Data JPA**ã€‚ä½ åªéœ€è¦å®šä¹‰æ¥å£ï¼ˆå¦‚ `UserRepository extends JpaRepository<User, Long>`ï¼‰ï¼ŒJPAä¼šè‡ªåŠ¨ä¸ºä½ å®ç°SQLæ“ä½œã€‚
   - `UserMemoryRepository`: å…³é”®ï¼ç”¨äºå­˜å‚¨ä»å¯¹è¯ä¸­æå–çš„**ç»“æ„åŒ–è®°å¿†**ï¼ˆä¾‹å¦‚ï¼š`Memory(userId=1, fact="ç”¨æˆ·çš„ç‹—å«'æ—ºè´¢'", type="Pet")`ï¼‰ã€‚
4. **é¢†åŸŸæ¨¡å‹ (Model)**:
   - **Entity**: `User` (ç”¨æˆ·ä¿¡æ¯)ã€`ChatMessage` (èŠå¤©å†å²)ã€`Memory` (è®°å¿†)ã€‚
   - **DTO**: ä¸¥æ ¼åŒºåˆ† `Entity` å’Œ `DTO`ã€‚`Entity` ç”¨äºæ•°æ®åº“ï¼Œ`DTO` ç”¨äºAPIã€‚`ChatRequest` æ˜¯ä¸€ä¸ªDTOï¼Œå®ƒæ°¸è¿œä¸ä¼šç›´æ¥è¿›å…¥æ•°æ®åº“ã€‚
5. **AIå®¢æˆ·ç«¯ (Client)**:
   - **é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)**ï¼šå®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ `AiApiClient` æ¥å£ï¼Œæ¯”å¦‚ `String generateResponse(List<ChatMessage> messages)`ã€‚
   - ç„¶åä¸ºæ¯ä¸ªAIå‚å•†åˆ›å»ºå®ç°ç±»ï¼ˆ`OpenAiClient`, `ClaudeClient`ï¼‰ã€‚
   - `ChatService` åªä¾èµ– `AiApiClient` æ¥å£ï¼Œä¸å…³å¿ƒå…·ä½“æ˜¯å“ªä¸ªå‚å•†ã€‚ä½ å¯ä»¥é€šè¿‡é…ç½®ï¼ˆ`@Profile` æˆ– `@ConditionalOnProperty`ï¼‰æ¥åŠ¨æ€é€‰æ‹©ä½¿ç”¨å“ªä¸ªAIã€‚
6. **æç¤ºè¯æœåŠ¡ (PromptService)**:
   - **æ ¸å¿ƒæ¨¡å—**ã€‚å®ƒè´Ÿè´£**åŠ¨æ€æ„å»º**æœ€ç»ˆå‘é€ç»™AIçš„æç¤ºè¯ã€‚
   - å®ƒä» `src/main/resources/prompts/` ç›®å½•åŠ è½½æ¨¡æ¿æ–‡ä»¶ã€‚
   - å®ƒä¼šæ¥æ”¶ç”¨æˆ·ã€è®°å¿†ã€èŠå¤©å†å²ï¼Œç„¶åå°†å®ƒä»¬"ç»„è£…"æˆä¸€ä¸ªå®Œæ•´çš„Promptã€‚
7. **è®°å¿†æœåŠ¡ (MemoryService)**:
   - **è®°å¿†æ£€ç´¢**: å½“ç”¨æˆ·å¼€å§‹å¯¹è¯æ—¶ï¼Œ`ChatService` ä¼šè°ƒç”¨ `memoryService.retrieveRelevantMemories(userId, userMessage)`ã€‚æ­¤æœåŠ¡ä¼šä» `UserMemoryRepository` æ£€ç´¢ç›¸å…³çš„è®°å¿†ï¼ˆå¯ä»¥ä½¿ç”¨ç®€å•çš„å…³é”®è¯åŒ¹é…ï¼Œæˆ–æ›´é«˜çº§çš„å‘é‡æ£€ç´¢ï¼‰ã€‚
   - **è®°å¿†æå–**: åœ¨å¯¹è¯**ä¹‹å**ï¼Œ`ChatService` ä¼š*å¼‚æ­¥*è°ƒç”¨ `memoryService.extractAndSaveMemories(conversation)`ã€‚



### 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼šä¸€æ¬¡èŠå¤© (Chat Flow)



è¿™æ˜¯ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯çš„å®Œæ•´åç«¯å¤„ç†æµç¨‹ï¼š

**[ç”¨æˆ·] -> [API] -> [Controller] -> [Service] -> [AI] -> [Service] -> [Controller] -> [API] -> [ç”¨æˆ·]**



#### æ­¥éª¤ 1ï¼šè¯·æ±‚è¿›å…¥ (ChatController)



1. ç”¨æˆ·ï¼ˆé€šè¿‡å‰ç«¯ï¼‰å‘é€ `POST /api/chat`ï¼Œè¯·æ±‚ä½“ä¸º `ChatRequest(userId="user123", message="ä»Šå¤©æˆ‘å®¶çš„æ—ºè´¢ç”Ÿç—…äº†")`ã€‚
2. `ChatController` æ•è·è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ `chatService.handleMessage(request)`ã€‚



#### æ­¥éª¤ 2ï¼šèŠå¤©ç¼–æ’ (ChatService) - *æ ¸å¿ƒ*



`ChatService` æ˜¯æ€»æŒ‡æŒ¥ã€‚

1. **ä¿å­˜å½“å‰æ¶ˆæ¯**: `chatHistoryRepo.save(new ChatMessage("user123", "user", "ä»Šå¤©æˆ‘å®¶çš„æ—ºè´¢ç”Ÿç—…äº†"))`ã€‚
2. **è·å–ä¸Šä¸‹æ–‡**:
   - è°ƒç”¨ `userService.getUserById("user123")` è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·çš„æ˜µç§°ï¼‰ã€‚
   - è°ƒç”¨ `chatHistoryRepo.findRecentMessages("user123", 10)` è·å–æœ€è¿‘çš„10æ¡å¯¹è¯å†å²ã€‚
   - è°ƒç”¨ `memoryService.retrieveRelevantMemories("user123", "ä»Šå¤©æˆ‘å®¶çš„æ—ºè´¢ç”Ÿç—…äº†")`ã€‚`MemoryService` å¯èƒ½ä¼šåœ¨ `Memory` è¡¨ä¸­æ‰¾åˆ°ä¸€æ¡è®°å½•ï¼š`fact="ç”¨æˆ·çš„ç‹—å«'æ—ºè´¢'"`ã€‚



#### æ­¥éª¤ 3ï¼šæç¤ºè¯å°è£… (PromptService)



ChatService è°ƒç”¨ promptService.buildPrompt(...)ï¼Œä¼ å…¥ä¸Šä¸€æ­¥è·å–çš„æ‰€æœ‰ä¿¡æ¯ã€‚

PromptService å¼€å§‹å·¥ä½œï¼š

1. åŠ è½½ `system_prompt_base.txt` (ä¾‹å¦‚ï¼š"ä½ æ˜¯Noviï¼Œä¸€ä¸ªå…³å¿ƒæœ‹å‹çš„ä¼™ä¼´...")ã€‚
2. **æ³¨å…¥è®°å¿†**: "è¿™æ˜¯ä½ å’Œç”¨æˆ·[æ˜µç§°]çš„è®°å¿†ï¼š\n- ç”¨æˆ·çš„ç‹—å«'æ—ºè´¢'ã€‚"
3. **æ³¨å…¥å†å²**: é™„ä¸Šæœ€è¿‘çš„10æ¡èŠå¤©è®°å½•ã€‚
4. **æ³¨å…¥æ–°æ¶ˆæ¯**: "User: ä»Šå¤©æˆ‘å®¶çš„æ—ºè´¢ç”Ÿç—…äº†ã€‚"
5. **ç»„åˆ**ï¼šç”Ÿæˆä¸€ä¸ªè¶…é•¿çš„ã€åŒ…å«æ‰€æœ‰ä¸Šä¸‹æ–‡çš„**æœ€ç»ˆæç¤ºè¯ (Final Prompt)**ã€‚



#### æ­¥éª¤ 4ï¼šè°ƒç”¨AI (AiApiClient)



1. `ChatService` è°ƒç”¨ `aiApiClient.generateResponse(finalPrompt)`ã€‚
2. `AiApiClient`ï¼ˆä¾‹å¦‚ `OpenAiClient`ï¼‰ä½¿ç”¨ `RestTemplate` æˆ– `WebClient` å‘AIå‚å•†çš„APIï¼ˆå¦‚OpenAIï¼‰å‘èµ·HTTPè¯·æ±‚ã€‚
3. AIå‚å•†è¿”å›å“åº” (ä¾‹å¦‚ï¼š"å•Šï¼æ—ºè´¢æ€ä¹ˆäº†ï¼Ÿä½ ä¸€å®šå¾ˆæ‹…å¿ƒå§ï¼Ÿ")ã€‚



#### æ­¥éª¤ 5ï¼šå“åº”å¤„ç† (ChatService)



1. `ChatService` æ”¶åˆ°AIçš„å“åº”å­—ç¬¦ä¸²ã€‚
2. **ä¿å­˜AIå“åº”**: `chatHistoryRepo.save(new ChatMessage("user123", "assistant", "å•Šï¼æ—ºè´¢æ€ä¹ˆäº†ï¼Ÿ..."))`ã€‚
3. `ChatService` å°†AIçš„å“åº”åŒ…è£…æˆ `ChatResponse` DTO è¿”å›ç»™ `ChatController`ã€‚
4. `ChatController` å°†JSONå“åº”è¿”å›ç»™å‰ç«¯ã€‚



#### æ­¥éª¤ 6ï¼šã€å¼‚æ­¥ã€‘è®°å¿†æå– (MemoryService) - *å…³é”®*



ä¸ºäº†ä¸æ‹–æ…¢ç”¨æˆ·çš„å“åº”é€Ÿåº¦ï¼Œè¿™ä¸€æ­¥å¿…é¡»**å¼‚æ­¥**æ‰§è¡Œï¼ˆä½¿ç”¨ `@Async` æ³¨è§£ï¼‰ã€‚

1. `ChatService` åœ¨è¿”å›å“åº”åï¼Œå¼‚æ­¥è§¦å‘ `memoryService.extractAndSaveMemories("user123", [åˆšæ‰çš„å¯¹è¯])`ã€‚
2. `MemoryService` ä¼šè°ƒç”¨ `PromptService` åŠ è½½ `memory_extraction_prompt.txt` (ä¾‹å¦‚ï¼š"è¯·ä»ä»¥ä¸‹å¯¹è¯ä¸­æå–å…³äºç”¨æˆ·çš„æ–°äº‹å®ï¼Œä»¥JSONæ ¼å¼è¿”å›...")ã€‚
3. `MemoryService` **å†æ¬¡è°ƒç”¨ `aiApiClient`**ï¼Œä½†è¿™æ¬¡æ˜¯ä½¿ç”¨"è®°å¿†æå–æç¤ºè¯"ã€‚
4. AIå¯èƒ½è¿”å›ï¼š`{ "new_fact": "ç”¨æˆ·åœ¨[æ—¥æœŸ]æåˆ°äº†æ—ºè´¢ç”Ÿç—…" }`ã€‚
5. `MemoryService` è§£æè¿™ä¸ªJSONï¼Œå¹¶å°†å…¶å­˜å…¥ `UserMemoryRepository`ã€‚

**ä¸‹ä¸€æ¬¡**å½“ç”¨æˆ·æåˆ°"æ—ºè´¢"æ—¶ï¼Œ`MemoryService` å°±èƒ½æ£€ç´¢åˆ°"æ—ºè´¢æ˜¯ç”¨æˆ·çš„ç‹—"å’Œ"æ—ºè´¢ç”Ÿç—…äº†"è¿™ä¸¤æ¡è®°å¿†ï¼ŒNoviçš„å›å¤å°±ä¼šæ˜¾å¾—éå¸¸â€œæœ‰è®°æ€§â€ã€‚



### 3. æ•°æ®åº“è®¾è®¡ (Model/Entity)



- **User**: `id`, `username`, `email`, `nickname` (æ˜µç§°), `preferences` (JSON/Stringï¼Œå­˜å‚¨ç”¨æˆ·åå¥½ï¼Œæ¯”å¦‚Noviçš„æ€§æ ¼)ã€‚
- **ChatMessage**: `id`, `userId` (å…³è”User), `role` ("user" æˆ– "assistant"), `content` (æ¶ˆæ¯å†…å®¹), `timestamp`ã€‚
- **Memory**: `id`, `userId` (å…³è”User), `fact` (äº‹å®ï¼Œä¾‹å¦‚ "ç”¨æˆ·çš„ç”Ÿæ—¥æ˜¯10æœˆ1æ—¥"), `type` (ç±»å‹ï¼Œä¾‹å¦‚ "Birthday", "Family", "Pet"), `lastAccessTime` (ç”¨äºLRUç¼“å­˜æˆ–æ£€ç´¢)ã€‚

